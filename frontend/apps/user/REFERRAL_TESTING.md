# 推荐系统测试计划

## 测试目标

验证推荐系统的完整功能,包括:
- URL 参数检测和自动绑定
- 推荐链接生成和分享
- 推荐统计数据展示
- 返佣自动发放和历史记录
- 排行榜功能

---

## 测试环境准备

### 1. 启动本地测试链
```bash
cd contracts/
pkill anvil && sleep 2 && anvil --host 0.0.0.0 &
```

### 2. 部署合约
```bash
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
  forge script script/Deploy.s.sol:Deploy \
  --rpc-url http://localhost:8545 \
  --broadcast
```

### 3. 启动 Graph Node 和 Subgraph
```bash
cd ../subgraph/
./deploy.sh -c -u -y
```

### 4. 启动前端开发服务器
```bash
cd ../frontend/apps/user/
pnpm dev
```

---

## 测试用例

### TC1: URL 参数检测和自动绑定

**目标**: 验证 ReferralBinder 组件能正确检测 URL 参数并自动绑定推荐关系

**前置条件**:
- 使用测试账户 A (推荐人): `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266` (Anvil 账户 #0)
- 使用测试账户 B (被推荐人): `0x70997970C51812dc3A010C7d01b50e0d17dc79C8` (Anvil 账户 #1)

**测试步骤**:
1. 用账户 A 登录应用
2. 访问 `/referral` 页面
3. 复制推荐链接: `http://localhost:3000/?ref=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`
4. 退出登录
5. 用账户 B 访问推荐链接
6. 连接钱包

**预期结果**:
- ✅ 页面右上角显示 "绑定推荐人中..." 通知
- ✅ 钱包弹出交易确认
- ✅ 确认后显示 "绑定成功!" 通知
- ✅ URL 自动移除 `ref` 参数: `http://localhost:3000/`
- ✅ 链上查询 `ReferralRegistry.getReferrer(账户B)` 返回账户 A 地址

**测试数据记录**:
```
推荐人: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
被推荐人: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
绑定交易哈希: _______________
绑定时间戳: _______________
```

---

### TC2: 防止自己推荐自己

**目标**: 验证系统能阻止用户绑定自己为推荐人

**测试步骤**:
1. 用账户 A 登录
2. 访问 `http://localhost:3000/?ref=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266` (自己的地址)
3. 观察通知

**预期结果**:
- ✅ 显示错误通知: "不能绑定自己为推荐人"
- ✅ 不发起链上交易
- ✅ URL 参数被清理

---

### TC3: 防止重复绑定

**目标**: 验证已绑定推荐人的用户不能再次绑定

**测试步骤**:
1. 用已完成绑定的账户 B 登录
2. 访问其他推荐链接: `http://localhost:3000/?ref=0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC` (账户 #2)
3. 观察行为

**预期结果**:
- ✅ 不显示绑定通知
- ✅ URL 参数被自动清理
- ✅ 控制台输出: "[ReferralBinder] 用户已绑定推荐人"
- ✅ 链上推荐人仍然是账户 A

---

### TC4: 推荐链接生成和分享

**目标**: 验证推荐链接生成和复制功能

**测试步骤**:
1. 用账户 A 登录
2. 访问 `/referral` 页面
3. 查看推荐链接输入框
4. 点击 "复制" 按钮
5. 粘贴到其他地方验证

**预期结果**:
- ✅ 推荐链接格式正确: `http://localhost:3000/?ref=0xf39...`
- ✅ 点击复制后按钮文字变为 "已复制"
- ✅ 2秒后恢复为 "复制"
- ✅ 粘贴内容与显示的链接一致
- ✅ Twitter 和 Telegram 分享按钮可点击

---

### TC5: 下注触发返佣

**目标**: 验证被推荐人下注后,推荐人自动获得返佣

**前置条件**:
- 账户 B 已绑定账户 A 为推荐人
- 存在可下注的市场

**测试步骤**:
1. 用账户 B 登录
2. 访问任一市场页面
3. 下注 100 USDC,假设手续费为 2 USDC (2%)
4. 确认交易
5. 用账户 A 登录
6. 访问 `/referral` 或 `/referral/stats` 页面

**预期结果**:
- ✅ 账户 A 的 "累计返佣" 增加 0.16 USDC (2 * 8%)
- ✅ "推荐人数" 显示为 1
- ✅ "有效推荐" 显示为 1 (如果账户 B 下注量达到最小要求)
- ✅ "返佣记录" 列表中显示新记录:
  - 来自账户 B
  - 金额: +0.16 USDC
  - 时间戳正确
  - 交易哈希可查看

**测试数据记录**:
```
下注金额: 100 USDC
手续费: 2 USDC
返佣金额: 0.16 USDC
返佣交易哈希: _______________
```

---

### TC6: 推荐列表展示

**目标**: 验证推荐列表正确展示被推荐人信息

**测试步骤**:
1. 用账户 A 登录 (已有 1 个被推荐人 B)
2. 访问 `/referral` 页面
3. 查看 "推荐列表" 区域

**预期结果**:
- ✅ 列表显示 1 位用户
- ✅ 显示账户 B 地址 (缩写): `0x7099...c79C8`
- ✅ 显示绑定时间
- ✅ 显示下注统计: "X 笔下注, 总额: Y USDC"
- ✅ 如果有下注,显示 "活跃" 徽章

---

### TC7: 排行榜功能

**目标**: 验证推荐排行榜正确排序和展示

**前置条件**:
- 需要多个推荐人有返佣数据

**测试步骤**:
1. 访问 `/referral` 页面
2. 滚动到 "推荐排行榜" 区域
3. 观察排序和显示

**预期结果**:
- ✅ 按 "累计返佣" 从高到低排序
- ✅ 前三名显示奖牌图标 (🥇🥈🥉)
- ✅ 每行显示:
  - 排名
  - 推荐人地址
  - 推荐人数
  - 有效推荐数
  - 累计返佣金额
- ✅ 数据来自 Subgraph

---

### TC8: 推荐统计页

**目标**: 验证专门的统计页面功能

**测试步骤**:
1. 用账户 A 登录
2. 访问 `/referral/stats` 页面
3. 查看各个数据模块

**预期结果**:
- ✅ 统计卡片显示正确数据
- ✅ 推荐列表与主页一致
- ✅ 返佣历史完整显示
- ✅ 数据说明卡片正确展示

---

### TC9: Subgraph 数据索引

**目标**: 验证 Subgraph 正确索引推荐事件

**测试步骤**:
1. 完成账户 B 绑定账户 A
2. 账户 B 下注触发返佣
3. 访问 GraphQL Playground: `http://localhost:8000/subgraphs/name/pitchone-sportsbook/graphql`
4. 执行查询

**GraphQL 查询**:
```graphql
# 查询推荐关系
{
  referrals {
    id
    referrer
    referee
    boundAt
  }
}

# 查询推荐人统计
{
  referrerStats {
    id
    referralCount
    totalRewards
    validReferralCount
  }
}

# 查询返佣记录
{
  referralRewards {
    id
    referrer
    referee
    amount
    timestamp
  }
}
```

**预期结果**:
- ✅ `referrals` 返回绑定记录
- ✅ `referrerStats` 显示正确统计
- ✅ `referralRewards` 显示返佣记录
- ✅ 所有金额为 BigDecimal 格式 (已除以 1e6)

---

### TC10: 边界情况和错误处理

**测试场景**:

**10.1 无效的推荐人地址**
- 访问: `http://localhost:3000/?ref=invalid_address`
- 预期: 无操作,URL 参数被忽略

**10.2 未连接钱包**
- 访问推荐链接但不连接钱包
- 预期: ReferralBinder 不执行绑定

**10.3 网络错误**
- 停止 Graph Node
- 访问 `/referral` 页面
- 预期:
  - Subgraph 查询失败
  - 显示错误状态
  - 链上查询仍然可用

**10.4 推荐参数配置**
- 查询链上参数: `referralFeeBps`, `minValidVolume`, `validityWindow`
- 预期: 显示在统计卡片中

---

## 性能测试

### PT1: 页面加载性能
- 测量 `/referral` 页面首次加载时间
- 目标: < 3 秒

### PT2: GraphQL 查询性能
- 测量推荐列表查询时间 (20 条记录)
- 目标: < 500ms

### PT3: 分页加载
- 测试大量推荐人 (100+) 的分页性能
- 目标: 每页加载 < 300ms

---

## 回归测试清单

每次代码变更后执行:
- [ ] TC1: URL 参数检测和自动绑定
- [ ] TC4: 推荐链接生成
- [ ] TC5: 下注触发返佣
- [ ] TC6: 推荐列表展示
- [ ] TC9: Subgraph 数据索引

---

## 已知问题和限制

1. **Subgraph 同步延迟**: 新事件可能需要 1-2 个区块才能被索引
2. **返佣金额精度**: 使用 BigDecimal,前端显示需要格式化
3. **排行榜缓存**: 考虑添加前端缓存减少查询频率

---

## 测试记录模板

```
测试日期: _______________
测试人员: _______________
测试环境:
  - Anvil 版本: _______________
  - Graph Node 版本: _______________
  - 前端版本: _______________

测试结果:
| 测试用例 | 状态 | 备注 |
|---------|------|------|
| TC1     | ✅   |      |
| TC2     | ✅   |      |
| TC3     | ✅   |      |
| TC4     | ✅   |      |
| TC5     | ⏳   |      |
| TC6     | ⏳   |      |
| TC7     | ⏳   |      |
| TC8     | ⏳   |      |
| TC9     | ⏳   |      |
| TC10    | ⏳   |      |

发现的问题:
1. _______________
2. _______________

改进建议:
1. _______________
2. _______________
```
