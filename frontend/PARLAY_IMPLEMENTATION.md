# Parlay (ä¸²å…³) åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

å·²å®Œæˆ Basketï¼ˆä¸²å…³ï¼‰åŠŸèƒ½çš„å‰ç«¯å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- âœ… åˆçº¦ ABI å¯¼å…¥å’Œ TypeScript ç±»å‹ç”Ÿæˆ
- âœ… 8 ä¸ª React Hooks å®ç°
- âœ… 3 ä¸ª UI ç»„ä»¶å®ç°
- âœ… å®Œæ•´çš„ä¸²å…³é¡µé¢

---

## ğŸ¯ å·²å®ç°çš„åŠŸèƒ½

### 1. Basket Hooks (`packages/web3/src/basket-hooks.ts`)

#### åªè¯» Hooks

1. **useParlayQuote** - è·å–ä¸²å…³æŠ¥ä»·
   - è¾“å…¥ï¼šä¸²å…³è…¿æ•°ç»„ + ä¸‹æ³¨é‡‘é¢
   - è¾“å‡ºï¼šç»„åˆèµ”ç‡ã€ç›¸å…³æ€§æƒ©ç½šã€æ½œåœ¨èµ”ä»˜
   - è‡ªåŠ¨æ ¼å¼åŒ–ä¸ºå¯è¯»æ ¼å¼ï¼ˆå¦‚ "3.5x"ï¼‰

2. **useParlayDetails** - è·å–ä¸²å…³è¯¦æƒ…
   - è¾“å…¥ï¼šä¸²å…³ ID
   - è¾“å‡ºï¼šå®Œæ•´çš„ä¸²å…³æ•°æ®ï¼ˆè…¿ã€é‡‘é¢ã€çŠ¶æ€ç­‰ï¼‰

3. **useUserParlays** - è·å–ç”¨æˆ·çš„æ‰€æœ‰ä¸²å…³
   - è¾“å…¥ï¼šç”¨æˆ·åœ°å€
   - è¾“å‡ºï¼šä¸²å…³ ID æ•°ç»„

4. **useCanSettle** - æ£€æŸ¥ä¸²å…³æ˜¯å¦å¯ç»“ç®—
   - è¾“å…¥ï¼šä¸²å…³ ID
   - è¾“å‡ºï¼šæ˜¯å¦å¯ç»“ç®— + é¢„æœŸçŠ¶æ€

5. **usePoolStatus** - è·å– Basket æ± çŠ¶æ€
   - è¾“å‡ºï¼šå‚¨å¤‡é‡‘ã€é”å®šé‡‘é¢ã€æ½œåœ¨èµ”ä»˜

#### å†™å…¥ Hooks

6. **useCreateParlay** - åˆ›å»ºä¸²å…³
   - è¾“å…¥ï¼šä¸²å…³è…¿æ•°ç»„ + ä¸‹æ³¨é‡‘é¢
   - è‡ªåŠ¨éªŒè¯ï¼š2-10 åœºé™åˆ¶

7. **useSettleParlay** - ç»“ç®—å•ä¸ªä¸²å…³
   - è¾“å…¥ï¼šä¸²å…³ ID

8. **useBatchSettleParlays** - æ‰¹é‡ç»“ç®—ä¸²å…³
   - è¾“å…¥ï¼šä¸²å…³ ID æ•°ç»„

### 2. UI ç»„ä»¶ (`apps/user/src/components/parlay/`)

#### ParlayBuilder.tsx - ä¸²å…³æ„å»ºå™¨
**åŠŸèƒ½**ï¼š
- å±•ç¤ºé€‰ä¸­çš„å¸‚åœºå’Œç»“æœ
- å®æ—¶è·å–ç»„åˆèµ”ç‡æŠ¥ä»·
- æ˜¾ç¤ºç›¸å…³æ€§æƒ©ç½š
- è¾“å…¥ä¸‹æ³¨é‡‘é¢
- ä¸€é”®åˆ›å»ºä¸²å…³

**ç‰¹ç‚¹**ï¼š
- è‡ªåŠ¨ USDC æˆæƒæ£€æŸ¥
- å®æ—¶æŠ¥ä»·æ›´æ–°
- é”™è¯¯å¤„ç†å’ŒæˆåŠŸåé¦ˆ
- æ”¯æŒ 2-10 åœºé™åˆ¶éªŒè¯

#### ParlayCard.tsx - ä¸²å…³å¡ç‰‡
**åŠŸèƒ½**ï¼š
- å±•ç¤ºä¸²å…³è¯¦ç»†ä¿¡æ¯
- æ˜¾ç¤ºä¸²å…³çŠ¶æ€ï¼ˆå¾…ç»“ç®—/èµ¢/è¾“/å–æ¶ˆï¼‰
- æ˜¾ç¤ºæ‰€æœ‰ä¸²å…³è…¿
- æ˜¾ç¤ºé‡‘é¢å’Œèµ”ç‡ä¿¡æ¯
- æ”¯æŒä¸€é”®ç»“ç®—ï¼ˆå¦‚æœå¯ç»“ç®—ï¼‰

**ç‰¹ç‚¹**ï¼š
- çŠ¶æ€å¾½ç« ï¼ˆä¸åŒé¢œè‰²ï¼‰
- ç´§å‡‘æ¨¡å¼æ”¯æŒ
- è‡ªåŠ¨æ ¼å¼åŒ–é‡‘é¢å’Œèµ”ç‡

#### ParlayList.tsx - ä¸²å…³åˆ—è¡¨
**åŠŸèƒ½**ï¼š
- å±•ç¤ºç”¨æˆ·çš„æ‰€æœ‰ä¸²å…³
- æ”¯æŒæ•°é‡é™åˆ¶
- ç©ºçŠ¶æ€å’Œé”™è¯¯å¤„ç†

**ç‰¹ç‚¹**:
- å“åº”å¼ç½‘æ ¼å¸ƒå±€
- åŠ è½½çŠ¶æ€
- åˆ†é¡µæç¤º

### 3. ä¸²å…³é¡µé¢ (`apps/user/src/app/parlay/`)

#### page.tsx + ParlayPageClient.tsx
**åŠŸèƒ½**ï¼š
- åŒæ ‡ç­¾é¡µï¼ˆåˆ›å»ºä¸²å…³ / æˆ‘çš„ä¸²å…³ï¼‰
- ä¸²å…³åˆ›å»ºæŒ‡å—
- å¸‚åœºé€‰æ‹©å¼•å¯¼
- ä¸²å…³è§„åˆ™è¯´æ˜

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
frontend/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ contracts/src/
â”‚   â”‚   â”œâ”€â”€ abis/
â”‚   â”‚   â”‚   â”œâ”€â”€ Basket.json         âœ… Basket åˆçº¦ ABI
â”‚   â”‚   â”‚   â””â”€â”€ Basket.ts           âœ… TypeScript å¯¼å‡º
â”‚   â”‚   â””â”€â”€ index.ts                âœ… å¯¼å‡º BasketABI
â”‚   â””â”€â”€ web3/src/
â”‚       â”œâ”€â”€ basket-hooks.ts         âœ… 8 ä¸ª Basket Hooks
â”‚       â””â”€â”€ index.ts                âœ… å¯¼å‡ºæ‰€æœ‰ Hooks
â””â”€â”€ apps/user/src/
    â”œâ”€â”€ components/parlay/
    â”‚   â”œâ”€â”€ ParlayBuilder.tsx       âœ… ä¸²å…³æ„å»ºå™¨
    â”‚   â”œâ”€â”€ ParlayCard.tsx          âœ… ä¸²å…³å¡ç‰‡
    â”‚   â”œâ”€â”€ ParlayList.tsx          âœ… ä¸²å…³åˆ—è¡¨
    â”‚   â””â”€â”€ index.ts                âœ… å¯¼å‡ºæ‰€æœ‰ç»„ä»¶
    â””â”€â”€ app/parlay/
        â”œâ”€â”€ page.tsx                âœ… Next.js é¡µé¢
        â””â”€â”€ ParlayPageClient.tsx    âœ… å®¢æˆ·ç«¯ç»„ä»¶
```

---

## ğŸ¨ UI/UX ç‰¹æ€§

### è§†è§‰è®¾è®¡
- âœ… Neon ä¸»é¢˜ï¼ˆè“è‰²/ç»¿è‰²éœ“è™¹ç¯æ•ˆæœï¼‰
- âœ… çŠ¶æ€é¢œè‰²ç¼–ç ï¼ˆç»¿è‰²=èµ¢ï¼Œçº¢è‰²=è¾“ï¼Œé»„è‰²=å¾…ç»“ç®—ï¼‰
- âœ… å“åº”å¼å¸ƒå±€ï¼ˆç§»åŠ¨ç«¯/æ¡Œé¢ç«¯ï¼‰
- âœ… Framer Motion åŠ¨ç”»

### ç”¨æˆ·ä½“éªŒ
- âœ… å®æ—¶æŠ¥ä»·æ›´æ–°
- âœ… è‡ªåŠ¨ USDC æˆæƒå¤„ç†
- âœ… æ˜ç¡®çš„é”™è¯¯æç¤º
- âœ… æˆåŠŸåé¦ˆ
- âœ… åŠ è½½çŠ¶æ€æŒ‡ç¤º

---

## ğŸ”„ æ•°æ®æµ

### åˆ›å»ºä¸²å…³æµç¨‹
```
1. ç”¨æˆ·é€‰æ‹©å¤šåœºæ¯”èµ›çš„ç»“æœ
   â†“
2. ParlayBuilder è°ƒç”¨ useParlayQuote
   â†“
3. æ˜¾ç¤ºç»„åˆèµ”ç‡å’Œæ½œåœ¨èµ”ä»˜
   â†“
4. ç”¨æˆ·è¾“å…¥ä¸‹æ³¨é‡‘é¢
   â†“
5. æ£€æŸ¥ USDC æˆæƒï¼ˆuseUSDCAllowanceï¼‰
   â†“
6. å¦‚éœ€æˆæƒï¼Œè°ƒç”¨ useApproveUSDC
   â†“
7. è°ƒç”¨ useCreateParlay.createParlay()
   â†“
8. äº¤æ˜“ç¡®è®¤åé‡ç½®è¡¨å•
   â†“
9. è·³è½¬åˆ°"æˆ‘çš„ä¸²å…³"æ ‡ç­¾
```

### ç»“ç®—ä¸²å…³æµç¨‹
```
1. ParlayCard è°ƒç”¨ useCanSettle
   â†“
2. å¦‚æœå¯ç»“ç®—ï¼Œæ˜¾ç¤º"ç«‹å³ç»“ç®—"æŒ‰é’®
   â†“
3. ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
   â†“
4. è°ƒç”¨ useSettleParlay.settle()
   â†“
5. äº¤æ˜“ç¡®è®¤åæ›´æ–°å¡ç‰‡çŠ¶æ€
```

---

## ğŸ“ ç±»å‹å®šä¹‰

```typescript
// ä¸²å…³è…¿
export interface ParlayLeg {
  marketAddress: Address;
  outcomeId: number;
}

// ä¸²å…³çŠ¶æ€
export enum ParlayStatus {
  Pending = 0,
  Won = 1,
  Lost = 2,
  Cancelled = 3,
}

// ä¸²å…³æ•°æ®
export interface Parlay {
  user: Address;
  legs: ParlayLeg[];
  stake: bigint;
  potentialPayout: bigint;
  combinedOdds: bigint;
  penaltyBps: bigint;
  status: ParlayStatus;
  createdAt: bigint;
  settledAt: bigint;
}

// ä¸²å…³æŠ¥ä»·
export interface ParlayQuote {
  combinedOdds: bigint;
  penaltyBps: bigint;
  potentialPayout: bigint;
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### å¾…å®ç°åŠŸèƒ½
1. **å¸‚åœºé¡µé¢é›†æˆ**
   - åœ¨å¸‚åœºå¡ç‰‡ä¸Šæ·»åŠ "åŠ å…¥ä¸²å…³"æŒ‰é’®
   - å®ç°å¸‚åœºé€‰æ‹©å™¨
   - è·¨é¡µé¢çŠ¶æ€ç®¡ç†ï¼ˆå¦‚ä½¿ç”¨ Zustand æˆ– React Contextï¼‰

2. **Portfolio é¡µé¢é›†æˆ**
   - åœ¨ Portfolio é¡µé¢æ·»åŠ "ä¸²å…³"æ ‡ç­¾
   - æ˜¾ç¤ºå†å²ä¸²å…³è®°å½•
   - ç»Ÿè®¡æ•°æ®ï¼ˆèƒœç‡ã€æ€»ç›ˆäºç­‰ï¼‰

3. **ä¼˜åŒ–**
   - æ·»åŠ ä¸²å…³é¢„è§ˆï¼ˆåœ¨é€‰æ‹©å¸‚åœºæ—¶ï¼‰
   - å®ç°ä¸²å…³åˆ†äº«åŠŸèƒ½
   - æ·»åŠ ä¸²å…³æ¨¡æ¿ï¼ˆçƒ­é—¨ç»„åˆï¼‰

4. **æµ‹è¯•**
   - å•å…ƒæµ‹è¯•ï¼ˆHooksï¼‰
   - é›†æˆæµ‹è¯•ï¼ˆç»„ä»¶äº¤äº’ï¼‰
   - E2E æµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹ï¼‰

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœ¨å¸‚åœºé¡µé¢æ·»åŠ "åŠ å…¥ä¸²å…³"æŒ‰é’®

```tsx
import { useRouter } from 'next/navigation';

function MarketCard({ market }) {
  const router = useRouter();

  const handleAddToParlay = (outcomeId: number) => {
    // TODO: ä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†å™¨å­˜å‚¨é€‰æ‹©
    const outcome: SelectedOutcome = {
      marketAddress: market.address,
      marketName: `${market.homeTeam} vs ${market.awayTeam}`,
      outcomeId,
      outcomeName: getOutcomeName(outcomeId),
      odds: getOdds(outcomeId),
    };

    // å­˜å‚¨åˆ°çŠ¶æ€
    addToParlayCart(outcome);

    // è·³è½¬åˆ°ä¸²å…³é¡µé¢
    router.push('/parlay');
  };

  return (
    <button onClick={() => handleAddToParlay(0)}>
      åŠ å…¥ä¸²å…³
    </button>
  );
}
```

---

## âœ… å®Œæˆæ¸…å•

- [x] Basket ABI å¤åˆ¶åˆ°å‰ç«¯
- [x] TypeScript ç±»å‹ç”Ÿæˆ
- [x] 8 ä¸ª Basket Hooks å®ç°
- [x] ParlayBuilder ç»„ä»¶
- [x] ParlayCard ç»„ä»¶
- [x] ParlayList ç»„ä»¶
- [x] ä¸²å…³é¡µé¢
- [ ] å¸‚åœºé¡µé¢é›†æˆ
- [ ] Portfolio é¡µé¢é›†æˆ
- [ ] çŠ¶æ€ç®¡ç†å™¨ï¼ˆZustandï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] E2E æµ‹è¯•

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-08
**å®Œæˆè¿›åº¦**: å‰ç«¯æ ¸å¿ƒåŠŸèƒ½ 100%ï¼ˆHooks + ç»„ä»¶ + é¡µé¢ï¼‰
**å¾…é›†æˆ**: å¸‚åœºé€‰æ‹©å™¨ + å…¨å±€çŠ¶æ€ç®¡ç†
