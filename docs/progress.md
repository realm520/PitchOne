# PitchOne 开发进度追踪

> **项目类型**：去中心化链上足球博彩平台
> **团队规模**：1-2人全栈小团队
> **核心策略**：质量优先 | 合约层优先 | 三阶段迭代交付
> **文档版本**：v1.0
> **创建日期**：2025-10-29

---

## 📊 当前状态概览

**当前阶段**：🔴 **准备阶段**（M0 未启动）

| 维度 | 状态 | 完成度 | 备注 |
|-----|------|--------|------|
| 合约层 | 🔴 未开始 | 0% | 仅占位符文件 |
| 后端服务 | 🔴 未开始 | 0% | 仅占位符文件 |
| Subgraph | 🔴 未开始 | <5% | 极简骨架 |
| 基础设施 | 🟡 部分完成 | 30% | Docker Compose 已配置 |
| 文档 | 🟢 已完成 | 100% | 10份设计文档完成 |

**本周目标**：_（待填写）_

**阻塞问题**：_（待填写）_

---

## 🎯 核心策略

**三阶段迭代交付**：从简到繁，每阶段都有完整可演示的产品

```
阶段1（4-6周） → 核心合约 + 基础测试 + 最小链下支持
阶段2（4-6周） → 运营机制 + 完整后端 + 数据可视化
阶段3（3-4周） → 高级玩法 + 审计修复 + 生产部署
```

**质量保障原则**：
- ✅ 每个阶段都完成 测试→审计→文档 闭环
- ✅ 测试覆盖率 ≥80%（合约）、≥70%（后端）
- ✅ 代码审查：核心合约必须双人审核（如果是双人团队）
- ✅ 安全检查：Slither + Echidna + 外部审计

---

## 🚀 阶段1：核心市场闭环（4-6周）

**目标**：实现单一市场类型（WDL 胜平负）的完整生命周期

### Week 1-2：合约基础设施

**交付物清单**：

- [ ] **MarketBase.sol** - 市场基础合约
  - [ ] 状态机：Open → Locked → Resolved → Finalized
  - [ ] ERC-1155 头寸代币集成
  - [ ] 基础权限控制（Owner + Pauser）
  - [ ] 核心事件定义（MarketCreated/BetPlaced/Locked/Resolved/Redeemed）

- [ ] **WDL_Template.sol** - 胜平负市场模板
  - [ ] 三向结果枚举（Home/Draw/Away）
  - [ ] 简单的状态验证逻辑

- [ ] **SimpleCPMM.sol** - 最简定价器
  - [ ] 二向 CPMM（x*y=k）
  - [ ] 三向扩展（x*y*z=k³）
  - [ ] 费率扣除逻辑

- [ ] **测试套件**
  - [ ] 单元测试：每个函数的正常/异常分支
  - [ ] 不变量测试：流动性守恒、赔率边界
  - [ ] 覆盖率目标：≥80%

**质量检查点**：
- [ ] `forge test` 全部通过
- [ ] `forge coverage` ≥80%
- [ ] `slither .` 无高危/中危问题
- [ ] 能部署到本地 Anvil 并手动测试完整流程

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### Week 3-4：预言机与结算

**交付物清单**：

- [ ] **MockOracle.sol** - 测试用预言机
  - [ ] Owner 可直接提交结果（无争议机制）
  - [ ] 适合开发和测试阶段
  - [ ] 支持 WDL 结果提交

- [ ] **ResultOracle.sol** - 预言机接口抽象
  - [ ] 定义标准化的 `MatchFacts` 结构
  - [ ] 定义结算回调接口
  - [ ] 事件：ResultProposed/ResultFinalized

- [ ] **FeeRouter.sol** - 费用路由（简化版）
  - [ ] 单一金库接收所有费用
  - [ ] 为阶段2的多方分成预留接口

- [ ] **集成测试**
  - [ ] 完整流程：创建市场→下注→锁盘→结算→兑付
  - [ ] Gas 消耗测试（确保单笔交易 <300k gas）
  - [ ] 边界场景：零流动性、极端赔率等

**质量检查点**：
- [ ] 能在 Anvil 上完整跑通 WDL 市场生命周期
- [ ] 编写 Foundry Script 用于一键演示
- [ ] 合约代码通过 Code Review（如果是双人团队）

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### Week 5-6：最小链下支持

**交付物清单**：

- [ ] **Go Indexer**（最小版本）
  - [ ] 订阅 MarketBase 的核心事件（BetPlaced/Locked/Resolved）
  - [ ] 写入 Postgres（3张表：markets/orders/positions）
  - [ ] 支持从指定区块重放
  - [ ] 基础错误处理和日志

- [ ] **简单 API 或 Subgraph**（二选一）
  - [ ] 方案A：REST 端点 - 查询市场列表、用户头寸
  - [ ] 方案B：The Graph Subgraph（推荐，减少后端工作量）
    - [ ] schema.graphql 完善
    - [ ] Event handlers 实现
    - [ ] 本地 Graph Node 测试

- [ ] **Keeper 脚本**（Python/Shell 即可）
  - [ ] 定时检查即将开赛的市场并调用 `lock()`
  - [ ] 简单的失败重试机制
  - [ ] 日志记录和告警

**质量检查点**：
- [ ] Indexer 能正确解析和存储所有事件
- [ ] 能通过 API/Subgraph 查询实时数据
- [ ] Keeper 能自动锁盘（在测试环境验证）

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### 🎯 阶段1 里程碑验收

**演示目标**：
- [ ] 创建 WDL 市场
- [ ] 模拟用户下注
- [ ] 自动锁盘
- [ ] 手动提交结果
- [ ] 用户兑付

**代码质量**：
- [ ] 测试覆盖率 ≥80%
- [ ] 无高危安全问题
- [ ] 代码符合项目规范

**文档产出**：
- [ ] 合约接口文档（NatSpec）
- [ ] 部署脚本和说明
- [ ] 开发者指南（如何本地运行）

**验收时间**：____
**验收结果**：通过 / 未通过
**改进建议**：

---

## 🔧 阶段2：运营机制与数据（4-6周）

**目标**：添加推荐、奖励、多玩法支持

### Week 7-8：增长基建合约

**交付物清单**：

- [ ] **ReferralRegistry.sol** - 推荐关系注册
  - [ ] 一次绑定，永久关联
  - [ ] 防止循环推荐（A→B→A）
  - [ ] 事件：ReferralBound

- [ ] **RewardsDistributor.sol** - Merkle 奖励分发
  - [ ] 管理员发布 Merkle Root
  - [ ] 用户凭 Proof 领取奖励
  - [ ] 防重复领取
  - [ ] 事件：RootPublished/RewardClaimed

- [ ] **FeeRouter.sol** - 完整版
  - [ ] 费用分成：LP 60% / Promo Pool 20% / Treasury 20%
  - [ ] 推荐返佣计算接口
  - [ ] 多方分成路由逻辑

- [ ] **测试与审计准备**
  - [ ] 针对推荐和奖励的博弈测试（Echidna）
  - [ ] 数学模型验证（费用分成加总 = 100%）
  - [ ] 边界测试：零推荐、大量推荐、极端奖励金额

**质量检查点**：
- [ ] 所有合约测试通过
- [ ] 推荐关系逻辑经过博弈测试验证
- [ ] Merkle 树生成和验证逻辑正确

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### Week 9-10：OU 市场模板

**交付物清单**：

- [ ] **OU_Template.sol** - 大小球市场
  - [ ] 单线版本（Over 2.5 / Under 2.5）
  - [ ] 独立的 CPMM 定价器实例
  - [ ] 结算逻辑：比较实际进球数与线

- [ ] **MarketTemplateRegistry.sol** - 模板注册表
  - [ ] 管理所有市场模板（WDL/OU/未来的AH）
  - [ ] 工厂模式创建市场
  - [ ] 模板版本管理

- [ ] **更新 MockOracle**
  - [ ] 支持提交进球数（用于 OU 结算）
  - [ ] 扩展 MatchFacts 结构

**质量检查点**：
- [ ] 能创建和交易 OU 市场
- [ ] WDL 和 OU 市场可以并存
- [ ] 模板注册表逻辑正确

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### Week 11-12：完整后端与监控

**交付物清单**：

- [ ] **Go Indexer**（完整版）
  - [ ] 订阅所有合约事件（+Referral/Rewards）
  - [ ] 完整的数据库 Schema（7-10张表）
  - [ ] 性能优化：批量写入、连接池
  - [ ] 健康检查端点

- [ ] **Rewards Builder**
  - [ ] 周度任务：计算推荐返佣
  - [ ] 生成 Merkle Tree（使用成熟库）
  - [ ] 发布 Root 到链上
  - [ ] 生成 Proof JSON 文件供前端使用

- [ ] **Keeper Service**（完整版）
  - [ ] 锁盘自动化（多市场支持）
  - [ ] 健康检查和告警
  - [ ] 冗余机制（本地 + Gelato 备份）

- [ ] **Grafana Dashboard**
  - [ ] 市场数量、下注金额、Gas 消耗
  - [ ] Indexer 延迟、Keeper 执行成功率
  - [ ] 数据库连接池状态
  - [ ] 告警规则配置

**质量检查点**：
- [ ] 所有服务能稳定运行 24 小时
- [ ] Indexer 延迟 <5 秒
- [ ] Rewards Builder 能正确生成 Merkle Tree
- [ ] 监控面板数据准确

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### 🎯 阶段2 里程碑验收

**演示目标**：
- [ ] 多市场（WDL+OU）同时运行
- [ ] 推荐关系生效
- [ ] 周度奖励自动发放
- [ ] 监控面板展示实时数据

**代码质量**：
- [ ] 所有模块测试覆盖率 ≥70%
- [ ] 后端服务通过负载测试
- [ ] 无内存泄漏和明显性能问题

**运维就绪**：
- [ ] 监控仪表盘完整
- [ ] 告警规则配置
- [ ] 日志查询方便
- [ ] 部署文档完善

**验收时间**：____
**验收结果**：通过 / 未通过
**改进建议**：

---

## 🏆 阶段3：高级玩法与上线（3-4周）

**目标**：串关 + AH 市场 + 安全审计 + 生产部署

### Week 13-14：串关 + AH 市场

**交付物清单**：

- [ ] **Basket.sol** - 串关合约
  - [ ] 支持 2-5 个市场组合
  - [ ] 组合赔率计算（各市场赔率相乘）
  - [ ] 简单的相关性检查（同场同向阻断）
  - [ ] 结算逻辑：全中才赢

- [ ] **AH_Template.sol** - 让球市场
  - [ ] 单线版本（如 -0.5）
  - [ ] 复用 CPMM 定价逻辑
  - [ ] 结算逻辑：调整后的比分差

- [ ] **CorrelationGuard.sol**（可选）
  - [ ] 相关性惩罚矩阵
  - [ ] 如果时间紧张，可延后到阶段4
  - [ ] 链下计算 + 链上验证

**质量检查点**：
- [ ] 串关逻辑正确且 Gas 效率合理
- [ ] AH 市场能正常交易和结算
- [ ] 相关性检查有效防止作弊

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### Week 15-16：安全审计与修复

**交付物清单**：

- [ ] **外部审计准备**
  - [ ] 选择审计机构（OpenZeppelin/Trail of Bits/Consensys Diligence）
  - [ ] 整理完整合约代码 + 文档
  - [ ] 提交审计申请（预留 2-3 周审计时间）

- [ ] **审计修复**
  - [ ] 根据审计报告修复问题
  - [ ] 严重问题立即修复
  - [ ] 中等问题评估修复
  - [ ] 低危问题记录备案

- [ ] **Gas 优化**（如果有明显问题）
  - [ ] 使用 forge snapshot 对比优化前后
  - [ ] 优化存储布局
  - [ ] 批量操作优化

- [ ] **Bug Bounty 准备**
  - [ ] 在 Immunefi 发布悬赏
  - [ ] 设置赏金金额（高危/中危/低危）
  - [ ] 监控 2-4 周

**质量检查点**：
- [ ] 外部审计通过，无高危/中危问题
- [ ] Gas 消耗在合理范围（<500k per tx）
- [ ] Bug Bounty 运行至少 2 周无严重发现

**本周实际进度**：
```
完成时间：____
实际完成：
- [ ]
阻塞问题：
-
经验教训：
-
```

---

### 🎯 阶段3 里程碑验收

**安全目标**：
- [ ] 外部审计通过，无高危/中危问题
- [ ] Bug Bounty 至少运行 2 周
- [ ] 所有已知漏洞已修复

**功能完整性**：
- [ ] 支持 WDL/OU/AH 三种市场类型
- [ ] 支持串关（2-5 个市场组合）
- [ ] 推荐和奖励机制完整

**生产就绪**：
- [ ] 部署脚本完整且经过测试
- [ ] 应急手册（紧急暂停、回滚流程）
- [ ] 监控告警全覆盖
- [ ] 文档齐全（用户文档 + 开发文档 + 运维文档）

**验收时间**：____
**验收结果**：通过 / 未通过
**改进建议**：

---

## 📈 进度追踪与调整机制

### 每周检查点（建议周五执行）

**本周回顾**：
```
日期：____
阶段：阶段__ Week__

✅ 完成的交付物：
-

⏳ 进行中的工作：
-

🚫 阻塞问题：
-

💡 经验教训：
-

📊 关键指标：
- 代码行数：____
- 测试覆盖率：____%
- 发现的 Bug：____
- 修复的 Bug：____
```

**下周计划**：
```
🎯 主要目标：
-

⚠️ 风险预判：
-

🔧 需要的资源/帮助：
-
```

---

### 质量闸门（每阶段末）

**阶段__ 质量检查**：
```
日期：____

✅ 质量标准：
- [ ] 所有测试通过
- [ ] 代码审查完成
- [ ] 文档更新完成
- [ ] 演示环境可用
- [ ] 安全检查通过

📝 验收意见：


👍 通过 / 👎 未通过

下一步行动：
-
```

---

### 风险管理日志

| 日期 | 风险描述 | 等级 | 应对措施 | 状态 |
|-----|---------|------|---------|------|
| 示例：2025-11-01 | CPMM 算法复杂度高 | 🟡 中 | 参考 Uniswap V2 实现 | ✅ 已解决 |
| | | | | |
| | | | | |
| | | | | |

---

## 👥 团队协作指南

### 如果是1人团队（全栈）

**时间分配建议**：
- 70% 合约开发 + 测试
- 20% 链下服务（Indexer/Keeper 最小化）
- 10% 部署与运维

**效率技巧**：
1. **大量复用成熟库**
   - OpenZeppelin Contracts（ERC-1155/AccessControl/Pausable）
   - OpenZeppelin Merkle Tree
   - Solmate（Gas 优化版的 ERC 实现）

2. **减少自建组件**
   - 用 The Graph Subgraph 替代自建 API
   - 用 Gelato 替代自建 Keeper（阶段2后期）
   - 用 Tenderly 调试，减少本地重复部署

3. **自动化工具**
   - GitHub Actions 自动测试
   - Slither 自动安全扫描
   - forge fmt 自动格式化

4. **知识管理**
   - 记录所有技术决策（为什么选择 X 而不是 Y）
   - 代码注释要充分（未来的自己就是"新同事"）
   - 遇到难题先 Google + ChatGPT，不要死磕

---

### 如果是2人团队

**分工建议**：

**人员A（合约专家）**：
- ✅ 所有 Solidity 代码开发
- ✅ Foundry 测试编写
- ✅ 与审计机构对接
- ✅ Gas 优化

**人员B（全栈/后端）**：
- ✅ Go Indexer + Keeper 开发
- ✅ The Graph Subgraph 开发
- ✅ DevOps（CI/CD + 监控）
- ✅ 前端（如果需要）

**协作要点**：
1. **每日同步**（15分钟 standup）
   - 昨天完成了什么？
   - 今天计划做什么？
   - 有什么阻塞需要帮助？

2. **共享测试环境**
   - 统一的 Anvil 本地链
   - 共享的 Postgres 测试数据库
   - 统一的部署脚本

3. **代码互审**
   - 核心合约必须双人审核
   - 使用 GitHub Pull Request 流程
   - 审查清单：功能正确性 + 安全性 + Gas 效率

4. **文档协作**
   - 使用 Notion/飞书 共享文档
   - 及时更新 progress.md
   - 记录重要决策和原因

---

## 🚀 可选扩展（阶段4+，按需添加）

如果前三阶段顺利完成，可以考虑以下扩展方向：

### 高级玩法

- [ ] **精确比分市场**
  - LMSR 定价器实现
  - 比分网格（如 0-0, 1-0, 1-1...）
  - 更复杂的 Gas 优化

- [ ] **球员道具市场**（Props）
  - 球员进球数（如梅西进球 Over/Under 0.5）
  - 球员助攻、射门、犯规等
  - 需要更详细的 MatchFacts

### 预言机升级

- [ ] **UMA OO 集成**（替换 MockOracle）
  - Propose-Dispute-Resolve 完整流程
  - 质押和惩罚机制
  - 与 UMA 社区对接

### 用户体验

- [ ] **前端 DApp**
  - React + RainbowKit
  - 市场浏览和下注界面
  - 用户头寸和奖励查询
  - 推荐链接生成

### 多链部署

- [ ] **L2 扩展**
  - Arbitrum/Optimism/Base 部署
  - 跨链桥接（如果需要）
  - 多链监控和运维

### 运营工具

- [ ] **管理后台**
  - 市场创建界面
  - 参数调整工具
  - 紧急暂停面板
  - 数据分析仪表盘

---

## 📚 参考资源

### 官方文档
- Foundry Book: https://book.getfoundry.sh/
- OpenZeppelin Docs: https://docs.openzeppelin.com/
- The Graph Docs: https://thegraph.com/docs/
- UMA Docs: https://docs.umaproject.org/

### 代码参考
- Uniswap V2: https://github.com/Uniswap/v2-core
- Gnosis Conditional Tokens: https://github.com/gnosis/conditional-tokens-contracts
- Polymarket: https://github.com/Polymarket

### 学习资源
- Smart Contract Security: https://github.com/crytic/building-secure-contracts
- Gas Optimization: https://github.com/wolflo/evm-opcodes
- Echidna Tutorial: https://github.com/crytic/building-secure-contracts/tree/master/program-analysis/echidna

---

## 📝 总结

**总时间估算**：11-16 周（根据团队规模和优先级）

**核心原则**：
- ✅ 质量优先，不追求速度
- ✅ 分阶段验证，迭代交付
- ✅ 充分测试，确保安全
- ✅ 文档齐全，便于维护

**关键里程碑**：
- 🎯 阶段1结束（4-6周）：第一个可演示版本
- 🎯 阶段2结束（8-12周）：功能相对完整的版本
- 🎯 阶段3结束（11-16周）：生产上线准备完成

**建议立即开始**：
1. 安装 Foundry 依赖（forge install）
2. 实现 MarketBase.sol 基础框架
3. 编写第一个单元测试

---

**最后更新**：2025-10-29
**下次更新**：____
**维护人**：____
