# PitchOne åˆçº¦æ¶æ„è®¾è®¡æ–‡æ¡£

> æœ€åæ›´æ–°ï¼š2025-12-06

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° PitchOne å»ä¸­å¿ƒåŒ–åšå½©å¹³å°çš„åˆçº¦æ¶æ„ã€æ¨¡å—å…³ç³»å’Œæ ¸å¿ƒè°ƒç”¨é€»è¾‘ã€‚

---

## ç›®å½•

1. [æ•´ä½“æ¶æ„åˆ†å±‚](#1-æ•´ä½“æ¶æ„åˆ†å±‚)
2. [åˆçº¦æ¨¡å—æ¦‚è§ˆ](#2-åˆçº¦æ¨¡å—æ¦‚è§ˆ)
3. [æ ¸å¿ƒç»§æ‰¿å…³ç³»](#3-æ ¸å¿ƒç»§æ‰¿å…³ç³»)
4. [å…³é”®è°ƒç”¨æµç¨‹](#4-å…³é”®è°ƒç”¨æµç¨‹)
5. [æ¨¡å—ä¾èµ–çŸ©é˜µ](#5-æ¨¡å—ä¾èµ–çŸ©é˜µ)
6. [å®šä»·å¼•æ“é€‰æ‹©](#6-å®šä»·å¼•æ“é€‰æ‹©)
7. [è®¾è®¡æ¨¡å¼åº”ç”¨](#7-è®¾è®¡æ¨¡å¼åº”ç”¨)
8. [å…³é”®æµç¨‹æ—¶åºå›¾](#8-å…³é”®æµç¨‹æ—¶åºå›¾)
9. [éƒ¨ç½²ä¸ç¯å¢ƒæ‹“æ‰‘](#9-éƒ¨ç½²ä¸ç¯å¢ƒæ‹“æ‰‘)

---

## 1. æ•´ä½“æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚ (Frontend)                        â”‚
â”‚              Web DApp / é’±åŒ… / EIP-712 ç­¾å                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¸‚åœºæ¨¡æ¿å±‚ (7 ç§ç©æ³•)                         â”‚
â”‚  WDL â”‚ OU â”‚ AH â”‚ OddEven â”‚ Score â”‚ PlayerProps â”‚ OU_MultiLine   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ ç»§æ‰¿
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MarketBase_V2 (æ ¸å¿ƒåŸºç±»)                      â”‚
â”‚     çŠ¶æ€æœº â”‚ ERC1155å¤´å¯¸ â”‚ ä¸‹æ³¨/èµå› â”‚ è´¹ç”¨æ‰£é™¤ â”‚ Vaulté›†æˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚            â”‚            â”‚            â”‚
       â–¼            â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pricing  â”‚ â”‚  Oracle   â”‚ â”‚ FeeRouterâ”‚ â”‚ LiquidityVaultâ”‚
â”‚ Engine   â”‚ â”‚           â”‚ â”‚          â”‚ â”‚  (ERC4626)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mermaid åˆ†å±‚æ¶æ„å›¾

```mermaid
flowchart TB
    subgraph L1["ğŸ¯ ç”¨æˆ·å±‚ (Frontend)"]
        direction LR
        WebApp["Web DApp"]
        Wallet["é’±åŒ… / EIP-712"]
        SDK["SDK / API"]
    end

    subgraph L2["ğŸ“Š å¸‚åœºæ¨¡æ¿å±‚ (7 ç§ç©æ³•)"]
        direction LR
        WDL["WDL<br/>èƒœå¹³è´Ÿ"]
        OU["OU<br/>å¤§å°çƒ"]
        AH["AH<br/>è®©çƒ"]
        OddEven["OddEven<br/>å•åŒ"]
        Score["Score<br/>æ¯”åˆ†"]
        PlayerProps["PlayerProps<br/>çƒå‘˜é“å…·"]
        OUMulti["OU_MultiLine<br/>å¤šçº¿å¤§å°çƒ"]
    end

    subgraph L3["âš™ï¸ æ ¸å¿ƒåŸºç±»å±‚"]
        MarketBase["MarketBase_V2<br/>çŠ¶æ€æœº | ERC1155 | ä¸‹æ³¨/èµå›"]
    end

    subgraph L4["ğŸ”§ åŸºç¡€è®¾æ–½å±‚"]
        direction LR
        subgraph Pricing["å®šä»·å¼•æ“"]
            CPMM["SimpleCPMM"]
            LMSR["LMSR"]
            Parimutuel["Parimutuel"]
            LinkedLines["LinkedLines"]
        end
        subgraph Liquidity["æµåŠ¨æ€§ç®¡ç†"]
            Vault["ERC4626<br/>LiquidityVault"]
            ParimutuelLP["Parimutuel<br/>Provider"]
        end
        subgraph Oracle["é¢„è¨€æœº"]
            UMA["UMA OO<br/>Adapter"]
            MockOracle["Mock<br/>Oracle"]
        end
        subgraph Fees["è´¹ç”¨è·¯ç”±"]
            FeeRouter["FeeRouter"]
            Referral["Referral<br/>Registry"]
        end
    end

    subgraph L5["ğŸ® æ‰©å±•åŠŸèƒ½å±‚"]
        direction LR
        subgraph Parlay["ä¸²å…³ç³»ç»Ÿ"]
            Basket["Basket"]
            CorrelationGuard["Correlation<br/>Guard"]
        end
        subgraph Growth["è¿è¥å¢é•¿"]
            Campaign["Campaign"]
            Quest["Quest"]
            Rewards["Rewards<br/>Distributor"]
        end
        subgraph Tokens["ä»£å¸å‡­è¯"]
            Credit["CreditToken"]
            Coupon["Coupon"]
        end
        subgraph Gov["æ²»ç†"]
            ParamCtrl["Param<br/>Controller"]
        end
    end

    subgraph L6["ğŸ–¥ï¸ é“¾ä¸‹æœåŠ¡å±‚ (Go)"]
        direction LR
        Indexer["Indexer"]
        Keeper["Keeper"]
        RewardsBuilder["Rewards<br/>Builder"]
        RiskWorker["Risk<br/>Worker"]
    end

    subgraph L7["ğŸ“ˆ æ•°æ®å±‚"]
        direction LR
        Subgraph["The Graph<br/>Subgraph"]
        DB[("Postgres<br/>Timescale")]
        Grafana["Grafana"]
    end

    %% è¿æ¥å…³ç³»
    L1 --> L2
    L2 --> L3
    L3 --> L4
    L3 --> L5
    L4 --> L6
    L5 --> L6
    L6 --> L7
    L7 --> L1

    %% æ ·å¼
    classDef userLayer fill:#e1f5fe,stroke:#01579b
    classDef templateLayer fill:#f3e5f5,stroke:#7b1fa2
    classDef coreLayer fill:#fff3e0,stroke:#e65100
    classDef infraLayer fill:#e8f5e9,stroke:#2e7d32
    classDef extLayer fill:#fce4ec,stroke:#c2185b
    classDef offchainLayer fill:#e3f2fd,stroke:#1565c0
    classDef dataLayer fill:#f5f5f5,stroke:#616161

    class L1 userLayer
    class L2 templateLayer
    class L3 coreLayer
    class L4 infraLayer
    class L5 extLayer
    class L6 offchainLayer
    class L7 dataLayer
```

### Mermaid ç³»ç»Ÿæ‹“æ‰‘å›¾

```mermaid
flowchart LR
  subgraph Client["å‰ç«¯/é’±åŒ…ä¾§"]
    UI["Web DApp<br/>å¸‚åœºæµè§ˆ/ä¸‹æ³¨/ä¸²å…³/é¢†å–"]
    Wallet["é’±åŒ…/EIP-712<br/>å¯é€‰4337ä»£ä»˜"]
  end

  subgraph Onchain["é“¾ä¸Šæ ¸å¿ƒ"]
    Factory["MarketFactory<br/>å¸‚åœºåˆ›å»º"]
    Base["MarketBase ERC-1155<br/>WDL/OU/AH/æ¯”åˆ† æ¨¡æ¿"]
    AMM["CPMM/LMSR åšå¸‚"]
    Basket["Parlay Basket<br/>+ CorrelationGuard"]
    Fee["FeeRouter<br/>LP/Promo/Insurance/Treasury"]
    Param["ParamController<br/>+ Timelock + Governor"]
    Growth["ReferralRegistry / RewardsDistributor<br/>CampaignFactory / Credit&Coupon"]
    Oracle["ResultOracle Optimistic<br/>UMA OO é€‚é…"]
    Vault["Vaults ERC-4626"]
  end

  subgraph Offchain["é“¾ä¸‹æœåŠ¡ - Go"]
    Indexer["Indexer<br/>äº‹ä»¶â†’Postgres/Timescale"]
    Keeper["Keeper Service<br/>é”ç›˜/äº‰è®®çª—å£/å‘å¸ƒRoot"]
    Rewards["Rewards Builder<br/>å‘¨åº¦Merkleèšåˆä¸Šé“¾"]
    Risk["Risk & Pricing Worker<br/>çº¿è”åŠ¨/ç›¸å…³æ€§/é™é¢å»ºè®®"]
    API["åªè¯» API Gateway"]
  end

  subgraph DataObs["æ•°æ®ä¸å¯è§‚æµ‹"]
    Subgraph["The Graph Subgraph"]
    DB[("Postgres/Timescale")]
    Graf["Grafana/Prom/OTel"]
    TenderlyNode["Tenderly/Forta"]
  end

  subgraph DevOps["DevOps & å®‰å…¨"]
    CI["GitHub Actions<br/>Foundry/Slither/Echidna/Tenderly"]
    IaC["Terraform + Helm + K8s"]
    VaultKMS["Safe å¤šç­¾ / Vault-KMS"]
  end

  UI --"EIP-712/Tx"--> Base
  UI --"æŸ¥è¯¢/èšåˆ"--> Subgraph
  Subgraph --"ç´¢å¼•äº‹ä»¶"--> DataObs
  Base <--"ç»“ç®—äº‹å®"--> Oracle
  Base --"è´¹ç”¨"--> Fee
  Base --"SFTå¤´å¯¸"--> Wallet
  Base --"LP"--> Vault
  Basket --- Base
  Growth --- Base
  Param --- Base

  Indexer --> DB
  Keeper --> Oracle
  Keeper --> Base
  Rewards --> Growth
  Risk --> Param
  API --> UI
  CI --> Onchain
  CI --> Offchain
  IaC --> Offchain
  IaC --> DataObs
  VaultKMS --> CI
```

---

## 2. åˆçº¦æ¨¡å—æ¦‚è§ˆ

**æ€»è®¡ 44 ä¸ª Solidity æ–‡ä»¶**ï¼Œåˆ†ç±»å¦‚ä¸‹ï¼š

| ç±»åˆ« | æ•°é‡ | ä¸»è¦æ–‡ä»¶ |
|------|------|---------|
| æ ¸å¿ƒæ¨¡å— | 7 | MarketBase_V2, Factory, FeeRouter ç­‰ |
| å¸‚åœºæ¨¡æ¿ | 7 | 7 ç§ç©æ³• (V2 ç‰ˆæœ¬) |
| å®šä»·å¼•æ“ | 5 | SimpleCPMM, LMSR, Parimutuel, LinkedLinesController |
| æµåŠ¨æ€§ç®¡ç† | 4 | LiquidityVault, ERC4626LP, ParimutuelLP, Factory |
| ä¸²å…³ç³»ç»Ÿ | 2 | Basket, CorrelationGuard |
| é¢„è¨€æœº | 2 | MockOracle, UMAOptimisticOracleAdapter |
| è¿è¥å·¥å…· | 4 | Campaign, Quest, PayoutScaler, RewardsDistributor |
| æ²»ç† | 1 | ParamController |
| ä»£å¸å‡­è¯ | 2 | CreditToken, Coupon |
| æ¥å£å®šä¹‰ | 13 | IMarket, IPricingEngine, IResultOracle ç­‰ |
| åº“/å·¥å…· | 1 | ScoreMarketLib |

### ç›®å½•ç»“æ„

```
contracts/src/
â”œâ”€â”€ core/                       # æ ¸å¿ƒåŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ MarketBase_V2.sol       # å¸‚åœºåŸºç±»ï¼ˆç”Ÿäº§ç‰ˆï¼‰
â”‚   â”œâ”€â”€ MarketFactory_v2.sol    # Clone å·¥å‚
â”‚   â”œâ”€â”€ MarketTemplateRegistry.sol # æ¨¡æ¿æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ FeeRouter.sol           # è´¹ç”¨è·¯ç”±åˆ†é…
â”‚   â”œâ”€â”€ RewardsDistributor.sol  # Merkle å¥–åŠ±åˆ†å‘
â”‚   â””â”€â”€ ReferralRegistry.sol    # æ¨èå…³ç³»ç®¡ç†
â”‚
â”œâ”€â”€ templates/                  # 7 ç§å¸‚åœºæ¨¡æ¿ (V2)
â”‚   â”œâ”€â”€ WDL_Template_V2.sol     # èƒœå¹³è´Ÿ
â”‚   â”œâ”€â”€ OU_Template_V2.sol      # å¤§å°çƒå•çº¿
â”‚   â”œâ”€â”€ OU_MultiLine_V2.sol     # å¤§å°çƒå¤šçº¿
â”‚   â”œâ”€â”€ AH_Template_V2.sol      # è®©çƒ
â”‚   â”œâ”€â”€ OddEven_Template_V2.sol # å•åŒ
â”‚   â”œâ”€â”€ ScoreTemplate_V2.sol    # ç²¾ç¡®æ¯”åˆ†
â”‚   â””â”€â”€ PlayerProps_Template_V2.sol # çƒå‘˜é“å…·
â”‚
â”œâ”€â”€ pricing/                    # å®šä»·å¼•æ“
â”‚   â”œâ”€â”€ SimpleCPMM.sol          # è™šæ‹Ÿå‚¨å¤‡ AMM
â”‚   â”œâ”€â”€ LMSR.sol                # å¯¹æ•°å¸‚åœºè¯„åˆ†è§„åˆ™
â”‚   â”œâ”€â”€ LMSR_Optimized.sol      # LMSR ä¼˜åŒ–ç‰ˆ
â”‚   â”œâ”€â”€ LinkedLinesController.sol    # å¤šçº¿è”åŠ¨æ§åˆ¶
â”‚   â”œâ”€â”€ LinkedLinesController_Optimized.sol
â”‚   â””â”€â”€ ParimutuelPricing.sol   # å½©æ± å®šä»·
â”‚
â”œâ”€â”€ liquidity/                  # æµåŠ¨æ€§ç®¡ç†
â”‚   â”œâ”€â”€ LiquidityVault.sol      # ERC4626 é‡‘åº“
â”‚   â”œâ”€â”€ ERC4626LiquidityProvider.sol
â”‚   â”œâ”€â”€ ParimutuelLiquidityProvider.sol
â”‚   â””â”€â”€ LiquidityProviderFactory.sol
â”‚
â”œâ”€â”€ parlay/                     # ä¸²å…³ç³»ç»Ÿ
â”‚   â”œâ”€â”€ Basket.sol              # ä¸²å…³ç»„åˆåˆçº¦
â”‚   â””â”€â”€ CorrelationGuard.sol    # ç›¸å…³æ€§å®ˆå«
â”‚
â”œâ”€â”€ oracle/                     # é¢„è¨€æœº
â”‚   â”œâ”€â”€ MockOracle.sol          # æµ‹è¯•é¢„è¨€æœº
â”‚   â””â”€â”€ UMAOptimisticOracleAdapter.sol # UMA OO é€‚é…å™¨
â”‚
â”œâ”€â”€ growth/                     # è¿è¥å·¥å…·
â”‚   â”œâ”€â”€ Campaign.sol            # æ´»åŠ¨å·¥å‚
â”‚   â”œâ”€â”€ Quest.sol               # ä»»åŠ¡ç³»ç»Ÿ
â”‚   â””â”€â”€ PayoutScaler.sol        # é¢„ç®—ç¼©æ”¾
â”‚
â”œâ”€â”€ governance/                 # æ²»ç†
â”‚   â””â”€â”€ ParamController.sol     # å‚æ•°æ§åˆ¶å™¨
â”‚
â”œâ”€â”€ tokens/                     # ä»£å¸å‡­è¯
â”‚   â”œâ”€â”€ CreditToken.sol         # å…ä½£åˆ¸
â”‚   â””â”€â”€ Coupon.sol              # èµ”ç‡åŠ æˆåˆ¸
â”‚
â”œâ”€â”€ interfaces/                 # æ¥å£å®šä¹‰ï¼ˆ13ä¸ªï¼‰
â”‚   â”œâ”€â”€ IMarket.sol
â”‚   â”œâ”€â”€ IPricingEngine.sol
â”‚   â”œâ”€â”€ IResultOracle.sol
â”‚   â”œâ”€â”€ ILiquidityProvider.sol
â”‚   â”œâ”€â”€ IBasket.sol
â”‚   â”œâ”€â”€ ICorrelationGuard.sol
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ libraries/                  # å·¥å…·åº“
    â””â”€â”€ ScoreMarketLib.sol
```

---

## 3. æ ¸å¿ƒç»§æ‰¿å…³ç³»

### 3.1 å¸‚åœºåŸºç¡€ç±»ç»§æ‰¿æ ‘

```
IMarket (æ¥å£)
    â”‚
    â””â”€ MarketBase_V2 (ç”Ÿäº§ç‰ˆ - é›†æˆ LiquidityVault)
        â”œâ”€ WDL_Template_V2      # èƒœå¹³è´Ÿ
        â”œâ”€ OU_Template_V2       # å¤§å°çƒå•çº¿
        â”œâ”€ AH_Template_V2       # è®©çƒ (+ IAH_Template æ¥å£)
        â”œâ”€ OddEven_Template_V2  # å•åŒ
        â”œâ”€ ScoreTemplate_V2     # ç²¾ç¡®æ¯”åˆ†
        â”œâ”€ PlayerProps_Template_V2  # çƒå‘˜é“å…·
        â””â”€ OU_MultiLine_V2      # å¤šçº¿å¤§å°çƒ
```

**V2 æ¶æ„ç‰¹ç‚¹ï¼š**
- å¤–éƒ¨ Vault é›†æˆï¼Œå¸‚åœºä» LiquidityVault å€Ÿå‡ºåˆå§‹æµåŠ¨æ€§
- ç»“ç®—åå½’è¿˜æœ¬é‡‘+æ”¶ç›Šç»™ LP
- Clone æ¨¡å¼éƒ¨ç½²ï¼ŒèŠ‚çœ Gas

### 3.2 å®šä»·å¼•æ“ç»§æ‰¿æ ‘

```
IPricingEngine (æ¥å£)
    â”‚
    â”œâ”€ SimpleCPMM          # è™šæ‹Ÿå‚¨å¤‡ CPMMï¼ˆç”¨äº WDL/OU/AH/OddEvenï¼‰
    â”œâ”€ LMSR                # å¯¹æ•°å¸‚åœºè¯„åˆ†è§„åˆ™ï¼ˆç”¨äº Score/PlayerPropsï¼‰
    â”œâ”€ LMSR_Optimized      # æ€§èƒ½ä¼˜åŒ–ç‰ˆ
    â””â”€ ParimutuelPricing   # å½©æ± æ¨¡å¼å®šä»·

LinkedLinesController      # å¤šçº¿è”åŠ¨æ§åˆ¶å™¨ï¼ˆç”¨äº OU_MultiLineï¼‰
```

### 3.3 æµåŠ¨æ€§ç®¡ç†ä½“ç³»

```
LiquidityVault (ERC4626)
    â”‚
    â”œâ”€ æ ¸å¿ƒèŒè´£ï¼šLP å­˜å…¥ USDCï¼Œè·å¾— Vault Shares
    â”œâ”€ å€Ÿè´·ç®¡ç†ï¼šå¸‚åœºå¯ borrow/repay
    â””â”€ é™åˆ¶æ¡ä»¶ï¼š
        â”œâ”€ æœ€å¤§åˆ©ç”¨ç‡ 90%
        â”œâ”€ å•å¸‚åœºæœ€å¤§å€Ÿæ¬¾ 50% of totalAssets
        â””â”€ æ¯ç¬”å€Ÿæ¬¾éƒ½æœ‰ borrowed è®°å½•

ILiquidityProvider (æ¥å£)
    â”‚
    â”œâ”€ ERC4626LiquidityProvider (å®ç°)
    â”œâ”€ ParimutuelLiquidityProvider (å½©æ± æ¨¡å¼)
    â””â”€ MockLiquidityProvider (æµ‹è¯•)
```

### 3.4 ä¸²å…³ç³»ç»Ÿ

```
ICorrelationGuard (æ¥å£)
    â””â”€ CorrelationGuard (+ Ownable, AccessControl)
        â””â”€ ç”± Basket è°ƒç”¨æ£€æŸ¥ç›¸å…³æ€§
        â””â”€ ä¸‰ç§ç­–ç•¥ï¼šALLOW_ALL / PENALTY / STRICT_BLOCK

IBasket (æ¥å£)
    â””â”€ Basket (+ Ownable, IERC1155Receiver)
        â”œâ”€ æ”¯æŒ 2-10 è…¿ç»„åˆ
        â”œâ”€ æ± åŒ–èµ„é‡‘æ¨¡å¼
        â””â”€ é›†æˆç›¸å…³æ€§å®ˆå«
```

### 3.5 é¢„è¨€æœºä½“ç³»

```
IResultOracle (æ¥å£)
    â”‚
    â”œâ”€ MockOracle (æµ‹è¯•é¢„è¨€æœº)
    â””â”€ UMAOptimisticOracleAdapter
        â””â”€ é€‚é… UMA Optimistic Oracle V3
        â””â”€ æµç¨‹ï¼šPropose â†’ Liveness â†’ Settle â†’ Finalize
```

### 3.6 è¿è¥å’Œæ²»ç†

```
Campaign (æ´»åŠ¨å·¥å‚)
    â””â”€ å…³è” Quest (ä»»åŠ¡ç³»ç»Ÿ)

Quest (ä»»åŠ¡)
    â”œâ”€ 5 ç§ä»»åŠ¡ç±»å‹ï¼šä¸‹æ³¨/æ¨è/ä¸²å…³/è¿ç»­ç™»å½•/ç¤¾äº¤
    â””â”€ æƒé™æ§åˆ¶ï¼šADMIN_ROLE, OPERATOR_ROLE

ParamController (å‚æ•°æ²»ç†)
    â”œâ”€ Timelock æœºåˆ¶
    â”œâ”€ å‚æ•°éªŒè¯å™¨
    â””â”€ ç´§æ€¥æš‚åœåŠŸèƒ½

FeeRouter (è´¹ç”¨è·¯ç”±)
    â”œâ”€ åˆ†é…åˆ°ï¼šLP (70%), Promo (10%), Insurance (10%), Treasury (10%)
    â””â”€ é›†æˆ ReferralRegistry æ¨èè¿”ä½£

RewardsDistributor (å‘¨åº¦ Merkle å¥–åŠ±)
```

---

## 4. å…³é”®è°ƒç”¨æµç¨‹

### 4.1 ä¸‹æ³¨æµç¨‹

```
ç”¨æˆ· â†’ Market.placeBet(outcome, amount)
         â”‚
         â”œâ”€â†’ IPricingEngine.calculateShares()   // è®¡ç®—ä»½é¢
         â”œâ”€â†’ IERC20.transferFrom(user, market)  // æ”¶å–æœ¬é‡‘
         â”œâ”€â†’ _mint(user, tokenId, shares)       // é“¸é€  ERC1155
         â””â”€â†’ FeeRouter.routeFee(feeAmount)      // è´¹ç”¨åˆ†é…
                    â”‚
                    â”œâ”€â†’ ReferralRegistry.getReferrer() // æŸ¥æ¨èäºº
                    â””â”€â†’ åˆ†é…åˆ° LP/Promo/Insurance/Treasury
```

### 4.2 æµåŠ¨æ€§å€Ÿè´· (V2)

```
MarketFactory.createMarket()
         â”‚
         â””â”€â†’ LiquidityVault.borrow(initialLiquidity)
                    â”‚
                    â”œâ”€â†’ æ£€æŸ¥åˆ©ç”¨ç‡ â‰¤ 90%
                    â”œâ”€â†’ borrowed[market] += amount
                    â””â”€â†’ USDC.transfer(market, amount)

Market.resolve() ç»“ç®—æ—¶
         â”‚
         â””â”€â†’ LiquidityVault.repay(principal, revenue)
                    â”‚
                    â”œâ”€â†’ borrowed[market] -= principal
                    â””â”€â†’ æ”¶ç›Šåˆ†é…ç»™ LP shareholders
```

### 4.3 é¢„è¨€æœºç»“ç®—

```
Keeper â†’ UMAAdapter.proposeResult(matchFacts)
                â”‚
                â”œâ”€â†’ UMA OO V3.assertTruth(claim, bond)
                â””â”€â†’ è¿›å…¥ 2h äº‰è®®çª—å£
                         â”‚
                         â–¼ (æ— äº‰è®®)
         Market.resolve(winningOutcome)
                â”‚
                â”œâ”€â†’ status = Resolved
                â””â”€â†’ ç”¨æˆ·å¯ redeem()
```

### 4.4 ä¸²å…³ç»„åˆ

```
ç”¨æˆ· â†’ Basket.createParlay([markets], [outcomes], stake)
         â”‚
         â”œâ”€â†’ CorrelationGuard.checkBlocked()    // ç›¸å…³æ€§æ£€æŸ¥
         â”‚        â”‚
         â”‚        â””â”€â†’ åŒåœºåŒå‘ â†’ PENALTY æˆ– BLOCK
         â”‚
         â”œâ”€â†’ è®¡ç®—ç»„åˆèµ”ç‡ = âˆ(å•åœºèµ”ç‡) Ã— æŠ˜æ‰£
         â””â”€â†’ USDC.transferFrom(user, basket)

æ‰€æœ‰å¸‚åœºç»“ç®—å â†’ Basket.redeem(parlayId)
         â”‚
         â”œâ”€â†’ å…¨ä¸­ â†’ å‘æ”¾ stake Ã— combinedOdds
         â””â”€â†’ ä»»ä¸€é”™ â†’ æœ¬é‡‘ç•™åœ¨æ± ä¸­
```

---

## 5. æ¨¡å—ä¾èµ–çŸ©é˜µ

### 5.1 åˆçº¦é—´ä¾èµ–

| æ¨¡å— | ä¾èµ– | è¢«ä¾èµ– |
|------|------|--------|
| **MarketBase_V2** | Pricing, Vault, Oracle, FeeRouter | æ‰€æœ‰æ¨¡æ¿ |
| **SimpleCPMM** | - | WDL, OU, AH, OddEven, OU_MultiLine |
| **LMSR** | - | Score, PlayerProps |
| **LiquidityVault** | USDC | Market, Factory |
| **FeeRouter** | ReferralRegistry | Market |
| **Basket** | CorrelationGuard, Market | - |
| **UMAAdapter** | UMA OO V3 | Market |

### 5.2 æ¨¡æ¿åŠŸèƒ½çŸ©é˜µ

| æ¨¡æ¿ | Vault | Pricing | Oracle | Basket | Event |
|------|:-----:|:-------:|:------:|:------:|:-----:|
| WDL_V2 | âœ“ | CPMM | âœ“ | âœ“ | âœ“ |
| OU_V2 | âœ“ | CPMM | âœ“ | âœ“ | âœ“ |
| OU_MultiLine_V2 | âœ“ | CPMM+LinkedLines | âœ“ | âœ“ | âœ“ |
| AH_V2 | âœ“ | CPMM | âœ“ | âœ“ | âœ“ |
| OddEven_V2 | âœ“ | CPMM | âœ“ | âœ“ | âœ“ |
| ScoreTemplate_V2 | âœ“ | LMSR | âœ“ | âœ“ | âœ“ |
| PlayerProps_V2 | âœ“ | LMSR | âœ“ | âœ“ | âœ“ |

---

## 6. å®šä»·å¼•æ“é€‰æ‹©

| å¸‚åœºç±»å‹ | å®šä»·å¼•æ“ | ç»“æœæ•° | ç‰¹ç‚¹ |
|---------|---------|--------|------|
| **WDL** (èƒœå¹³è´Ÿ) | SimpleCPMM | 3 | è™šæ‹Ÿå‚¨å¤‡ AMMï¼Œä¸‰å‘å¸‚åœº |
| **OU** (å¤§å°çƒ) | SimpleCPMM | 2 | äºŒå‘å¸‚åœºï¼Œå« Push é€€æ¬¾ |
| **AH** (è®©çƒ) | SimpleCPMM | 2/3 | åŠçƒç›˜äºŒå‘ï¼Œæ•´çƒç›˜ä¸‰å‘ |
| **OddEven** (å•åŒ) | SimpleCPMM | 2 | äºŒå‘å¸‚åœºï¼Œå¥‡å¶åˆ¤æ–­ |
| **OU_MultiLine** | SimpleCPMM + LinkedLines | å¤šçº¿ | ç›¸é‚»çº¿è”åŠ¨å®šä»· |
| **Score** (æ¯”åˆ†) | LMSR | 25-100 | å¤šç»“æœå¯¹æ•°å®šä»· |
| **PlayerProps** | LMSR | å¤šå‘ | çƒå‘˜é“å…·ï¼Œæ”¯æŒå¤šç§ prop ç±»å‹ |

### å®šä»·å¼•æ“å¯¹æ¯”

| ç‰¹æ€§ | SimpleCPMM | LMSR | Parimutuel |
|------|-----------|------|------------|
| ç»“æœæ•° | 2-3 | 3-100+ | ä¸é™ |
| åˆå§‹æµåŠ¨æ€§ | éœ€è¦ | éœ€è¦ | ä¸éœ€è¦ |
| èµ”ç‡è®¡ç®— | å®æ—¶ | å®æ—¶ | ç»“ç®—æ—¶ |
| æ»‘ç‚¹ | æœ‰ | æœ‰ | æ—  |
| é€‚ç”¨åœºæ™¯ | WDL/OU/AH | æ¯”åˆ†/é¦–çƒè€… | ä¼ ç»Ÿå½©æ±  |

---

## 7. è®¾è®¡æ¨¡å¼åº”ç”¨

### 7.1 ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- **åº”ç”¨**ï¼š`IPricingEngine` æ¥å£æ”¯æŒå¤šç§å®šä»·ç­–ç•¥
- **å®ç°**ï¼šSimpleCPMMã€LMSRã€ParimutuelPricing å®ç°åŒä¸€æ¥å£

### 7.2 å·¥å‚æ¨¡å¼ (Factory Pattern)
- **åº”ç”¨**ï¼š`MarketFactory_v3` ä½¿ç”¨ Clone åˆ›å»ºå¸‚åœºå®ä¾‹
- **ä¼˜åŠ¿**ï¼šé™ä½éƒ¨ç½² Gasï¼ˆ-69%ï¼‰ï¼Œç»Ÿä¸€å¸‚åœºç®¡ç†

### 7.3 é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)
- **åº”ç”¨**ï¼š`UMAOptimisticOracleAdapter` é€‚é… UMA OO V3
- **ä½œç”¨**ï¼šå±è”½å¤–éƒ¨é¢„è¨€æœºå®ç°ç»†èŠ‚

### 7.4 å®ˆå«æ¨¡å¼ (Guard Pattern)
- **åº”ç”¨**ï¼š`CorrelationGuard` ä¸²å…³ç›¸å…³æ€§æ£€æŸ¥
- **åº”ç”¨**ï¼š`ParamController` å‚æ•°éªŒè¯

### 7.5 ä»£ç†æ¨¡å¼ (Proxy Pattern)
- **åº”ç”¨**ï¼šå¯å‡çº§åˆçº¦åŸºç¡€è®¾æ–½
- **å®ç°**ï¼šClone proxy ç”¨äºå¸‚åœºå®ä¾‹åŒ–

---

## 8. å…³é”®æµç¨‹æ—¶åºå›¾

### 8.1 ä¸‹æ³¨/åšå¸‚æµç¨‹

```mermaid
sequenceDiagram
  actor U as User
  participant UI as DApp
  participant M as Market (æ¨¡æ¿åˆçº¦)
  participant AMM as AMM(CPMM/LMSR)
  participant Fee as FeeRouter
  participant Sub as Subgraph

  U->>UI: é€‰æ‹©å¸‚åœº/ç›˜å£/é‡‘é¢
  UI->>M: quoteBuy(outcome, stake)
  M->>AMM: ä»·æ ¼/æ»‘ç‚¹è®¡ç®—
  AMM-->>M: price, fee, slippage
  UI->>M: buy(..., minOut, referrer, campaignId) (EIP-712/Tx)
  M->>AMM: æ›´æ–°å‚¨å¤‡/å¤´å¯¸
  M->>Fee: route(fee)
  M-->>UI: BetPlaced äº‹ä»¶ï¼ˆå« referrer/campaignIdï¼‰
  M-->>Sub: BetPlaced / LiquidityChanged
```

### 8.2 é”ç›˜ä¸ç»“æœç»“ç®—

```mermaid
sequenceDiagram
  participant Keeper as Keeper Service
  participant M as Market
  participant OO as ResultOracle(UMA OO)
  participant Gov as Timelock/Governor(ä»²è£ç»ˆå±€)
  participant Sub as Subgraph

  Note over Keeper: å¼€èµ›å‰10åˆ†é’Ÿ lock()
  Keeper->>M: lock()
  M-->>Sub: Locked

  Note over OO,M: ç»ˆåœºå propose â†’ dispute â†’ resolve
  Keeper->>OO: propose(marketId, MatchFacts, bond)
  alt æœ‰å¼‚è®®
    Keeper->>OO: dispute(marketId)
    OO->>Gov: ä»²è£è£å†³
  end
  OO->>M: finalize/resolve(facts)
  M-->>Sub: Resolved(winnerOutcome, factsHash)
```

### 8.3 å‘¨åº¦å‘å¥–æµç¨‹

```mermaid
sequenceDiagram
  participant Indexer as Indexer
  participant R as Rewards Builder
  participant RD as RewardsDistributor
  participant U as User

  Indexer->>R: æ‹‰å–Bet/Referral/Questäº‹ä»¶
  R->>R: èšåˆ & é¢„ç®—ç¼©æ”¾(scaleBps)
  R->>RD: publish(week, root, scaleBps)
  U->>RD: claim(week, amount, proof)
```

### 8.4 å‚æ•°ç°åº¦ä¸‹å‘

```mermaid
sequenceDiagram
  participant Risk as Risk&PricingWorker
  participant Param as ParamController+Timelock
  participant M as Market

  Risk->>Param: queue(key,value,eta)
  Note over Param: Timelock åˆ°ç‚¹
  Param->>Param: apply(key)
  Param-->>M: æ–°å‚æ•°ç”Ÿæ•ˆï¼ˆå¦‚ linkCoeff/é™é¢/fee é˜¶æ¢¯ï¼‰
```

---

## 9. éƒ¨ç½²ä¸ç¯å¢ƒæ‹“æ‰‘

### 9.1 ç½‘ç»œä¸ç¯å¢ƒ

| ç¯å¢ƒ | ç½‘ç»œ | ç”¨é€” |
|------|------|------|
| dev | Anvil (æœ¬åœ°) | å¼€å‘æµ‹è¯• |
| testnet | Arbitrum Sepolia | é›†æˆæµ‹è¯• |
| staging | Arbitrum Sepolia | é¢„å‘å¸ƒéªŒè¯ |
| prod | Arbitrum One | ç”Ÿäº§ç¯å¢ƒ |

### 9.2 æƒé™ä½“ç³»

- **èµ„é‡‘æ“ä½œ**ï¼šSafe å¤šç­¾ï¼ˆæš‚åœã€ç´§æ€¥ææ¬¾ï¼‰
- **å‚æ•°è°ƒæ•´**ï¼šGovernor + Timelockï¼ˆè´¹ç‡ã€é™é¢ã€æ¨¡æ¿ï¼‰
- **æ—¥å¸¸è¿ç»´**ï¼šKeeper Serviceï¼ˆé”ç›˜ã€ç»“ç®—ã€å¥–åŠ±å‘å¸ƒï¼‰

### 9.3 è‡ªåŠ¨åŒ–

- **ä¸»è¦**ï¼šè‡ªå»º Keeper Serviceï¼ˆGoï¼‰
- **å†—ä½™**ï¼šGelato / Chainlink Automation

### 9.4 å¯è§‚æµ‹æ€§

- **é“¾ä¸Š**ï¼šTenderly å›æ”¾ã€Forta Agent ç›‘æ§
- **é“¾ä¸‹**ï¼šOTel åŸ‹ç‚¹ã€Prometheus + Grafana ä»ªè¡¨ç›˜
- **æ•°æ®**ï¼šThe Graph Subgraphã€Postgres/Timescale

### 9.5 CI/CD

- **åˆçº¦æµ‹è¯•**ï¼šFoundry test + coverage
- **é™æ€åˆ†æ**ï¼šSlither
- **ä¸å˜é‡æµ‹è¯•**ï¼šEchidna
- **ä»¿çœŸ**ï¼šTenderly
- **éƒ¨ç½²**ï¼šFoundry script + Safe å¤šç­¾

---

## é™„å½•ï¼šç‰ˆæœ¬æ¼”è¿›

| ç‰ˆæœ¬ | ç‰¹æ€§ | çŠ¶æ€ |
|------|------|------|
| V1 | å†…éƒ¨ LPï¼Œå¸‚åœºè€¦åˆ | å·²åˆ é™¤ (2025-12-06) |
| V2 | å¤–éƒ¨ Vaultï¼Œæ¸…æ™°èµ„é‡‘æµï¼ŒClone éƒ¨ç½² | å½“å‰ç”Ÿäº§ç‰ˆ âœ“ |

---

## ç›¸å…³æ–‡æ¡£

- [MarketBase è®¾è®¡](./01_MarketBase.md)
- [AMM ä¸è”åŠ¨å®šä»·](./02_AMM_LinkedLines.md)
- [é¢„è¨€æœºé›†æˆ](./03_ResultOracle_OO.md)
- [ä¸²å…³ä¸ç›¸å…³æ€§](./04_Parlay_CorrelationGuard.md)
- [è´¹ç”¨ä¸é‡‘åº“](./05_FeeRouter_Vault.md)
- [å¥–åŠ±ä¸æ¨è](./06_Rewards_Referral_Campaign.md)
- [å‚æ•°æ²»ç†](./07_ParamController_Governance.md)
- [å¸‚åœºç±»å‹æ€»è§ˆ](./MARKET_TYPES_OVERVIEW.md)
