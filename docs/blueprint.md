下面给出一套**去中心化、尽量零人工干预**的链上足球博彩（Sportsbook / Prediction Markets）架构与设计蓝图（不涉及代码）。重点围绕：全链上结算、可组合 AMM、去中心化预言机 + 争议仲裁、资金与风控自动化、可扩展与低成本结算。

---

# 一、核心目标与原则

* **全流程上链**：市场创建、下注、流动性提供、赔率形成、赛果上报/仲裁、清算/赔付，全部通过智能合约完成。
* **最小信任与最小人工**：依赖去中心化预言机与“乐观式（optimistic）”争议机制，避免中心化裁判。
* **可组合**：Outcome 头寸（胜/平/负）用可转让的 ERC-1155/20 表示，可在 DEX/AMM 交易、可抵押、可打包串关。
* **可扩展与低 gas**：批量结算、Merkle 证明提款、L2 优先部署、异步 keeper 自动执行。
* **清晰规则**：延赛/腰斩/加时/点球等边界情况写入规则合约，避免“人治”。

---

# 二、关键合约与组件

1. **LeagueRegistry & MatchFactory（联赛/赛事注册与工厂）**

* 由去中心化治理（DAO）增删联赛白名单、数据模板与规则版本。
* `createMatch()` 按赛程表创建单场比赛市场（“主胜/平/客胜”3 路，或含加时/点球的多路），记录开赛时间、锁仓时间、规则版本哈希、数据源标识等元数据（存 IPFS/Arweave，链上存 content hash）。

2. **Market (比赛市场合约，ERC-1155 头寸)**

* 为每个比赛部署 1 份 Market，铸造 3 个Outcome Token（例如：ID=0主胜、1平、2客胜）。
* 市场状态机：`Pending -> Open -> Locked -> Resolved -> Claimable/Refundable`。
* **下注方式**：

  * **AMM 型**：内置定价（见下节），用户用稳定币买入某一 Outcome 份额；
  * **LP 提供流动性**：单边/多边注入，赚取交易费与隐含赔率差。
* **提前套现**：持仓者可在开赛前（Open）/锁定后（如允许）把 Outcome Token 卖回 AMM 或在外部 DEX 交易，实现“买入-卖出”式动态管理。
* **结算**：收到 Oracle 成果或仲裁裁决后，标记胜出 Outcome，允许按份额抽取资金池。

3. **PricingAMM（赔率形成与做市）**

* 两种常见设计，可择一或并存：

  * **CPMM（恒定乘积）三池路由**：为胜/平/负分别维持资金池，价格随买入量滑点变化；
  * **LMSR/Logit 型**：保证流动性、天然避免负库存，适合多 Outcome 与串关定价（计算更复杂）。
* 设计要点：

  * 下注即价格偏移，形成隐含赔率；
  * 交易费（如 1%）归 LP 与协议金库；
  * **开赛前最后 N 分钟自动禁买/只许卖出**（防延迟信息套利）。
  * **风控参数**：最大单笔滑点、最大持仓占比、盘口宽度上限（over-round 上限）。

4. **OracleLayer（去中心化赛果层）**

* **多源聚合**：至少两类供稿：预言机节点（如数据服务商）与“乐观上报人”（Proposer）。
* **乐观式流程**：

  * Proposer 在 `T_end + Δ1` 提交比赛结果（主/平/客、比分、是否含加时点球等），并质押保证金；
  * 进入**争议窗口 Δ2**，任何人可用保证金发起挑战 → 切换到仲裁；未被挑战则结果生效；
* **仲裁层（Arbitration）**：如社区法庭（Kleros 类）或治理投票，带质押/申诉/超时机制；
* **惩罚/激励**：错误上报/恶意挑战没收押金，正确方获得一部分作为奖励，另部分进入保险基金。

5. **Settlement & Payout（清算与赔付）**

* **批量结算**：Oracle 确认后，Market 合约冻结价格曲线，计算胜方可兑付的份额价值。
* **气费优化**：

  * 采用 **Merkle Payout**：由结算器离线计算每个地址可领金额 → 上传 Merkle root → 用户自证领取；
  * 或直接在 Market 内部按份额即时提取（更简洁，gas 高）。
* **退款路径**：若比赛取消/无效（规则定义），进入 `Refundable`，允许原路退回本金或按规则折算。

6. **LiquidityVault（LP 金库）**

* LP 存入稳定币或 Outcome 组合，获得 LP 份额（ERC-4626）。
* 金库策略：

  * 动态再平衡（在 3 路之间移仓以维持盘口宽度）；
  * 赚取手续费 + 部分点差收益；
  * 设 **风险闸门**：热门赛/临近开赛时降低敞口。
* 退出：赛果前可无罚金或收小额退出费（防“薅手续费”），赛果后常规赎回。

7. **FeeRouter & Treasury（费用与金库）**

* 交易费、铸造/赎回费、仲裁罚金的一部分进入 **保险基金** 与 **协议金库**；
* 保险基金用于极端争议、预言机赔付或黑天鹅事件的受损补偿（由 DAO 规则调用）。

8. **Governance（去中心化治理）**

* 参数化：争议窗口时长、保证金规模、可接受数据源名单、赛程白名单、费率等；
* 升级与应急：通过 timelock + 多签/DAO 执行，仅在 **可验证** 的规则升级下进行；
* **最小人工**：治理只做参数/名单管理与应急开关，日常运行由合约+keepers 自动化。

9. **Automation（Keepers/执行机器人）**

* 自动触发：锁盘（到点）、开放结算、开启争议期结束、批量发 root、回收过期奖励等。
* 多节点冗余，防单点离线；任务与奖励透明上链。

10. **Front-end / Indexing（前端与数据索引）**

* 前端仅做签名与可视化，所有状态源自链；
* 使用 Subgraph/Indexing 服务订阅 Market/AMM/Oracle 事件；
* 提供 API-less 的组合：用户可在任意 DEX/钱包处理 Outcome 代币。

---

# 三、市场规则（RuleSet）与边界情况

* **锁盘逻辑**：以 **链上可信时间** 为准（如预言机同步的开赛时间戳），开赛前 N 分钟禁止新买入，仅允许卖出或撤流动性（可配置）。
* **加时/点球**：明确“90 分钟胜平负”与“含加时/点球”的赛果口径，创建不同 Market 或在元数据中声明。
* **延期/腰斩**：

  * 延赛 ≤ X 天：Oracle 更新开赛时间并延长锁盘与争议时点；
  * 超过 X 天或腰斩无效：按退款路径处理。
* **VAR/判罚变更**：以比赛官方最终报告为准（Oracle 争议期内允许更新一次）。
* **数据来源优先级**：如 A>B>C，冲突时按优先级 + 仲裁解决。
* **可审计性**：规则 IPFS 哈希上链，任何规则变更需新版本哈希并绑定新市场。

---

# 四、赔率与做市设计要点

### 方案 A：三路 CPMM（恒定乘积）

* 为胜/平/负三路分别维持库存与价格，路由实现组合交易；
* **优势**：实现简单、gas 低，可与现有 DEX 组合；
* **注意**：需限制热门单边下注造成库存失衡；通过滑点上限、动态费率、LP 再平衡缓解。

### 方案 B：LMSR/Logit（信息市场常用）

* 单一资金池覆盖多 Outcome，价格由对数市场评分规则决定；
* **优势**：保证流动性与可微定价，天然支持多路与串关计算；
* **注意**：计算复杂（但可链下预估链上校验）、需谨慎参数 b 以控风险与价格敏感度。

**通用机制**：

* **动态费率**：临近开赛提高费率/点差，缓解信息滞后风险；
* **AMM 折价/溢价保护**：限制最大价差、禁止价格跳变越界；
* **大额下单保护**：强制最小成交深度或分批成交，防剧烈滑点造成不公平。

---

# 五、Oracle 与仲裁的无人工化

1. **多源 + 乐观**

* Proposer（可为任何节点）上报结果并质押；
* Δ2 内若无人挑战 → 自动确认；
* 有挑战 → 进入仲裁层，按押金/投票权裁决，误报/恶挑方被罚。

2. **反贿赂与抗操纵**

* **保证金规模与赛级别联动**（世界杯 > 五大联赛 > 友谊赛）；
* 采用 **二次质押**（Proposer 与 Challenger 都要押金），并对频繁错误上报者降信誉或拉黑；
* 仲裁投票采用 **加密提交-揭示（commit-reveal）**，避免投票期买票；
* 结果确定后设 **短暂延迟** 再结算，减少连环 MEV 攻击面。

---

# 六、资金安全与风控

* **资金隔离**：每个市场池与金库独立记账，协议金库与保险基金单独合约管理。
* **限额与节流**：单场最大下注额、单地址最大敞口、临近开赛时间的限额递减。
* **紧急开关**（仅限规则化触发）：

  * 预言机多源全部失效时的只读暂停；
  * 批量错误上报检测（如大规模反常结果）自动触发延迟结算。
* **升级/变更**：使用代理合约需有 timelock + DAO 提案；核心 Market/Token 尽量**免升级**（参数通过外部控制器注入）。

---

# 七、用户体验与可组合性

* **代币化持仓**：Outcome/LP 份额都是标准化代币 → 可转让/抵押/做 NFT 纪念票据。
* **串关（Parlay）**：以篮子（Basket）合约封装多场 Outcome 头寸，价格由各场 AMM 即时报价组合计算（或用链下计算 + 链上校验）。
* **提前结算/现金出场**：持仓直接在 AMM/DEX 卖出，或由 Market 合约提供“回购”通道。
* **跨链**：主部署在 L2（低 gas），用消息桥同步赛果与资金；单向领取可用跨链 Merkle 证明。

---

# 八、事件流与状态机（示意）

```mermaid
flowchart LR
  A[创建比赛 Market\n(赛程/规则/时间哈希)] --> B[开放下注 Open\nAMM 报价/LP 注入]
  B -->|距开赛N分钟| C[锁盘 Locked\n禁买(可卖)/禁LP进场]
  C -->|T_end+Δ1| D[预言机上报\nProposer+保证金]
  D -->|Δ2无人挑战| E[确认结果 Resolved]
  D -->|被挑战| F[仲裁层裁决\nKleros/治理投票]
  F --> E
  E --> G[清算/可领取 Claimable\n(批量 Merkle 或即取)]
  E --> H[保险/金库分账\n费用归集]
```

---

# 九、部署与运行建议

* **网络选择**：优先 L2（如 OP/Arb/zk），主网保留治理与最终裁决（可选）。
* **代币标准**：Outcome 用 ERC-1155（便于多路/多场批量转移），LP 用 ERC-4626；
* **索引**：The Graph/Subgraph，事件：创建、下注、价格变动、锁盘、上报、争议、结算、领取；
* **自动化**：Keepers 冗余部署 + 经济激励；
* **监控**：对关键阈值（大额下单、流动性骤变、预言机延迟）触发链上告警事件，前端/机器人订阅。

---

# 十、参数范式（可由 DAO 调整的默认值）

* 争议窗口 Δ2：30–120 分钟（按赛级别）
* 上报保证金：相对奖池 0.5%–2.0%（最低下限）
* 交易费：0.75%–1.5%（临近开赛阶梯上调）
* 锁盘提前量：5–15 分钟
* 单地址最大敞口：奖池的 5%–10%
* 保险基金提成：手续费的 20%（其余给 LP 与协议金库）

---

# 十一、极端情形与回退

* **数据源分叉**：多源冲突 → 进入仲裁；若仲裁超时 → 保险基金按“无效赛”退回。
* **合约风险**：采用审计与漏洞赏金；关键路径最少化、模块隔离，避免可重入与价格操纵。
* **经济攻击**：

  * 抢跑与 MEV：设置赌注提交 `commit-reveal`（下注承诺后延迟揭示），并在锁盘前禁买；
  * 串关套利：对高相关赛事穿透限额与相关性惩罚系数。

---

## 一句话总结

这套方案以**AMM 定价 + ERC-1155 头寸代币化 + 多源乐观式预言机 + 去中心化仲裁**为骨架，辅以批量清算、保险金库、参数化治理与自动化 keepers，实现一个**高度自动化、可审计、可组合**的链上足球博彩服务，最大程度减少人工干预，同时保留在极端情况下的规则化回退与风险兜底。

