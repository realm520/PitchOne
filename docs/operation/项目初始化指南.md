# 去中心化链上足球博彩 —— 项目初始化指南（技术驱动）
版本：v1.0 · 日期：2025-10-29

> 目标：一键拉起「本地开发环境」与「测试网部署最小闭环」，覆盖：合约(Foundry) / 后端(Go) / 数据库 & Subgraph / DevOps(脚本与CI骨架)。

---

## 0. 前置要求
- **Node.js** ≥ 18、**pnpm** ≥ 8（前端可选，本文聚焦后端/合约）
- **Go** ≥ 1.21
- **Docker** & **Docker Compose**
- **Foundry**（`curl -L https://foundry.paradigm.xyz | bash`，然后 `foundryup`）
- **Git**、**Make**、**jq**
- （可选）**Graph CLI**：`npm i -g @graphprotocol/graph-cli`

---

## 1. 目录结构（最小可用）
```
project-root/
  contracts/              # Solidity 合约（Foundry）
    src/
    script/
    test/
    foundry.toml
  backend/                # Go 微服务（Indexer/Keeper/Rewards）
    cmd/indexer/
    cmd/keeper/
    cmd/rewards/
    internal/
    go.mod
  subgraph/
    schema.graphql
    subgraph.yaml
    src/
  infra/
    docker-compose.yml    # 本地一键起 Postgres/Timescale + Grafana
    helm/                 # 预留 Helm Chart
  ops/
    .env.example
    Makefile
    seed/                 # 本地演示数据脚本
    scripts/              # 初始化/部署脚本
  README.md
```

> 本指南已附带一个**最小脚手架压缩包**（见文末下载）。解压即得上面结构与示例文件。

---

## 2. 一键启动（本地 Dev 回环）
1) 复制环境变量：
```bash
cp ops/.env.example .env
# 修改其中 RPC_URL/PRIVATE_KEY/CHAIN_ID 等
```
2) 启动基础设施（数据库、Grafana 等）：
```bash
make up
# 等待 Postgres (5432) 与 Grafana (3000) 就绪
```
3) 初始化 Foundry 与本地链（anvil）并部署合约：
```bash
make chain          # 启动 anvil 并固化助记词
make contracts-deploy  # 执行 Foundry script 广播部署
```
4) 启动后端服务：
```bash
make backend        # 同时启动 indexer / keeper / rewards（或分别 make indexer / keeper / rewards）
```
5) 启动 Subgraph（本地）：
```bash
make subgraph       # 生成/编译/部署到本地 graph-node（如未安装可跳过）
```

> 至此，本地应完成：**事件→DB→指标** 与 **锁盘/结算/发奖** 的最小演示流。

---

## 3. 环境变量（.env 关键项）
```
# ==== 链与账户 ====
RPC_URL=https://arb-sepolia.g.alchemy.com/v2/xxx
CHAIN_ID=421614
PRIVATE_KEY=0xabc...                # 测试用私钥（勿用于生产）

# ==== 数据库 ====
PG_DSN=postgres://postgres:postgres@localhost:5432/sports?sslmode=disable
PG_MAX_CONN=20

# ==== 服务 ====
KEEPER_LOCK_AHEAD_SECS=600
OO_LIVENESS_SECS=3600
PROMO_BPS=2000

# ==== 指标/可观测 ====
OTEL_ENDPOINT=http://localhost:4317
```

> 生产环境请使用 **Vault/KMS** 托管密钥，`.env` 只存本地无风险项。

---

## 4. Foundry（合约）初始化
**已在脚手架中预置：**
- `foundry.toml`：编译/优化参数、RPC 配置占位；
- `script/Deploy.s.sol`：部署 MarketFactory/MarketBase 模板/ParamController 等；
- `test/`：样例测试（事件、锁盘、resolve/claim 基本路径）。

**常用命令：**
```bash
forge test -vvv              # 运行测试
forge coverage               # 覆盖率
slither .                    # 静态分析（需装slither）
forge script script/Deploy.s.sol:Deploy --rpc-url $RPC_URL --broadcast --verify -vvvv
```

---

## 5. Go 后端初始化
**服务说明：**
- `cmd/indexer`：订阅合约事件 → 写入 Postgres（含幂等与重放）
- `cmd/keeper`：定时任务（锁盘/上报/发布周度根等）
- `cmd/rewards`：聚合周度返佣/活动 → 计算 Merkle → 上链 root

**本地启动：**
```bash
go mod tidy
go run ./cmd/indexer
go run ./cmd/keeper
go run ./cmd/rewards
```

**配置：**
- 支持 `.env` 与环境变量；
- 订阅起始块：`INDEX_FROM_BLOCK`；重放策略：`FINALITY_BLOCKS`。

---

## 6. 数据与可观测
- **Postgres**：核心表（示例）`bets/liquidity/resolutions/referrals/rewards/baskets` 与 `markets` 维表；
- **Grafana**：导入脚手架自带 JSON 仪表盘（GTV、Fees、Active Users、Indexer Lag）；
- **OTel/Prom**：Go 服务接入 trace/metrics；默认暴露 `:9090/metrics`。

---

## 7. Subgraph 初始化
1) 生成 Types：`graph codegen`  
2) 编译：`graph build`  
3) 部署（本地或 Hosted）：`graph deploy ...`

> 脚手架已放置 `schema.graphql` 与 `subgraph.yaml` 占位，部署前请替换合约地址与起始块。

---

## 8. 测试网部署（Arbitrum Sepolia）
1) 准备：设置 `RPC_URL` / `PRIVATE_KEY` / `CHAIN_ID=421614`  
2) 部署脚本：
```bash
make contracts-deploy-testnet
```
3) 回填地址：脚本会生成 `ops/addresses.json`，用于后端与 Subgraph。

---

## 9. 安全与合规（工程角度）
- **不可重入防护**、**Checks-Effects-Interactions**、**最小权限**；
- Slither + Echidna（不变量） + Scribble（断言）纳入 CI 门禁；
- **Safe 多签** 与 **Timelock** 控制参数与资金权限；
- **紧急开关**：只读暂停（停新建/停卖出，不影响兑付）。

---

## 10. CI/CD（骨架）
- **GitHub Actions**：
  - 合约：`forge test`、`coverage`、`slither`、构建与（测试网）广播；
  - 后端：Go 单/集测、Docker 镜像构建、推送；
  - Subgraph：schema 检查与编译；
- **发布工件**：`addresses.json`、ABI、后端镜像 tag、Subgraph 版本号。

> 脚手架已附 `ops/scripts/*` 示例工作流脚本，可复制到 `.github/workflows`。

---

## 11. 常见问题（FAQ）
- **锁盘没触发？** 检查 Keeper 定时规则/时间同步；可手工 `cast send ... lock()`。  
- **事件延迟高？** 增大 `FINALITY_BLOCKS`、确认 RPC 稳定；开启批量写入与索引。  
- **部署报错 nonce？** 确认只广播一次；配置 `--legacy` 或 EIP-1559 参数。  
- **本地/测试网价格异常？** 检查 ParamController 参数（fee/联动系数/限额）是否已正确应用。

---

## 12. 下一步
- 按「详细设计文档」冻结接口与参数 → 执行审计前自审清单；
- 接入 UMA OO（或自建 OO），完成结果上报全流程压测；
- 开启 Notion/Jira 的任务模板（已在 Excel/Markdown 中提供字段）。

---

**附：** 本指南配套的**最小脚手架压缩包**（含 Makefile、docker-compose、Deploy 脚本、Go 服务与 Subgraph 占位）已一并提供下载。
