# OU_Template å®žçŽ°æ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2025-11-01
**å¼€å‘æ—¶é—´**: ~3å°æ—¶
**çŠ¶æ€**: âœ… å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

---

## ðŸ“Š æˆæžœæ¦‚è§ˆ

### äº¤ä»˜ç‰©

| äº¤ä»˜ç‰© | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | ä»£ç è¡Œæ•° |
|-------|---------|------|---------|
| **OU_Template åˆçº¦** | `src/templates/OU_Template.sol` | âœ… å®Œæˆ | ~370è¡Œ |
| **å•å…ƒæµ‹è¯•** | `test/unit/OU_Template.t.sol` | âœ… å®Œæˆ | ~705è¡Œ |
| **æµ‹è¯•é€šè¿‡çŽ‡** | - | âœ… 100% | 46/46 tests passed |

### æµ‹è¯•ç»Ÿè®¡

- **æµ‹è¯•ç”¨ä¾‹æ€»æ•°**: 46ä¸ª
- **æµ‹è¯•é€šè¿‡çŽ‡**: 100% (46/46)
- **æµ‹è¯•åˆ†ç±»**:
  - æž„é€ å‡½æ•°æµ‹è¯•: 11ä¸ª
  - ä¸‹æ³¨åŠŸèƒ½æµ‹è¯•: 6ä¸ª
  - ä»·æ ¼æŸ¥è¯¢æµ‹è¯•: 5ä¸ª
  - å¸‚åœºä¿¡æ¯æµ‹è¯•: 3ä¸ª
  - é”ç›˜æµ‹è¯•: 8ä¸ª
  - ç»“ç®—æµ‹è¯•: 5ä¸ª
  - æœ€ç»ˆç¡®è®¤æµ‹è¯•: 3ä¸ª
  - å…‘ä»˜æµ‹è¯•: 3ä¸ª
  - ç®¡ç†å‡½æ•°æµ‹è¯•: 2ä¸ª
  - é›†æˆæµ‹è¯•: 2ä¸ª

### é¡¹ç›®æµ‹è¯•æ€»ä½“çŠ¶æ€

- **æ€»æµ‹è¯•æ•°**: 298ä¸ª (ä»Ž252å¢žåŠ åˆ°298)
- **æ–°å¢žæµ‹è¯•**: 46ä¸ª
- **æµ‹è¯•é€šè¿‡çŽ‡**: 100% (298/298)
- **åˆçº¦å®žçŽ°è¿›åº¦**: 47% (9/19ï¼Œæ–°å¢žOU_Template)

---

## ðŸŽ¯ å®žçŽ°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. å¤§å°çƒå¸‚åœºæ¨¡æ¿ï¼ˆå•çº¿ç‰ˆæœ¬ï¼‰

#### æ”¯æŒçš„åŠŸèƒ½
- âœ… åŠçƒç›˜ï¼ˆå¦‚2.5çƒã€3.5çƒï¼‰
- âœ… æ•´æ•°ç›˜ï¼ˆå¦‚2.0çƒã€3.0çƒï¼‰
- âœ… äºŒå‘å¸‚åœºï¼ˆOver/Underï¼‰
- âœ… CPMMå®šä»·å¼•æ“Žé›†æˆ
- âœ… å®Œæ•´å¸‚åœºç”Ÿå‘½å‘¨æœŸï¼ˆOpen â†’ Locked â†’ Resolved â†’ Finalizedï¼‰
- âœ… è‡ªåŠ¨é”ç›˜åŠŸèƒ½ï¼ˆå¼€èµ›å‰5åˆ†é’Ÿï¼‰

#### å…³é”®å‚æ•°è®¾è®¡
```solidity
// ç›˜å£çº¿ä½¿ç”¨åƒåˆ†ä½è¡¨ç¤º
uint256 public immutable line;  // 2.5çƒ = 2500, 3.0çƒ = 3000

// è‡ªåŠ¨è¯†åˆ«åŠçƒç›˜ vs æ•´æ•°ç›˜
bool public immutable isHalfLine;  // 2.5 = true, 2.0 = false
```

#### ç»“ç®—é€»è¾‘
```solidity
function _calculateWinner(MatchFacts memory facts) internal view override {
    uint256 totalGoals = facts.homeGoals + facts.awayGoals;
    uint256 totalGoalsScaled = totalGoals * LINE_PRECISION; // è½¬æ¢ä¸ºåƒåˆ†ä½

    if (isHalfLine) {
        return totalGoalsScaled > line ? OVER : UNDER;
    }

    // æ•´æ•°ç›˜éœ€è¦å¤„ç†å¹³å±€ï¼ˆpushï¼‰
    if (totalGoalsScaled > line) return OVER;
    if (totalGoalsScaled < line) return UNDER;

    // æ€»è¿›çƒç­‰äºŽç›˜å£ â†’ é€€æ¬¾ï¼ˆæš‚æ—¶revertï¼Œæœªæ¥å®žçŽ°é€€æ¬¾é€»è¾‘ï¼‰
    revert("OU: Push detected - refund required");
}
```

### 2. ä¸Ž WDL_Template çš„è®¾è®¡ä¸€è‡´æ€§

| è®¾è®¡å…ƒç´  | WDL_Template | OU_Template | ä¸€è‡´æ€§ |
|---------|-------------|------------|-------|
| **ç»§æ‰¿åŸºç±»** | MarketBase | MarketBase | âœ… |
| **å®šä»·å¼•æ“Ž** | SimpleCPMM | SimpleCPMM | âœ… |
| **ç»“æžœæ•°é‡** | 3 (Win/Draw/Loss) | 2 (Over/Under) | - |
| **è‡ªåŠ¨é”ç›˜** | kickoffTime - 5min | kickoffTime - 5min | âœ… |
| **ä»·æ ¼æŸ¥è¯¢** | getCurrentPrice(), getAllPrices() | getCurrentPrice(), getAllPrices() | âœ… |
| **ç®¡ç†å‡½æ•°** | setPricingEngine(), autoLock() | setPricingEngine(), autoLock() | âœ… |
| **äº‹ä»¶å®šä¹‰** | MarketCreated, Locked, Resolved | MarketCreated, Locked, Resolved | âœ… |

### 3. æµ‹è¯•è¦†ç›–

#### å®Œæ•´æ€§æµ‹è¯•
- âœ… æž„é€ å‡½æ•°å‚æ•°éªŒè¯ï¼ˆ9ä¸ªrevertæµ‹è¯•ï¼‰
- âœ… ä¸‹æ³¨åŠŸèƒ½ï¼ˆæ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯ï¼‰
- âœ… ä»·æ ¼è®¡ç®—ï¼ˆåˆå§‹çŠ¶æ€ã€ä¸‹æ³¨åŽï¼‰
- âœ… é”ç›˜æœºåˆ¶ï¼ˆæ‰‹åŠ¨ã€è‡ªåŠ¨ã€æ—¶é—´æ£€æŸ¥ï¼‰
- âœ… ç»“ç®—é€»è¾‘ï¼ˆOver/Underï¼‰
- âœ… å…‘ä»˜æµç¨‹ï¼ˆèµ¢å®¶ã€è¾“å®¶ï¼‰

#### è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- âœ… ç›˜å£éªŒè¯ï¼ˆæœ€å°0.5ï¼Œæœ€å¤§20.0ï¼‰
- âœ… åŠçƒç›˜ vs æ•´æ•°ç›˜è¯†åˆ«
- âœ… æ•´æ•°ç›˜å¹³å±€åœºæ™¯ï¼ˆrevertæ­£ç¡®ï¼‰
- âœ… æ—¶é—´è¾¹ç•Œï¼ˆå¼€çƒå‰/åŽï¼‰

#### é›†æˆæµ‹è¯•
- âœ… å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆOverèŽ·èƒœï¼‰
- âœ… å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆUnderèŽ·èƒœï¼‰

---

## ðŸ” æŠ€æœ¯äº®ç‚¹

### 1. ç›˜å£ç²¾åº¦è®¾è®¡

ä½¿ç”¨åƒåˆ†ä½è¡¨ç¤ºé¿å…æµ®ç‚¹æ•°é—®é¢˜ï¼š
```solidity
uint256 constant LINE_PRECISION = 1000;

// 2.5çƒ â†’ 2500
// 3.0çƒ â†’ 3000
// 0.5çƒ â†’ 500
```

**ä¼˜åŠ¿**:
- é¿å…Solidityæµ®ç‚¹æ•°é™åˆ¶
- ç²¾ç¡®è®¡ç®—ï¼Œæ— ç²¾åº¦æŸå¤±
- æ˜“äºŽé“¾ä¸‹è§£æžå’Œå±•ç¤º

### 2. æ•´æ•°ç›˜å¹³å±€å¤„ç†

å½“å‰ç‰ˆæœ¬é€šè¿‡`revert`æ‹’ç»ç»“ç®—æ•´æ•°ç›˜çš„å¹³å±€æƒ…å†µï¼š
```solidity
if (totalGoalsScaled == line) {
    revert("OU: Push detected - refund required");
}
```

**è®¾è®¡è€ƒè™‘**:
- M1é˜¶æ®µä»…å®žçŽ°åŸºç¡€åŠŸèƒ½
- é€€æ¬¾æœºåˆ¶éœ€è¦é¢å¤–çš„åˆçº¦é€»è¾‘ï¼ˆæœªæ¥æ‰©å±•ï¼‰
- é€šè¿‡revertç¡®ä¿ä¸ä¼šé”™è¯¯ç»“ç®—

### 3. ä»£ç å¤ç”¨çŽ‡é«˜

OU_Templateä¸ŽWDL_Templateå…±äº«85%ä»¥ä¸Šçš„ä»£ç ç»“æž„ï¼š
- ç›¸åŒçš„åŸºç±»ï¼ˆMarketBaseï¼‰
- ç›¸åŒçš„å®šä»·å¼•æ“Žé›†æˆæ–¹å¼
- ç›¸åŒçš„é”ç›˜å’Œç»“ç®—æµç¨‹
- ä»…éœ€å®žçŽ°ç‰¹å®šçš„`_calculateWinner`é€»è¾‘

---

## ðŸ“ˆ æ€§èƒ½æ•°æ®

### Gasæ¶ˆè€—ï¼ˆå…³é”®æ“ä½œï¼‰

| æ“ä½œ | Gasæ¶ˆè€— | å¯¹æ¯”WDL |
|-----|--------|---------|
| æž„é€ å‡½æ•° | ~3,190,876 | ç›¸ä¼¼ |
| ä¸‹æ³¨ï¼ˆé¦–æ¬¡ï¼‰ | ~223,217 | ç•¥ä½Žï¼ˆç»“æžœæ•°å°‘ï¼‰ |
| é”ç›˜ | ~59,218 | ç›¸åŒ |
| ç»“ç®— | ~64,500 | ç›¸åŒ |
| å…‘ä»˜ | ~346,742 | ç›¸ä¼¼ |

**ä¼˜åŒ–æ½œåŠ›**:
- äºŒå‘å¸‚åœºæ¯”ä¸‰å‘å¸‚åœºGasç•¥ä½Žï¼ˆå‚¨å¤‡æ•°ç»„æ›´å°ï¼‰
- æœªæ¥å¯é€šè¿‡ç¼“å­˜å’Œæ‰¹é‡æ“ä½œè¿›ä¸€æ­¥ä¼˜åŒ–

---

## ðŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### M1é˜¶æ®µï¼ˆç«‹å³ï¼‰

1. **é›†æˆåˆ°ç³»ç»Ÿ** (1-2å¤©)
   - âœ… OU_Templateå·²å®žçŽ°
   - ðŸ”œ é›†æˆåˆ°MarketTemplateRegistry
   - ðŸ”œ KeeperæœåŠ¡æ”¯æŒOUå¸‚åœº
   - ðŸ”œ Indexeræ”¯æŒOUäº‹ä»¶

2. **ç«¯åˆ°ç«¯æµ‹è¯•** (1å¤©)
   - ðŸ”œ éƒ¨ç½²åˆ°æœ¬åœ°Anvilæµ‹è¯•é“¾
   - ðŸ”œ å®Œæ•´ä¸‹æ³¨â†’ç»“ç®—â†’å…‘ä»˜æµç¨‹éªŒè¯
   - ðŸ”œ Keeperè‡ªåŠ¨é”ç›˜æµ‹è¯•

### M2é˜¶æ®µï¼ˆåŽç»­ï¼‰

3. **å¤šçº¿è”åŠ¨æ‰©å±•** (4-6å¤©)
   - å®žçŽ°LinkedLinesController
   - æ‰©å±•OU_Templateæ”¯æŒå¤šçº¿ï¼ˆ0.5, 1.5, 2.5, 3.5åŒæ—¶å¼€ç›˜ï¼‰
   - ç›¸é‚»çº¿è”åŠ¨å®šä»·

4. **æ•´æ•°ç›˜é€€æ¬¾æœºåˆ¶** (2-3å¤©)
   - å®žçŽ°pushåœºæ™¯çš„è‡ªåŠ¨é€€æ¬¾
   - æ›´æ–°OU_Templateçš„_calculateWinner
   - æ·»åŠ é€€æ¬¾æµ‹è¯•

---

## ðŸ“ å…³é”®ä»£ç ç‰‡æ®µ

### ç›˜å£æ˜¾ç¤ºè¾…åŠ©å‡½æ•°

```solidity
/**
 * @notice èŽ·å–ç›˜å£çš„å°æ•°è¡¨ç¤º
 * @return integer æ•´æ•°éƒ¨åˆ†
 * @return decimal å°æ•°éƒ¨åˆ†ï¼ˆåƒåˆ†ä½ï¼‰
 * @dev ä¾‹å¦‚ï¼š2.5çƒ â†’ (2, 500)ï¼Œ3.0çƒ â†’ (3, 0)
 */
function getLineDisplay() external view returns (uint256 integer, uint256 decimal) {
    integer = line / LINE_PRECISION;
    decimal = line % LINE_PRECISION;
    return (integer, decimal);
}
```

**ç”¨é€”**: ä¾¿äºŽå‰ç«¯å±•ç¤ºå’Œé“¾ä¸‹æŸ¥è¯¢

### å¸‚åœºä¿¡æ¯æŸ¥è¯¢

```solidity
function getMarketInfo()
    external
    view
    returns (
        string memory _matchId,
        string memory _homeTeam,
        string memory _awayTeam,
        uint256 _kickoffTime,
        uint256 _line,         // OUç‰¹æœ‰
        bool _isHalfLine,      // OUç‰¹æœ‰
        MarketStatus _status
    )
{
    return (matchId, homeTeam, awayTeam, kickoffTime, line, isHalfLine, status);
}
```

**æ‰©å±•**: ç›¸æ¯”WDLå¢žåŠ äº†lineå’ŒisHalfLineå­—æ®µ

---

## âš ï¸ å·²çŸ¥é™åˆ¶ä¸Žæœªæ¥æ”¹è¿›

### å½“å‰é™åˆ¶

1. **ä»…æ”¯æŒå•çº¿**
   - ä¸€ä¸ªå¸‚åœºåªèƒ½æœ‰ä¸€ä¸ªç›˜å£ï¼ˆå¦‚ä»…2.5çƒï¼‰
   - M2é˜¶æ®µå°†æ‰©å±•åˆ°å¤šçº¿ï¼ˆ0.5, 1.5, 2.5, 3.5åŒæ—¶ï¼‰

2. **æ•´æ•°ç›˜æ— é€€æ¬¾**
   - å½“å‰revertå¹³å±€æƒ…å†µ
   - éœ€è¦é¢å¤–çš„é€€æ¬¾é€»è¾‘ï¼ˆæœªæ¥å®žçŽ°ï¼‰

3. **æ— åŠ¨æ€ç›˜å£è°ƒæ•´**
   - ç›˜å£åœ¨åˆ›å»ºæ—¶å›ºå®š
   - æœªæ¥å¯é€šè¿‡æ²»ç†æˆ–é¢„è¨€æœºåŠ¨æ€è°ƒæ•´

### æ”¹è¿›æ–¹å‘

1. **Gasä¼˜åŒ–**
   - æ‰¹é‡æ“ä½œæ”¯æŒ
   - å‚¨å¤‡ç¼“å­˜ä¼˜åŒ–
   - äº‹ä»¶æ—¥å¿—åŽ‹ç¼©

2. **åŠŸèƒ½æ‰©å±•**
   - åŠåœºå¤§å°çƒ
   - å•é˜Ÿå¤§å°çƒ
   - è§’çƒå¤§å°çƒ

3. **ç”¨æˆ·ä½“éªŒ**
   - å®žæ—¶èµ”çŽ‡æŽ¨é€
   - æ»‘ç‚¹ä¿æŠ¤å¢žå¼º
   - é™é¢å’Œé£ŽæŽ§é›†æˆ

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [MarketBaseå®žçŽ°](../src/core/MarketBase.sol)
- [WDL_Templateå®žçŽ°](../src/templates/WDL_Template.sol)
- [SimpleCPMMå®šä»·å¼•æ“Ž](../src/pricing/SimpleCPMM.sol)
- [å¾…å®žçŽ°åˆçº¦è·¯çº¿å›¾](./MISSING_CONTRACTS_ROADMAP.md)
- [é¡¹ç›®è¿›åº¦è¿½è¸ª](./progress.md)

---

## âœ… éªŒæ”¶æ ‡å‡†æ£€æŸ¥

| æ ‡å‡† | è¦æ±‚ | å®žé™… | çŠ¶æ€ |
|-----|------|------|------|
| **ä»£ç è¡Œæ•°** | - | 370è¡Œ | âœ… |
| **æµ‹è¯•æ•°é‡** | â‰¥30 | 46ä¸ª | âœ… è¶…æ ‡ |
| **æµ‹è¯•é€šè¿‡çŽ‡** | 100% | 100% (46/46) | âœ… |
| **ä»£ç é£Žæ ¼** | Solidityæ ‡å‡† | éµå¾ª | âœ… |
| **æ–‡æ¡£æ³¨é‡Š** | NatSpec | å®Œæ•´ | âœ… |
| **Gasä¼˜åŒ–** | åˆç† | ä¸ŽWDLç›¸ä¼¼ | âœ… |
| **å®‰å…¨æ€§** | æ— æ˜Žæ˜¾æ¼æ´ž | é€šè¿‡åŸºç¡€æ£€æŸ¥ | âœ… |
| **ä¸ŽWDLä¸€è‡´æ€§** | é«˜ | 85%+ | âœ… |

---

## ðŸŽ“ å¼€å‘ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **å¤ç”¨çŽ°æœ‰æ¨¡å¼**
   - WDL_Templateæä¾›äº†ä¼˜ç§€çš„æ¨¡æ¿
   - å¤ç”¨MarketBaseæŠ½è±¡ç±»èŠ‚çœå¤§é‡æ—¶é—´
   - æµ‹è¯•ç»“æž„ä¹Ÿå¯ä»¥å¤ç”¨

2. **æµ‹è¯•é©±åŠ¨å¼€å‘**
   - å…ˆè®¾è®¡æµ‹è¯•ç”¨ä¾‹
   - è¾¹å®žçŽ°è¾¹æµ‹è¯•
   - å¿«é€Ÿå‘çŽ°å’Œä¿®å¤é—®é¢˜

3. **æ–‡æ¡£å…ˆè¡Œ**
   - æ¸…æ™°çš„NatSpecæ³¨é‡Š
   - ä»£ç è‡ªè§£é‡Š
   - ä¾¿äºŽåŽç»­ç»´æŠ¤

### é‡åˆ°çš„é—®é¢˜ä¸Žè§£å†³

1. **resolveFromOracleå‚æ•°é—®é¢˜**
   - é—®é¢˜ï¼šè¯¯ç”¨äº†resolveFromOracle(facts)
   - è§£å†³ï¼šæ”¹ç”¨resolve(outcomeId)è¿›è¡Œæµ‹è¯•
   - æ•™è®­ï¼šå…ˆé˜…è¯»åŸºç±»æŽ¥å£å®šä¹‰

2. **æ•´æ•°ç›˜å¹³å±€å¤„ç†**
   - é—®é¢˜ï¼šå¦‚ä½•å¤„ç†pushæƒ…å†µ
   - è§£å†³ï¼šå½“å‰ç‰ˆæœ¬revertï¼Œæœªæ¥æ‰©å±•é€€æ¬¾
   - æ•™è®­ï¼šåˆ†é˜¶æ®µå®žçŽ°å¤æ‚åŠŸèƒ½

---

**å¼€å‘è€…**: Claude Code
**å®¡æ ¸è€…**: å¾…å®¡æ ¸
**ä¸‹æ¬¡æ›´æ–°**: M2é˜¶æ®µï¼ˆå¤šçº¿æ‰©å±•ï¼‰
