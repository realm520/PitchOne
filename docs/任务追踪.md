# 项目任务追踪（技术驱动）

- **开始周**：2025-10-29（实际）  |  **周期**：12 周  |  **当前进度**：Week 5-6  |  **合约完成度**：63% (12/19)  |  **测试通过**：491/491  |  **Slither**：0 中高危

## 里程碑

- **M0 脚手架**（第 1 周，2025-11-03）：Foundry合约骨架/事件契约；Go Indexer/初版Subgraph/CI
- **M1 主流程闭环**（第 3 周，2025-11-17）：WDL+OU单线/AMM/锁盘/结算/兑付；UMA OO接入；Rewards/Referral
- **M2 运营闭环**（第 6 周，2025-12-08）：活动/任务/周度Merkle/仪表盘；OU多线+联动；AH(-0.5)
- **M3 扩玩法与可插槽**（第 12 周，2026-01-19）：精确比分/LMSR/Props(1-2)；CLOB插槽(选配)+风控进阶

## 工作分解（WBS 摘要）

- **Solidity Team / 链上内核/模板**：MarketTemplateRegistry / MarketBase / ERC-1155 / ERC-4626 〔窗口：M0-M1 | 预估点数：30〕
- **Solidity Team / 市场模板**：WDL / OU(单线) / AH(-0.5) / 事件与错误码 〔窗口：M0-M2 | 预估点数：40〕
- **Solidity Team / 做市/定价**：CPMM二/三向，LMSR骨架，线联动适配接口 〔窗口：M1-M3 | 预估点数：30〕
- **Solidity Team / 串关/组合**：Basket(Parlay) + CorrelationGuard 〔窗口：M2-M3 | 预估点数：20〕
- **Solidity Team / 费用/运营合约**：FeeRouter / ParamController / RewardsDistributor / ReferralRegistry 〔窗口：M1-M2 | 预估点数：35〕
- **Solidity Team / 预言机适配**：UMA OO Adapter / ResultOracle 接口 〔窗口：M1 | 预估点数：15〕
- **Oracle/Protocol / MatchFacts标准**：结构化事实schema/规则版本化/仲裁流程脚本 〔窗口：M0-M1 | 预估点数：10〕
- **Oracle/Protocol / Keeper自动化**：锁盘/争议窗口/Finalize/Gelato任务 〔窗口：M1-M2 | 预估点数：12〕
- **Backend / Indexer**：订阅合约→Postgres/Timescale；重放与容错 〔窗口：M0-M1 | 预估点数：20〕
- **Backend / Keeper Service**：锁盘/发布Merkle/清理过期券；冗余执行 〔窗口：M1-M2 | 预估点数：16〕
- **Backend / Rewards Builder**：周度Merkle树生成与上链; 奖励对账 〔窗口：M1-M2 | 预估点数：12〕
- **Backend / Risk & Pricing Worker**：OU/AH相邻线联动，相关性矩阵接口 〔窗口：M2-M3 | 预估点数：18〕
- **Backend / API Gateway(只读)**：查询/聚合/签名组装(不托管) 〔窗口：M2 | 预估点数：10〕
- **Growth Infra / Campaign/Quest**：活动/任务工厂与规则hash；前后端钩子 〔窗口：M2 | 预估点数：10〕
- **Growth Infra / Credit/Coupon**：免佣额度券/串关加成券策略与核销 〔窗口：M2 | 预估点数：8〕
- **Growth Infra / PayoutScaler**：预算不足统一缩放策略与参数 〔窗口：M2 | 预估点数：6〕
- **Growth Infra / Promoter SBT+Staking**：权限/质押/惩罚流程(基础版) 〔窗口：M3 | 预估点数：10〕
- **Risk & Quant / AMM参数与不变量**：费率/滑点/守恒校验；Echidna/Scribble约束 〔窗口：M1 | 预估点数：10〕
- **Risk & Quant / 相关性与限额**：同场同向合并限额/串关阻断策略 〔窗口：M2 | 预估点数：12〕
- **Data/Analytics / Subgraph**：schema+handlers；Market/Oracle/Rewards/Referral/Basket 〔窗口：M0-M2 | 预估点数：18〕
- **Data/Analytics / 指标与看板**：Grafana/Metabase；KPI字典与报警 〔窗口：M2 | 预估点数：12〕
- **SRE / CI/CD**：GitHub Actions流水线(合约/后端/Subgraph) 〔窗口：M0 | 预估点数：8〕
- **SRE / K8s与IaC**：Terraform+Helm；环境分层；日志/OTel 〔窗口：M1-M2 | 预估点数：16〕
- **SRE / 密钥与权限**：Vault/KMS；Safe/Timelock权限图 〔窗口：M1 | 预估点数：6〕
- **SRE / 演练与回滚**：锁盘失败/无人上报/争议风暴剧本 〔窗口：M2 | 预估点数：6〕
- **Security / 静态/模糊/断言**：Slither/Echidna/Scribble集成与报告 〔窗口：M1 | 预估点数：8〕
- **Security / 外审与悬赏**：对接审计机构; Bug Bounty流程 〔窗口：M2 | 预估点数：10〕
- **Web/Wallet / 最小前端**：下注/串关/领取/锁盘提示；参数灰度后台 〔窗口：M1-M2 | 预估点数：16〕
- **Docs/DevRel / 文档与规范**：ABI/事件/运行手册；风控白皮书(IPFS) 〔窗口：M1-M2 | 预估点数：10〕

## 周度计划（Planned）

- 第 1 周（2025-11-03）：计划 30.2 点；累计 30.2，剩余 403.8
- 第 2 周（2025-11-10）：计划 54.7 点；累计 84.9，剩余 349.1
- 第 3 周（2025-11-17）：计划 54.7 点；累计 139.60000000000002，剩余 294.4
- 第 4 周（2025-11-24）：计划 54.7 点；累计 194.3，剩余 239.7
- 第 5 周（2025-12-01）：计划 49.9 点；累计 244.20000000000002，剩余 189.79999999999998
- 第 6 周（2025-12-08）：计划 49.9 点；累计 294.1，剩余 139.89999999999998
- 第 7 周（2025-12-15）：计划 49.9 点；累计 344.0，剩余 90.0
- 第 8 周（2025-12-22）：计划 49.9 点；累计 393.9，剩余 40.10000000000002
- 第 9 周（2025-12-29）：计划 10.0 点；累计 403.9，剩余 30.100000000000023
- 第 10 周（2026-01-05）：计划 10.0 点；累计 413.9，剩余 20.100000000000023
- 第 11 周（2026-01-12）：计划 10.0 点；累计 423.9，剩余 10.100000000000023
- 第 12 周（2026-01-19）：计划 10.0 点；累计 433.9，剩余 0.10000000000002274

## 进度更新（每周维护）

### Week 1-4（2025-10-29 ~ 2025-11-25）实际完成

- **完成点数**：约 150 点（估算）
- **关键交付**：
  - ✅ **合约层**：10个核心合约完成（52%进度）
    - MarketBase, MarketTemplateRegistry, FeeRouter, RewardsDistributor, ReferralRegistry
    - SimpleCPMM, MockOracle, UMAOptimisticOracleAdapter
    - WDL_Template, OU_Template（含 Push 退款机制）
  - ✅ **测试覆盖**：344 个测试，100% 通过率，76.15% 代码覆盖率
  - ✅ **后端服务**：Indexer + Keeper 完成（Go 实现，约 2,700 行代码）
  - ✅ **数据库**：完整 Schema + 迁移脚本（7 张表，11 个索引）
  - ✅ **Subgraph**：完整部署成功，GraphQL 查询验证通过
  - ✅ **安全扫描**：Slither 通过，0 高危/中危问题
- **技术债务**：
  - ⚠️ 3 个集成测试失败（MarketBase 赔付逻辑简化导致）
  - 需要完整端到端流程验证（Anvil + Keeper + Indexer）
- **下一步计划**：
  - 修复技术债务（集成测试）
  - 完成 ParamController 合约
  - 启动 M2 运营闭环功能开发

### Week 5-6（2025-11-26 ~ 2025-12-09）实际完成

- **完成点数**：约 31 点
- **本周关键交付**：
  - ✅ **ParamController 治理合约**（6 点）
    - 完整的 Timelock 机制（提案创建/执行/取消）
    - 参数验证器支持（范围/白名单/黑名单）
    - 紧急暂停功能
    - 35 个单元测试，90.10% 行覆盖率，100% 函数覆盖率
  - ✅ **LinkedLinesController 联动定价控制器**（8 点）
    - 线组管理（创建、配置、查询）
    - 联动系数与价差限制
    - 套利检测逻辑
    - 储备量调整功能
    - 19 个单元测试全部通过
  - ✅ **OU_MultiLine 多线扩展**（7 点）
    - 支持多条盘口线（如 2.0、2.5、3.0 球）
    - Outcome ID 编码系统（lineIndex * 3 + direction）
    - 集成 LinkedLinesController
    - 23 个单元测试，100% 通过率
    - 修复储备量单位不匹配问题（USDC 6 decimals）
  - ✅ **Campaign/Quest 活动与任务系统**（10 点）
    - Campaign.sol: 活动工厂、预算管理、参与追踪（356 行）
    - Quest.sol: 5 种任务类型、进度追踪、自动完成、奖励领取（403 行）
    - 26 + 32 + 12 = 70 个测试，100% 通过率
    - 集成测试覆盖完整用户旅程
    - Subgraph Schema 扩展：16 个新实体（Campaign/Quest 完整数据层）
    - 事件字典文档：10 个事件完整定义（689 行）
    - GraphQL 查询文档：40+ 查询示例（700+ 行）
- **技术债务清理**（新增）：
  - ✅ 修复 MarketBase.calculateFee() 精度损失（单次除法优化）
  - ✅ 修复 RewardsDistributor 精度损失（_claim + getClaimable）
  - ✅ 修复 FeeRouter 重入攻击风险（添加 ReentrancyGuard）
  - ✅ 修复 UMAOptimisticOracleAdapter 重入风险（添加 ReentrancyGuard）
  - ✅ 修复 MarketTemplateRegistry 哈希碰撞风险（abi.encode 替代 encodePacked）
  - ✅ Slither 中高危问题从 9 个减少到 0 个（剩余 4 个为误报）
  - ✅ 所有 491 个测试 100% 通过，无破坏性变更
- **合约完成度更新**：12/19 (63%) - 新增 Campaign + Quest
- **测试覆盖率**：60.76% 行，75.98% 函数（491 个测试全部通过）
- **下周计划**：
  - 启动 AH(-0.5) 让球模板开发
  - 实现 Subgraph Mapping（Campaign/Quest 事件处理器）
  - 提升核心合约测试覆盖率至 ≥90%

---

- 模板（复制一份到每周条目下更新）
  - 完成点数：
  - 本周关键交付：
  - 风险与阻塞：
  - 变更与范围：
  - 下周计划：


## RACI（简版）

| Work Item                  | Solidity Team   | Oracle/Protocol   | Backend   | Growth Infra   | Risk & Quant   | Data/Analytics   | SRE   | Security   | Web/Wallet   | Docs/DevRel   | Tech PM/Arch   |
|:---------------------------|:----------------|:------------------|:----------|:---------------|:---------------|:-----------------|:------|:-----------|:-------------|:--------------|:---------------|
| 市场模板与内核             | R               |                   |           |                |                |                  | I     | C          |              |               | A              |
| AMM/LMSR/联动              | R               |                   | C         |                | C              |                  |       |            |              |               | A              |
| UMA OO接入与结算           | C               | R                 |           |                |                |                  |       | C          |              |               | A              |
| 串关与相关性               | R               |                   | C         |                | C              |                  |       |            |              |               | A              |
| Referral/Rewards/Campaign  | R               |                   | C         | C              |                |                  |       |            |              |               | A              |
| Subgraph与指标             |                 |                   | C         |                |                | R                |       |            |              |               | A              |
| Indexer/Keeper/Rewards服务 |                 |                   | R         |                |                |                  | C     |            |              |               | A              |
| CI/CD与环境                |                 |                   |           |                |                |                  | R     | C          |              |               | A              |
| 安全测试与审计             | C               |                   |           |                |                |                  |       | R          |              |               | A              |
| 最小前端                   |                 |                   |           |                |                |                  |       |            | R            |               | A              |
| 文档与准入标准             |                 |                   |           |                |                |                  |       | C          |              | R             | A              |