
services:
  # ============================================================================
  # Graph Node 专用 PostgreSQL
  # ============================================================================
  graph-postgres:
    image: postgres:14
    container_name: graph-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Performance tuning for Graph Node
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    ports:
      - "5433:${POSTGRES_PORT}"
    volumes:
      - graph_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 10
    command:
      - "postgres"
      - "-cshared_preload_libraries=pg_stat_statements"
      - "-cmax_connections=200"
    networks:
      - graph-network

  # ============================================================================
  # IPFS - 存储 Subgraph 清单和编译后的 WASM 模块
  # ============================================================================
  ipfs:
    image: ipfs/kubo:v0.22.0
    container_name: graph-ipfs
    ports:
      - "${IPFS_API_PORT}:5001"  # API
      - "8080:8080"  # Gateway (optional)
    volumes:
      - ipfs_data:/data/ipfs
    environment:
      IPFS_PROFILE: server
      IPFS_PATH: /data/ipfs
    networks:
      - graph-network

  # ============================================================================
  # Graph Node - The Graph 协议索引节点
  # ============================================================================
  graph-node:
    image: graphprotocol/graph-node:v0.34.1
    container_name: graph-node
    ports:
      - "${GRAPH_NODE_HTTP_PORT}:8000"   # GraphQL HTTP server
      - "${GRAPH_NODE_WS_PORT}:8001"   # GraphQL WebSocket server
      - "${GRAPH_NODE_ADMIN_PORT}:8020"   # JSON-RPC admin server
      - "${GRAPH_NODE_INDEX_PORT}:8030"   # Subgraph indexing status server
      - "${GRAPH_NODE_METRICS_PORT}:8040"   # Prometheus metrics
    depends_on:
      graph-postgres:
        condition: service_healthy
      ipfs:
        condition: service_started
    environment:
      # PostgreSQL 连接配置
      postgres_host: graph-postgres
      postgres_port: ${POSTGRES_PORT}
      postgres_user: ${POSTGRES_USER}
      postgres_pass: ${POSTGRES_PASSWORD}
      postgres_db: ${POSTGRES_DB}

      # IPFS 配置
      ipfs: 'ipfs:5001'

      # Ethereum 网络配置
      # localhost 指向本地 Anvil
      ethereum: 'localhost:http://192.168.50.251:8545'

      # 日志级别
      GRAPH_LOG: debug

      # 允许非确定性 IPFS 访问（开发环境使用）
      GRAPH_ALLOW_NON_DETERMINISTIC_IPFS: 'true'

      # Ethereum 轮询间隔（毫秒）
      ETHEREUM_POLLING_INTERVAL: 500

      # 存储配置
      GRAPH_ETHEREUM_TARGET_TRIGGERS_PER_BLOCK_RANGE: 100
      GRAPH_ETHEREUM_MAX_BLOCK_RANGE_SIZE: 1000

    extra_hosts:
      # 允许容器访问宿主机上的 Anvil
      - "host.docker.internal:host-gateway"
    networks:
      - graph-network
    restart: unless-stopped

networks:
  graph-network:
    driver: bridge

volumes:
  graph_postgres_data:
    driver: local
  ipfs_data:
    driver: local
