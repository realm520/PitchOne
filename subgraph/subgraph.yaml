specVersion: 0.0.6
description: PitchOne Decentralized Sportsbook Subgraph (V4 Architecture)
repository: https://github.com/pitchone/pitchone
schema:
  file: ./schema.graphql
dataSources:
  # ============================================================================
  # MarketFactory_V3 - 监听市场创建事件，动态索引新市场
  # 地址来源: Deploy_V3.s.sol 部署输出
  # ============================================================================
  - kind: ethereum/contract
    name: MarketFactory
    network: localhost
    source:
      address: "0x0000000000000000000000000000000000000000"  # TODO: 部署后更新
      abi: MarketFactory_V3
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Template
        - GlobalStats
      abis:
        - name: MarketFactory_V3
          file: ../contracts/out/MarketFactory_V3.sol/MarketFactory_V3.json
        - name: Market_V3
          file: ../contracts/out/Market_V3.sol/Market_V3.json
      eventHandlers:
        - event: MarketCreated(indexed address,indexed bytes32,string,uint256)
          handler: handleMarketCreatedV4
        - event: TemplateRegistered(indexed bytes32,string,string)
          handler: handleTemplateRegisteredV4
        - event: TemplateUpdated(indexed bytes32,bool)
          handler: handleTemplateUpdatedV4
      file: ./src/registry.ts

  # ============================================================================
  # FeeRouter - 费用分发事件
  # ============================================================================
  - kind: ethereum/contract
    name: FeeRouter
    network: localhost
    source:
      address: "0x0000000000000000000000000000000000000000"  # TODO: 部署后更新
      abi: FeeRouter
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - FeeDistribution
        - GlobalStats
      abis:
        - name: FeeRouter
          file: ../contracts/out/FeeRouter.sol/FeeRouter.json
      eventHandlers:
        - event: FeeReceived(indexed address,indexed address,uint256)
          handler: handleFeeReceived
        - event: FeeRouted(indexed address,uint256,indexed address,uint256,uint256,uint256,uint256,uint256)
          handler: handleFeeRouted
      file: ./src/fee.ts

  # ============================================================================
  # LiquidityVault_V3 - V3 流动性金库
  # ============================================================================
  - kind: ethereum/contract
    name: LiquidityVault_V3
    network: localhost
    source:
      address: "0x0000000000000000000000000000000000000000"  # TODO: 部署后更新
      abi: LiquidityVault_V3
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - LiquidityProvider
        - LiquidityBorrowEvent
        - MarketAuthorization
      abis:
        - name: LiquidityVault_V3
          file: ../contracts/out/LiquidityVault_V3.sol/LiquidityVault_V3.json
      eventHandlers:
        - event: Deposit(indexed address,indexed address,uint256,uint256)
          handler: handleVaultDeposit
        - event: Withdraw(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleVaultWithdraw
      file: ./src/provider.ts

  # ============================================================================
  # ReferralRegistry - 推荐关系注册表
  # ============================================================================
  - kind: ethereum/contract
    name: ReferralRegistry
    network: localhost
    source:
      address: "0x0000000000000000000000000000000000000000"  # TODO: 部署后更新
      abi: ReferralRegistry
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Referral
        - ReferrerStats
        - ReferralReward
        - User
      abis:
        - name: ReferralRegistry
          file: ../contracts/out/ReferralRegistry.sol/ReferralRegistry.json
      eventHandlers:
        - event: ReferralBound(indexed address,indexed address,indexed uint256,uint256)
          handler: handleReferralBound
        - event: ReferralAccrued(indexed address,indexed address,uint256,uint256)
          handler: handleReferralAccrued
      file: ./src/referral.ts

# ============================================================================
# 动态模板配置 - 用于自动索引新创建的市场
# V4 架构：所有市场使用统一的 Market_V3 合约
# ============================================================================
templates:
  # Market_V3 统一市场模板
  - kind: ethereum/contract
    name: Market_V3
    network: localhost
    source:
      abi: Market_V3
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: Market_V3
          file: ../contracts/out/Market_V3.sol/Market_V3.json
      eventHandlers:
        # 市场初始化 (V3: 带 indexed marketId)
        - event: MarketInitialized(indexed bytes32,string,address,address,uint256)
          handler: handleMarketInitialized
        # 下注事件
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256)
          handler: handleBetPlacedV3
        # 市场状态变更
        - event: MarketLocked(uint256)
          handler: handleMarketLocked
        - event: MarketResolved(uint256[],uint256[])
          handler: handleMarketResolved
        - event: MarketFinalized(uint256)
          handler: handleMarketFinalized
        - event: MarketCancelled(string)
          handler: handleMarketCancelled
        # 结算事件
        - event: PayoutClaimed(indexed address,indexed uint256,uint256,uint256)
          handler: handlePayoutClaimed
        - event: RefundClaimed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRefundClaimed
        # ERC-1155 转账
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts
