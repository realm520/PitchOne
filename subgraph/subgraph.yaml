specVersion: 0.0.6
description: PitchOne Decentralized Sportsbook Subgraph (V3 Architecture)
repository: https://github.com/pitchone/pitchone
schema:
  file: ./schema.graphql
dataSources:
  # ============================================================================
  # MarketFactory_V3 - 监听市场创建事件，动态索引新市场
  # ============================================================================
  - kind: ethereum/contract
    name: MarketFactory
    network: localhost
    source:
      address: "0xE3011A37A904aB90C8881a99BD1F6E21401f1522"
      abi: MarketFactory_V3
      startBlock: 1
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Template
        - GlobalStats
        - Admin
        - RoleChange
      abis:
        - name: MarketFactory_V3
          file: ../contracts/out/MarketFactory_V3.sol/MarketFactory_V3.json
        - name: Market_V3
          file: ../contracts/out/Market_V3.sol/Market_V3.json
        - name: IPricingStrategy
          file: ../contracts/out/IPricingStrategy.sol/IPricingStrategy.json
      eventHandlers:
        - event: MarketCreated(indexed address,indexed bytes32,string,uint256)
          handler: handleMarketCreatedFromFactory
        - event: TemplateRegistered(indexed bytes32,string,string)
          handler: handleTemplateRegistered
        - event: TemplateUpdated(indexed bytes32,bool)
          handler: handleTemplateUpdated
        - event: RoleGranted(indexed bytes32,indexed address,indexed address)
          handler: handleRoleGranted
        - event: RoleRevoked(indexed bytes32,indexed address,indexed address)
          handler: handleRoleRevoked
        - event: KeeperAdded(indexed address)
          handler: handleKeeperAdded
        - event: KeeperRemoved(indexed address)
          handler: handleKeeperRemoved
      file: ./src/registry.ts

  # ============================================================================
  # BettingRouter_V3 - 下注路由（包含手续费信息）
  # ============================================================================
  - kind: ethereum/contract
    name: BettingRouter
    network: localhost
    source:
      address: "0x3347B4d90ebe72BeFb30444C9966B2B990aE9FcB"
      abi: BettingRouter_V3
      startBlock: 1
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Order
        - Position
        - User
        - Market
        - GlobalStats
        - OutcomeVolume
      abis:
        - name: BettingRouter_V3
          file: ../contracts/out/BettingRouter_V3.sol/BettingRouter_V3.json
        - name: Market_V3
          file: ../contracts/out/Market_V3.sol/Market_V3.json
      eventHandlers:
        - event: BetPlaced(indexed address,indexed address,indexed address,uint256,uint256,uint256,uint256)
          handler: handleRouterBetPlaced
      file: ./src/router.ts

  # ============================================================================
  # FeeRouter - 费用分发事件
  # ============================================================================
  - kind: ethereum/contract
    name: FeeRouter
    network: localhost
    source:
      address: "0x114e375B6FCC6d6fCb68c7A1d407E652C54F25FB"
      abi: FeeRouter
      startBlock: 1
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - FeeDistribution
        - GlobalStats
      abis:
        - name: FeeRouter
          file: ../contracts/out/FeeRouter.sol/FeeRouter.json
      eventHandlers:
        - event: FeeReceived(indexed address,indexed address,uint256)
          handler: handleFeeReceived
        - event: FeeRouted(indexed address,uint256,indexed address,uint256,uint256,uint256,uint256,uint256)
          handler: handleFeeRouted
      file: ./src/fee.ts

  # ============================================================================
  # LiquidityVault_V3 - LP 金库事件
  # ============================================================================
  - kind: ethereum/contract
    name: LiquidityVault
    network: localhost
    source:
      address: "0x162700d1613DfEC978032A909DE02643bC55df1A"
      abi: LiquidityVault_V3
      startBlock: 1
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - LiquidityProvider
        - LiquidityEvent
      abis:
        - name: LiquidityVault_V3
          file: ../contracts/out/LiquidityVault_V3.sol/LiquidityVault_V3.json
      eventHandlers:
        - event: Deposit(indexed address,indexed address,uint256,uint256)
          handler: handleDeposit
        - event: Withdraw(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleWithdraw
        - event: MarketAuthorized(indexed address,uint256)
          handler: handleMarketAuthorized
        - event: MarketRevoked(indexed address)
          handler: handleMarketRevoked
      file: ./src/provider.ts

  # ============================================================================
  # ReferralRegistry - 推荐关系注册表
  # ============================================================================
  - kind: ethereum/contract
    name: ReferralRegistry
    network: localhost
    source:
      address: "0x67aD6EA566BA6B0fC52e97Bc25CE46120fdAc04c"
      abi: ReferralRegistry
      startBlock: 1
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Referral
        - ReferrerStats
        - ReferralReward
        - User
      abis:
        - name: ReferralRegistry
          file: ../contracts/out/ReferralRegistry.sol/ReferralRegistry.json
      eventHandlers:
        - event: ReferralBound(indexed address,indexed address,indexed uint256,uint256)
          handler: handleReferralBound
        - event: ReferralAccrued(indexed address,indexed address,uint256,uint256)
          handler: handleReferralAccrued
      file: ./src/referral.ts

# ============================================================================
# 动态模板配置 - V3 统一市场模板
# ============================================================================
templates:
  # Market_V3 统一市场模板（支持所有玩法类型）
  - kind: ethereum/contract
    name: Market_V3
    network: localhost
    source:
      abi: Market_V3
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
        - OutcomeVolume
      abis:
        - name: Market_V3
          file: ../contracts/out/Market_V3.sol/Market_V3.json
        - name: IPricingStrategy
          file: ../contracts/out/IPricingStrategy.sol/IPricingStrategy.json
      eventHandlers:
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: MarketLocked(uint256)
          handler: handleMarketLocked
        - event: MarketResolved(uint256[],uint256[])
          handler: handleMarketResolved
        - event: MarketFinalized(uint256)
          handler: handleMarketFinalized
        - event: MarketCancelled(string)
          handler: handleMarketCancelled
        - event: PayoutClaimed(indexed address,indexed uint256,uint256,uint256)
          handler: handlePayoutClaimed
        - event: RefundClaimed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRefundClaimed
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
        - event: Paused(address)
          handler: handlePaused
        - event: Unpaused(address)
          handler: handleUnpaused
      file: ./src/market.ts
