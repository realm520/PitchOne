specVersion: 0.0.6
description: PitchOne Decentralized Sportsbook Subgraph (Dynamic Templates)
repository: https://github.com/pitchone/pitchone
schema:
  file: ./schema.graphql
dataSources:
  # ============================================================================
  # MarketFactory_v2 - 监听市场创建事件，动态索引新市场
  # 地址来源: Auto-generated from deployments JSON
  # ============================================================================
  - kind: ethereum/contract
    name: MarketFactory
    network: localhost
    source:
      address: "0xA7c59f010700930003b33aB25a7a0679C860f29c"
      abi: MarketFactory_v2
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Template
        - GlobalStats
      abis:
        - name: MarketFactory_v2
          file: ../contracts/out/MarketFactory_v2.sol/MarketFactory_v2.json
        - name: WDL_Template_V2
          file: ../contracts/out/WDL_Template_V2.sol/WDL_Template_V2.json
        - name: OU_Template_V2
          file: ../contracts/out/OU_Template_V2.sol/OU_Template_V2.json
        - name: OU_MultiLine_V2
          file: ../contracts/out/OU_MultiLine_V2.sol/OU_MultiLine_V2.json
        - name: OddEven_Template_V2
          file: ../contracts/out/OddEven_Template_V2.sol/OddEven_Template_V2.json
        - name: AH_Template_V2
          file: ../contracts/out/AH_Template_V2.sol/AH_Template_V2.json
        - name: ScoreTemplate_V2
          file: ../contracts/out/ScoreTemplate_V2.sol/ScoreTemplate_V2.json
        - name: PlayerProps_Template_V2
          file: ../contracts/out/PlayerProps_Template_V2.sol/PlayerProps_Template_V2.json
        # 非 V2 版本的模板 ABI（用于 registry.ts 中的合约调用）
        - name: WDL_Template
          file: ../contracts/out/WDL_Template.sol/WDL_Template.json
        - name: OU_Template
          file: ../contracts/out/OU_Template.sol/OU_Template.json
        - name: OU_MultiLine
          file: ../contracts/out/OU_MultiLine.sol/OU_MultiLine.json
        - name: OddEven_Template
          file: ../contracts/out/OddEven_Template.sol/OddEven_Template.json
        - name: AH_Template
          file: ../contracts/out/AH_Template.sol/AH_Template.json
        - name: ScoreTemplate
          file: ../contracts/out/ScoreTemplate.sol/ScoreTemplate.json
        - name: PlayerProps_Template
          file: ../contracts/out/PlayerProps_Template.sol/PlayerProps_Template.json
      eventHandlers:
        - event: MarketCreated(indexed address,indexed bytes32,indexed address)
          handler: handleMarketCreatedFromRegistry
        - event: TemplateRegistered(indexed bytes32,indexed address,string,string)
          handler: handleTemplateRegistered
        - event: TemplateActiveStatusUpdated(indexed bytes32,bool)
          handler: handleTemplateActiveStatusUpdated
      file: ./src/registry.ts

  # ============================================================================
  # FeeRouter - 费用分发事件
  # 地址来源: Auto-generated from deployments JSON
  # ============================================================================
  - kind: ethereum/contract
    name: FeeRouter
    network: localhost
    source:
      address: "0x22753E4264FDDc6181dc7cce468904A80a363E44"
      abi: FeeRouter
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - FeeDistribution
        - GlobalStats
      abis:
        - name: FeeRouter
          file: ../contracts/out/FeeRouter.sol/FeeRouter.json
      eventHandlers:
        - event: FeeReceived(indexed address,indexed address,uint256)
          handler: handleFeeReceived
        - event: FeeRouted(indexed address,uint256,indexed address,uint256,uint256,uint256,uint256,uint256)
          handler: handleFeeRouted
      file: ./src/fee.ts

  # ============================================================================
  # LiquidityProviderFactory - 流动性提供者工厂
  # 地址来源: 需要从 Deploy.s.sol 部署输出更新
  # ============================================================================
  - kind: ethereum/contract
    name: LiquidityProviderFactory
    network: localhost
    source:
      address: "0x4b6aB5F819A515382B0dEB6935D793817bB4af28"
      abi: LiquidityProviderFactory
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - LiquidityProviderFactory
        - ProviderTypeRegistration
        - ProviderDeployment
        - LiquidityProvider
      abis:
        - name: LiquidityProviderFactory
          file: ./abis/LiquidityProviderFactory.json
        - name: ERC4626LiquidityProvider
          file: ./abis/ERC4626LiquidityProvider.json
      eventHandlers:
        - event: ProviderTypeRegistered(indexed string,address)
          handler: handleProviderTypeRegistered
        - event: ProviderDeployed(indexed address,indexed string,indexed address,uint256)
          handler: handleProviderDeployed
        - event: DeployerAuthorized(indexed address,bool)
          handler: handleDeployerAuthorized
      file: ./src/provider.ts

  # ============================================================================
  # ERC4626LiquidityProvider - ERC-4626 标准流动性提供者（默认）
  # 地址来源: 需要从 Deploy.s.sol 部署输出更新
  # ============================================================================
  - kind: ethereum/contract
    name: ERC4626LiquidityProvider
    network: localhost
    source:
      address: "0xCace1b78160AE76398F486c8a18044da0d66d86D"
      abi: ERC4626LiquidityProvider
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - LiquidityProvider
        - LiquidityBorrowEvent
        - MarketAuthorization
      abis:
        - name: ERC4626LiquidityProvider
          file: ./abis/ERC4626LiquidityProvider.json
      eventHandlers:
        - event: LiquidityBorrowed(indexed address,uint256,uint256)
          handler: handleLiquidityBorrowed
        - event: LiquidityRepaid(indexed address,uint256,uint256,uint256)
          handler: handleLiquidityRepaid
        - event: MarketAuthorizationChanged(indexed address,bool)
          handler: handleMarketAuthorizationChanged
        - event: Paused(address)
          handler: handlePaused
        - event: Unpaused(address)
          handler: handleUnpaused
      file: ./src/provider.ts

  # ============================================================================
  # ParimutuelLiquidityProvider - 彩池模式流动性提供者（备用）
  # 地址来源: 需要从 Deploy.s.sol 部署输出更新
  # ============================================================================
  - kind: ethereum/contract
    name: ParimutuelLiquidityProvider
    network: localhost
    source:
      address: "0xD5ac451B0c50B9476107823Af206eD814a2e2580"
      abi: ParimutuelLiquidityProvider
      startBlock: 0
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - LiquidityProvider
        - LiquidityBorrowEvent
        - PoolContribution
        - MarketAuthorization
      abis:
        - name: ParimutuelLiquidityProvider
          file: ./abis/ParimutuelLiquidityProvider.json
        - name: ERC4626LiquidityProvider
          file: ./abis/ERC4626LiquidityProvider.json
      eventHandlers:
        - event: LiquidityBorrowed(indexed address,uint256,uint256)
          handler: handleLiquidityBorrowed
        - event: LiquidityRepaid(indexed address,uint256,uint256,uint256)
          handler: handleLiquidityRepaid
        - event: PoolContribution(indexed address,uint256,uint256)
          handler: handlePoolContribution
        - event: RevenueDistributed(uint256,uint256)
          handler: handleRevenueDistributed
        - event: MarketAuthorizationChanged(indexed address,bool)
          handler: handleMarketAuthorizationChanged
      file: ./src/provider.ts

# ============================================================================
# 动态模板配置 - 用于自动索引新创建的市场
# ============================================================================
templates:
  # WDL 市场模板（胜平负）
  - kind: ethereum/contract
    name: WDLMarket
    network: localhost
    source:
      abi: WDL_Template
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: WDL_Template
          file: ../contracts/out/WDL_Template.sol/WDL_Template.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: MarketCreated(indexed string,string,string,uint256,address)
          handler: handleMarketCreated
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts

  # OU 单线市场模板（大小球）
  - kind: ethereum/contract
    name: OUMarket
    network: localhost
    source:
      abi: OU_Template
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: OU_Template
          file: ../contracts/out/OU_Template.sol/OU_Template.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: MarketCreated(indexed string,string,string,uint256,uint256,address)
          handler: handleOUMarketCreated
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts

  # OU 多线市场模板（大小球多盘口）
  - kind: ethereum/contract
    name: OUMultiMarket
    network: localhost
    source:
      abi: OU_MultiLine
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: OU_MultiLine
          file: ../contracts/out/OU_MultiLine.sol/OU_MultiLine.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: MarketCreated(indexed string,string,string,uint256,uint256[],bytes32,address,address)
          handler: handleOUMultiLineMarketCreated
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts

  # OddEven 市场模板（进球数单双）
  - kind: ethereum/contract
    name: OddEvenMarket
    network: localhost
    source:
      abi: OddEven_Template
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: OddEven_Template
          file: ../contracts/out/OddEven_Template.sol/OddEven_Template.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: MarketCreated(indexed string,string,string,uint256,address)
          handler: handleOddEvenMarketCreated
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts

  # AH 让球市场模板
  - kind: ethereum/contract
    name: AHMarket
    network: localhost
    source:
      abi: AH_Template
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: AH_Template
          file: ../contracts/out/AH_Template.sol/AH_Template.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: AHMarketCreated(indexed string,string,string,uint256,int256,uint8,uint8,address)
          handler: handleAHMarketCreated
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts

  # Score 精确比分市场模板
  - kind: ethereum/contract
    name: ScoreMarket
    network: localhost
    source:
      abi: ScoreTemplate
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: ScoreTemplate
          file: ../contracts/out/ScoreTemplate.sol/ScoreTemplate.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts

  # PlayerProps 球员道具市场模板
  - kind: ethereum/contract
    name: PlayerPropsMarket
    network: localhost
    source:
      abi: PlayerProps_Template
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      entities:
        - Market
        - Order
        - Position
        - Redemption
        - User
        - GlobalStats
      abis:
        - name: PlayerProps_Template
          file: ../contracts/out/PlayerProps_Template.sol/PlayerProps_Template.json
        - name: MarketBase
          file: ../contracts/out/MarketBase.sol/MarketBase.json
      eventHandlers:
        - event: BetPlaced(indexed address,indexed uint256,uint256,uint256,uint256)
          handler: handleBetPlaced
        - event: Locked(uint256)
          handler: handleLocked
        - event: Resolved(indexed uint256,uint256)
          handler: handleResolved
        - event: Finalized(uint256)
          handler: handleFinalized
        - event: Redeemed(indexed address,indexed uint256,uint256,uint256)
          handler: handleRedeemed
        - event: LiquidityAdded(indexed address,uint256,uint256)
          handler: handleLiquidityAdded
        - event: TransferSingle(indexed address,indexed address,indexed address,uint256,uint256)
          handler: handleTransferSingle
        - event: TransferBatch(indexed address,indexed address,indexed address,uint256[],uint256[])
          handler: handleTransferBatch
      file: ./src/market.ts
