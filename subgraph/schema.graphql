# PitchOne Subgraph Schema
# 定义所有实体和关系以支持完整的数据查询

# ============================================================================
# 市场实体
# ============================================================================

"""
Market - 博彩市场实体
代表一个特定赛事的博彩市场（如某场比赛的胜平负）
"""
type Market @entity(immutable: false) {
  "市场地址（合约地址）"
  id: ID!

  "模板 ID（WDL, OU, AH 等）"
  templateId: String!

  "赛事 ID（如 EPL_2024_MUN_vs_MCI）"
  matchId: String!

  "主队名称"
  homeTeam: String!

  "客队名称"
  awayTeam: String!

  "开赛时间（Unix 时间戳）"
  kickoffTime: BigInt!

  "规则版本"
  ruleVer: Bytes!

  "市场状态: Open, Locked, Resolved, Finalized"
  state: MarketState!

  "创建时间戳"
  createdAt: BigInt!

  "锁盘时间戳"
  lockedAt: BigInt

  "结算时间戳"
  resolvedAt: BigInt

  "最终确认时间戳"
  finalizedAt: BigInt

  "取消时间戳（V3）"
  cancelledAt: BigInt

  "取消原因（V3）"
  cancelReason: String

  "获胜结果（0=主队胜/大, 1=平局, 2=客队胜/小）"
  winnerOutcome: Int

  "结果数量（V3）"
  outcomeCount: Int

  "市场参数（编码后的 bytes）"
  params: Bytes

  "总交易量（USDC）"
  totalVolume: BigDecimal!

  "累计手续费（USDC）"
  feeAccrued: BigDecimal!

  "LP 流动性（USDC）"
  lpLiquidity: BigDecimal!

  "唯一下注用户数"
  uniqueBettors: Int!

  "预言机地址"
  oracle: Bytes

  "定价引擎地址"
  pricingEngine: Bytes

  "大小球盘口线（单线市场，如 2.5 球，存储为 2500000000000000000 即 18 位小数）"
  line: BigInt

  "是否半球盘（如 2.5 球）"
  isHalfLine: Boolean

  "大小球盘口线数组（多线市场，如 [2.0, 2.5, 3.0]）"
  lines: [BigInt!]

  "关联的订单"
  orders: [Order!]! @derivedFrom(field: "market")

  "关联的头寸"
  positions: [Position!]! @derivedFrom(field: "market")

  "关联的赎回记录"
  redemptions: [Redemption!]! @derivedFrom(field: "market")

  # ============ PlayerProps 扩展字段 ============
  "球员 ID（仅 PlayerProps 市场）"
  playerId: String

  "球员姓名（仅 PlayerProps 市场）"
  playerName: String

  "道具类型（仅 PlayerProps 市场）: GOALS_OU, ASSISTS_OU, SHOTS_OU, YELLOW_CARD, RED_CARD, ANYTIME_SCORER, FIRST_SCORER"
  propType: String

  "首球球员 ID 列表（仅 FIRST_SCORER 市场）"
  firstScorerPlayerIds: [String!]

  "首球球员姓名列表（仅 FIRST_SCORER 市场）"
  firstScorerPlayerNames: [String!]
}

enum MarketState {
  Open
  Locked
  Resolved
  Finalized
}

# ============================================================================
# 用户实体
# ============================================================================

"""
User - 用户实体
代表一个参与博彩的地址
"""
type User @entity(immutable: false) {
  "用户地址"
  id: ID!

  "总下注金额（USDC）"
  totalBetAmount: BigDecimal!

  "总赎回金额（USDC）"
  totalRedeemed: BigDecimal!

  "净盈亏（赎回 - 下注）"
  netProfit: BigDecimal!

  "下注次数"
  totalBets: Int!

  "参与的市场数"
  marketsParticipated: Int!

  "首次下注时间"
  firstBetAt: BigInt

  "最后下注时间"
  lastBetAt: BigInt

  "推荐人地址"
  referrer: Bytes

  "下单记录"
  orders: [Order!]! @derivedFrom(field: "user")

  "持仓记录"
  positions: [Position!]! @derivedFrom(field: "owner")

  "赎回记录"
  redemptions: [Redemption!]! @derivedFrom(field: "user")

  "领取的奖励"
  rewardsClaimed: [RewardClaim!]! @derivedFrom(field: "user")

  "参与的活动"
  campaignParticipations: [CampaignParticipation!]! @derivedFrom(field: "user")

  "任务进度"
  questProgresses: [QuestProgress!]! @derivedFrom(field: "user")

  "领取的任务奖励"
  questRewardsClaimed: [QuestRewardClaim!]! @derivedFrom(field: "user")

  "创建的串关"
  baskets: [Basket!]! @derivedFrom(field: "creator")
}

# ============================================================================
# 订单实体
# ============================================================================

"""
Order - 下注订单
代表一次下注操作
"""
type Order @entity(immutable: false) {
  "订单 ID（txHash-logIndex）"
  id: ID!

  "所属市场"
  market: Market!

  "下注用户"
  user: User!

  "下注方向（0=主队胜/大, 1=平局, 2=客队胜/小）"
  outcome: Int!

  "下注金额（USDC，原始 wei 值，6 decimals）"
  amount: BigInt!

  "获得的份额（Position Token 数量）"
  shares: BigInt!

  "手续费（USDC，原始 wei 值，6 decimals）"
  fee: BigInt!

  "推荐人地址（如有）"
  referrer: Bytes

  "下注时的赔率（隐含概率）"
  price: BigDecimal!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# 头寸实体
# ============================================================================

"""
Position - 用户在某市场的头寸
代表用户持有的 ERC-1155 Position Token
"""
type Position @entity(immutable: false) {
  "头寸 ID（market-user-outcome）"
  id: ID!

  "所属市场"
  market: Market!

  "持有人"
  owner: User!

  "头寸方向（0=主队胜/大, 1=平局, 2=客队胜/小）"
  outcome: Int!

  "持有份额"
  balance: BigInt!

  "平均成本（USDC per share）"
  averageCost: BigDecimal!

  "累计投入（USDC）"
  totalInvested: BigDecimal!

  "最后更新时间"
  lastUpdatedAt: BigInt!
}

# ============================================================================
# 赎回实体
# ============================================================================

"""
Redemption - 赎回记录
用户兑付赢得的头寸
"""
type Redemption @entity(immutable: false) {
  "赎回 ID（txHash-logIndex）"
  id: ID!

  "所属市场"
  market: Market!

  "赎回用户"
  user: User!

  "赎回的方向"
  outcome: Int!

  "赎回的份额"
  shares: BigInt!

  "获得的金额（USDC）"
  payout: BigDecimal!

  "是否为退款（市场取消时）"
  isRefund: Boolean

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# 预言机相关实体
# ============================================================================

"""
OracleProposal - 预言机提案
结算结果的提案和争议记录
"""
type OracleProposal @entity(immutable: false) {
  "提案 ID（oracle-marketId-proposalId）"
  id: ID!

  "预言机地址"
  oracle: Bytes!

  "关联市场"
  market: Market

  "提案者地址"
  proposer: Bytes!

  "提案结果"
  result: Int!

  "质押金额"
  bond: BigDecimal!

  "提案时间"
  proposedAt: BigInt!

  "是否被争议"
  disputed: Boolean!

  "争议者地址"
  disputer: Bytes

  "争议时间"
  disputedAt: BigInt

  "是否已最终确认"
  finalized: Boolean!

  "最终确认时间"
  finalizedAt: BigInt

  "最终结果（可能与提案不同）"
  finalResult: Int
}

# ============================================================================
# 奖励相关实体
# ============================================================================

"""
RewardClaim - 奖励领取记录
用户领取 Merkle 奖励的记录
"""
type RewardClaim @entity(immutable: false) {
  "领取 ID（txHash-logIndex）"
  id: ID!

  "领取用户"
  user: User!

  "周期编号"
  week: BigInt!

  "领取金额"
  amount: BigDecimal!

  "奖励类型（referral, campaign, quest 等）"
  rewardType: String

  "领取时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# 费用相关实体
# ============================================================================

"""
FeeDistribution - 费用分发记录
记录手续费的分配情况
"""
type FeeDistribution @entity(immutable: false) {
  "分发 ID（txHash-logIndex）"
  id: ID!

  "代币地址"
  token: Bytes!

  "接收方地址"
  recipient: Bytes!

  "分发金额"
  amount: BigDecimal!

  "分类（lp, promo, insurance, treasury）"
  category: String!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# Basket（串关）实体
# ============================================================================

"""
Basket - 串关市场
代表用户创建的多市场组合下注
"""
type Basket @entity(immutable: false) {
  "Basket ID（合约地址-basketId）"
  id: ID!

  "创建者"
  creator: User!

  "包含的市场地址列表"
  markets: [Bytes!]!

  "每个市场对应的结果选择（outcome）"
  outcomes: [Int!]!

  "市场数量"
  marketCount: Int!

  "总下注金额（USDC）"
  totalStake: BigDecimal!

  "组合赔率（18 decimals）"
  combinedOdds: BigDecimal!

  "相关性折扣（基点，如 9800 = 98%）"
  correlationDiscount: Int!

  "折扣后赔率"
  adjustedOdds: BigDecimal!

  "潜在赢利"
  potentialPayout: BigDecimal!

  "状态: Pending, Won, Lost, Refunded"
  status: BasketStatus!

  "实际赔付金额（结算后）"
  actualPayout: BigDecimal

  "创建时间"
  createdAt: BigInt!

  "结算时间"
  settledAt: BigInt

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

enum BasketStatus {
  Pending
  Won
  Lost
  Refunded
}

"""
CorrelationRule - 相关性规则
记录 CorrelationGuard 中定义的相关性规则
"""
type CorrelationRule @entity(immutable: false) {
  "规则 ID（ruleHash）"
  id: ID!

  "市场模板 A（如 WDL）"
  templateA: String!

  "市场模板 B（如 OU）"
  templateB: String!

  "赛事 A（matchId）"
  matchA: String!

  "赛事 B（matchId）"
  matchB: String!

  "结果方向 A"
  outcomeA: Int!

  "结果方向 B"
  outcomeB: Int!

  "惩罚类型: Discount, Block"
  penaltyType: PenaltyType!

  "折扣比例（基点，仅 Discount 类型有效）"
  discountBps: Int

  "是否启用"
  isActive: Boolean!

  "创建时间"
  createdAt: BigInt!

  "创建者"
  creator: Bytes!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!

  "应用记录"
  applications: [CorrelationApplication!]! @derivedFrom(field: "rule")
}

enum PenaltyType {
  Discount
  Block
}

"""
CorrelationApplication - 相关性规则应用记录
记录规则被应用到具体 Basket 的情况
"""
type CorrelationApplication @entity(immutable: false) {
  "应用 ID（txHash-logIndex）"
  id: ID!

  "应用的规则"
  rule: CorrelationRule!

  "关联的 Basket"
  basket: Basket!

  "应用的折扣比例（基点）"
  appliedDiscountBps: Int!

  "应用前赔率"
  oddsBeforeDiscount: BigDecimal!

  "应用后赔率"
  oddsAfterDiscount: BigDecimal!

  "应用时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# 模板注册实体
# ============================================================================

"""
Template - 市场模板
记录已注册的市场模板（WDL, OU, AH 等）
"""
type Template @entity(immutable: false) {
  "模板地址"
  id: ID!

  "模板 ID（bytes32）"
  templateId: Bytes!

  "模板名称"
  name: String

  "是否激活"
  active: Boolean!

  "注册时间"
  registeredAt: BigInt!
}

# ============================================================================
# 全局统计实体
# ============================================================================

"""
GlobalStats - 全局统计
整个平台的聚合数据
"""
type GlobalStats @entity(immutable: false) {
  "固定 ID: 'global'"
  id: ID!

  "总市场数"
  totalMarkets: Int!

  "总用户数"
  totalUsers: Int!

  "总交易量（USDC）"
  totalVolume: BigDecimal!

  "总手续费（USDC）"
  totalFees: BigDecimal!

  "总赎回金额（USDC）"
  totalRedeemed: BigDecimal!

  "活跃市场数"
  activeMarkets: Int!

  "已结算市场数"
  resolvedMarkets: Int!

  "最后更新时间"
  lastUpdatedAt: BigInt!
}

# ============================================================================
# Campaign 活动实体
# ============================================================================

"""
Campaign - 营销活动
代表一个营销活动（如首单奖励、推荐奖励等）
"""
type Campaign @entity(immutable: false) {
  "活动 ID（bytes32 campaign ID）"
  id: ID!

  "活动名称"
  name: String!

  "规则哈希（IPFS CID）"
  ruleHash: Bytes!

  "预算上限（USDC）"
  budgetCap: BigDecimal!

  "已支出金额（USDC）"
  spentAmount: BigDecimal!

  "剩余预算（USDC）"
  remainingBudget: BigDecimal!

  "开始时间"
  startTime: BigInt!

  "结束时间"
  endTime: BigInt!

  "活动状态: Active, Paused, Ended"
  status: CampaignStatus!

  "参与人数"
  participantCount: Int!

  "创建时间"
  createdAt: BigInt!

  "最后更新时间"
  updatedAt: BigInt!

  "创建者地址"
  creator: Bytes!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!

  "关联的任务"
  quests: [Quest!]! @derivedFrom(field: "campaign")

  "参与记录"
  participations: [CampaignParticipation!]! @derivedFrom(field: "campaign")

  "预算变更记录"
  budgetChanges: [CampaignBudgetChange!]! @derivedFrom(field: "campaign")

  "状态变更记录"
  statusChanges: [CampaignStatusChange!]! @derivedFrom(field: "campaign")
}

enum CampaignStatus {
  Active
  Paused
  Ended
}

"""
CampaignParticipation - 活动参与记录
用户参与活动的记录
"""
type CampaignParticipation @entity(immutable: false) {
  "参与 ID（campaignId-userAddress）"
  id: ID!

  "所属活动"
  campaign: Campaign!

  "参与用户"
  user: User!

  "参与时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
CampaignBudgetChange - 活动预算变更记录
记录活动预算的增加或支出
"""
type CampaignBudgetChange @entity(immutable: false) {
  "变更 ID（txHash-logIndex）"
  id: ID!

  "所属活动"
  campaign: Campaign!

  "变更类型: Spent, Increased"
  changeType: BudgetChangeType!

  "变更金额"
  amount: BigDecimal!

  "变更前的预算/支出"
  oldValue: BigDecimal!

  "变更后的预算/支出"
  newValue: BigDecimal!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

enum BudgetChangeType {
  Spent
  Increased
}

"""
CampaignStatusChange - 活动状态变更记录
记录活动状态的变化（Active/Paused/Ended）
"""
type CampaignStatusChange @entity(immutable: false) {
  "变更 ID（txHash-logIndex）"
  id: ID!

  "所属活动"
  campaign: Campaign!

  "旧状态"
  oldStatus: CampaignStatus!

  "新状态"
  newStatus: CampaignStatus!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# Quest 任务实体
# ============================================================================

"""
Quest - 任务
代表一个用户任务（如首次下注、连续下注、推荐任务等）
"""
type Quest @entity(immutable: false) {
  "任务 ID（bytes32 quest ID）"
  id: ID!

  "关联的活动"
  campaign: Campaign!

  "任务类型: FIRST_BET, CONSECUTIVE_BETS, REFERRAL, VOLUME, WIN_STREAK"
  questType: QuestType!

  "任务名称"
  name: String!

  "奖励金额（USDC）"
  rewardAmount: BigDecimal!

  "目标值（根据任务类型而定：次数、金额等）"
  targetValue: BigDecimal!

  "开始时间"
  startTime: BigInt!

  "结束时间"
  endTime: BigInt!

  "任务状态: Active, Paused, Ended"
  status: QuestStatus!

  "完成人数"
  completionCount: Int!

  "创建时间"
  createdAt: BigInt!

  "最后更新时间"
  updatedAt: BigInt!

  "创建者地址"
  creator: Bytes!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!

  "用户进度记录"
  progresses: [QuestProgress!]! @derivedFrom(field: "quest")

  "奖励领取记录"
  rewardClaims: [QuestRewardClaim!]! @derivedFrom(field: "quest")

  "状态变更记录"
  statusChanges: [QuestStatusChange!]! @derivedFrom(field: "quest")
}

enum QuestType {
  FIRST_BET
  CONSECUTIVE_BETS
  REFERRAL
  VOLUME
  WIN_STREAK
}

enum QuestStatus {
  Active
  Paused
  Ended
}

"""
QuestProgress - 用户任务进度
记录用户完成任务的进度
"""
type QuestProgress @entity(immutable: false) {
  "进度 ID（questId-userAddress）"
  id: ID!

  "所属任务"
  quest: Quest!

  "用户"
  user: User!

  "当前进度值"
  currentValue: BigDecimal!

  "目标值（与 quest.targetValue 相同，方便查询）"
  targetValue: BigDecimal!

  "完成百分比（currentValue / targetValue * 100）"
  completionPercentage: BigDecimal!

  "是否已完成"
  completed: Boolean!

  "完成时间"
  completedAt: BigInt

  "是否已领取奖励"
  rewardClaimed: Boolean!

  "奖励领取时间"
  rewardClaimedAt: BigInt

  "最后更新时间"
  lastUpdateTime: BigInt!

  "创建时间"
  createdAt: BigInt!

  "进度更新记录"
  updates: [QuestProgressUpdate!]! @derivedFrom(field: "progress")
}

"""
QuestProgressUpdate - 任务进度更新记录
记录每次进度更新的详细信息
"""
type QuestProgressUpdate @entity(immutable: false) {
  "更新 ID（txHash-logIndex）"
  id: ID!

  "关联的进度记录"
  progress: QuestProgress!

  "任务"
  quest: Quest!

  "用户"
  user: User!

  "增加的进度值"
  incrementValue: BigDecimal!

  "更新前的进度"
  oldValue: BigDecimal!

  "更新后的进度"
  newValue: BigDecimal!

  "是否在此次更新中完成"
  completedInThisUpdate: Boolean!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
QuestRewardClaim - 任务奖励领取记录
记录用户领取任务奖励的详细信息
"""
type QuestRewardClaim @entity(immutable: false) {
  "领取 ID（txHash-logIndex）"
  id: ID!

  "所属任务"
  quest: Quest!

  "领取用户"
  user: User!

  "奖励金额"
  rewardAmount: BigDecimal!

  "领取时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
QuestStatusChange - 任务状态变更记录
记录任务状态的变化（Active/Paused/Ended）
"""
type QuestStatusChange @entity(immutable: false) {
  "变更 ID（txHash-logIndex）"
  id: ID!

  "所属任务"
  quest: Quest!

  "旧状态"
  oldStatus: QuestStatus!

  "新状态"
  newStatus: QuestStatus!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# 全局统计扩展（Campaign/Quest）
# ============================================================================

"""
CampaignStats - Campaign 全局统计
整个平台的活动统计数据
"""
type CampaignStats @entity(immutable: false) {
  "固定 ID: 'campaign-stats'"
  id: ID!

  "总活动数"
  totalCampaigns: Int!

  "活跃活动数"
  activeCampaigns: Int!

  "已暂停活动数"
  pausedCampaigns: Int!

  "已结束活动数"
  endedCampaigns: Int!

  "总预算（所有活动的预算上限之和）"
  totalBudget: BigDecimal!

  "已支出总额"
  totalSpent: BigDecimal!

  "总参与人次"
  totalParticipations: Int!

  "唯一参与用户数"
  uniqueParticipants: Int!

  "最后更新时间"
  lastUpdatedAt: BigInt!
}

"""
QuestStats - Quest 全局统计
整个平台的任务统计数据
"""
type QuestStats @entity(immutable: false) {
  "固定 ID: 'quest-stats'"
  id: ID!

  "总任务数"
  totalQuests: Int!

  "活跃任务数"
  activeQuests: Int!

  "已暂停任务数"
  pausedQuests: Int!

  "已结束任务数"
  endedQuests: Int!

  "总奖励金额（所有任务的奖励总和）"
  totalRewards: BigDecimal!

  "已发放奖励总额"
  totalRewardsClaimed: BigDecimal!

  "总完成人次"
  totalCompletions: Int!

  "唯一完成用户数"
  uniqueCompletors: Int!

  "各类型任务统计"
  firstBetQuests: Int!
  consecutiveBetsQuests: Int!
  referralQuests: Int!
  volumeQuests: Int!
  winStreakQuests: Int!

  "最后更新时间"
  lastUpdatedAt: BigInt!
}

# ============================================================================
# CreditToken 免佣券实体
# ============================================================================

"""
CreditType - 券种配置
免佣券的券种定义
"""
type CreditType @entity(immutable: false) {
  "券种 ID"
  id: ID!

  "面额（USDC，6 decimals）"
  value: BigDecimal!

  "折扣比例（基点，10000 = 100%）"
  discountBps: Int!

  "过期时间戳（0 = 永不过期）"
  expiresAt: BigInt!

  "最大使用次数（0 = 无限制）"
  maxUses: Int!

  "是否启用"
  isActive: Boolean!

  "元数据 URI"
  metadata: String

  "总发行量"
  totalSupply: BigInt!

  "总使用次数"
  totalUsed: BigInt!

  "创建时间"
  createdAt: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!

  "使用记录"
  usages: [CreditUsage!]! @derivedFrom(field: "creditType")
}

"""
CreditUsage - 券使用记录
记录用户使用免佣券的详情
"""
type CreditUsage @entity(immutable: false) {
  "使用 ID（txHash-logIndex）"
  id: ID!

  "券种"
  creditType: CreditType!

  "使用用户"
  user: User!

  "使用数量"
  amount: Int!

  "折扣金额（USDC）"
  discountValue: BigDecimal!

  "使用时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
CreditBalance - 用户券余额
记录用户持有的各类券余额
"""
type CreditBalance @entity(immutable: false) {
  "余额 ID（creditType-user）"
  id: ID!

  "券种"
  creditType: CreditType!

  "持有用户"
  user: Bytes!

  "余额"
  balance: BigInt!

  "已使用次数（针对有次数限制的券）"
  usedCount: Int!

  "最后更新时间"
  lastUpdatedAt: BigInt!
}

# ============================================================================
# Coupon 加成券实体
# ============================================================================

"""
CouponType - 券种配置
赔率加成券的券种定义
"""
type CouponType @entity(immutable: false) {
  "券种 ID"
  id: ID!

  "加成比例（基点，如 500 = 5%）"
  boostBps: Int!

  "使用场景: ALL, WDL_ONLY, OU_ONLY, AH_ONLY, PARLAY_ONLY"
  scope: String!

  "最低下注额（USDC，0 = 无限制）"
  minBetAmount: BigDecimal!

  "最大赔率限制（18 decimals，0 = 无限制）"
  maxOdds: BigDecimal!

  "过期时间戳（0 = 永不过期）"
  expiresAt: BigInt!

  "最大使用次数（0 = 无限制）"
  maxUses: Int!

  "是否启用"
  isActive: Boolean!

  "元数据 URI"
  metadata: String

  "总发行量"
  totalSupply: BigInt!

  "总使用次数"
  totalUsed: BigInt!

  "创建时间"
  createdAt: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!

  "使用记录"
  usages: [CouponUsage!]! @derivedFrom(field: "couponType")
}

"""
CouponUsage - 券使用记录
记录用户使用加成券的详情
"""
type CouponUsage @entity(immutable: false) {
  "使用 ID（txHash-logIndex）"
  id: ID!

  "券种"
  couponType: CouponType!

  "使用用户"
  user: User!

  "关联市场"
  market: Bytes!

  "下注金额（USDC）"
  betAmount: BigDecimal!

  "原始赔率"
  originalOdds: BigDecimal!

  "加成后赔率"
  boostedOdds: BigDecimal!

  "使用时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
CouponBalance - 用户券余额
记录用户持有的各类加成券余额
"""
type CouponBalance @entity(immutable: false) {
  "余额 ID（couponType-user）"
  id: ID!

  "券种"
  couponType: CouponType!

  "持有用户"
  user: Bytes!

  "余额"
  balance: BigInt!

  "已使用次数（针对有次数限制的券）"
  usedCount: Int!

  "最后更新时间"
  lastUpdatedAt: BigInt!
}

# ============================================================================
# PayoutScaler 预算缩放实体
# ============================================================================

"""
BudgetPool - 预算池
记录各个预算池的状态
"""
type BudgetPool @entity(immutable: false) {
  "预算池 ID: PROMO, CAMPAIGN, QUEST, INSURANCE"
  id: ID!

  "总预算"
  totalBudget: BigDecimal!

  "已使用预算"
  usedBudget: BigDecimal!

  "待发放金额"
  pendingPayout: BigDecimal!

  "可用预算"
  availableBudget: BigDecimal!

  "最后充值时间"
  lastRefillAt: BigInt!

  "是否启用自动缩放"
  autoScaleEnabled: Boolean!

  "最后更新时间"
  lastUpdatedAt: BigInt!

  "充值记录"
  refills: [BudgetRefill!]! @derivedFrom(field: "pool")

  "缩放记录"
  scalings: [ScalingRecord!]! @derivedFrom(field: "pool")
}

"""
BudgetRefill - 预算充值记录
记录预算池的充值操作
"""
type BudgetRefill @entity(immutable: false) {
  "充值 ID（txHash-logIndex）"
  id: ID!

  "预算池"
  pool: BudgetPool!

  "充值金额"
  amount: BigDecimal!

  "充值后总预算"
  newTotal: BigDecimal!

  "充值时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
ScalingRecord - 缩放记录
记录预算缩放计算的详细信息
"""
type ScalingRecord @entity(immutable: false) {
  "记录 ID（txHash-logIndex）"
  id: ID!

  "预算池"
  pool: BudgetPool!

  "周期编号（如周编号）"
  period: BigInt!

  "请求金额"
  requestedAmount: BigDecimal!

  "可用预算"
  availableBudget: BigDecimal!

  "缩放比例（基点）"
  scaleBps: Int!

  "缩放后金额"
  scaledAmount: BigDecimal!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
BudgetUsage - 预算使用记录
记录实际发放后的预算使用
"""
type BudgetUsage @entity(immutable: false) {
  "使用 ID（txHash-logIndex）"
  id: ID!

  "预算池"
  pool: BudgetPool!

  "周期编号"
  period: BigInt!

  "使用金额"
  amount: BigDecimal!

  "剩余预算"
  remainingBudget: BigDecimal!

  "使用时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================
# Liquidity Provider Entities
# ============================================================

"""
LiquidityProvider - 流动性提供者
记录各类 Provider 实例（ERC4626、Parimutuel 等）
"""
type LiquidityProvider @entity(immutable: false) {
  "Provider 合约地址"
  id: ID!

  "Provider 类型（ERC4626, Parimutuel）"
  providerType: String!

  "底层资产（USDC）"
  asset: Bytes!

  "总流动性"
  totalLiquidity: BigDecimal!

  "可用流动性"
  availableLiquidity: BigDecimal!

  "已借出流动性"
  totalBorrowed: BigDecimal!

  "利用率（基点，0-10000）"
  utilizationRate: Int!

  "已授权的市场列表"
  authorizedMarkets: [Bytes!]!

  "借贷事件"
  borrowEvents: [LiquidityBorrowEvent!]! @derivedFrom(field: "provider")

  "池贡献记录（仅 Parimutuel）"
  contributions: [PoolContribution!]! @derivedFrom(field: "provider")

  "部署者地址"
  deployer: Bytes!

  "部署时间"
  createdAt: BigInt!

  "部署区块号"
  createdAtBlock: BigInt!

  "部署交易哈希"
  createdAtTransaction: Bytes!

  "是否已暂停"
  isPaused: Boolean!

  "最后更新时间"
  lastUpdatedAt: BigInt!

  "最后更新区块号"
  lastUpdatedAtBlock: BigInt!
}

"""
LiquidityProviderFactory - 流动性提供者工厂
记录 Factory 合约的状态和部署历史
"""
type LiquidityProviderFactory @entity(immutable: false) {
  "Factory 合约地址"
  id: ID!

  "所有者地址"
  owner: Bytes!

  "已注册的 Provider 类型"
  registeredTypes: [ProviderTypeRegistration!]! @derivedFrom(field: "factory")

  "已部署的 Provider 列表"
  deployedProviders: [ProviderDeployment!]! @derivedFrom(field: "factory")

  "已授权的 Deployer 列表"
  authorizedDeployers: [Bytes!]!

  "总部署数量"
  totalDeployments: BigInt!

  "创建时间"
  createdAt: BigInt!

  "创建区块号"
  createdAtBlock: BigInt!
}

"""
ProviderTypeRegistration - Provider 类型注册
记录 Factory 中注册的 Provider 类型
"""
type ProviderTypeRegistration @entity(immutable: false) {
  "ID: factoryAddress-providerType"
  id: ID!

  "关联的 Factory"
  factory: LiquidityProviderFactory!

  "Provider 类型名称"
  providerType: String!

  "实现合约地址"
  implementation: Bytes!

  "注册时间"
  registeredAt: BigInt!

  "注册区块号"
  registeredAtBlock: BigInt!

  "注册交易哈希"
  registeredAtTransaction: Bytes!
}

"""
ProviderDeployment - Provider 部署记录
记录通过 Factory 部署的 Provider 实例
"""
type ProviderDeployment @entity(immutable: true) {
  "部署 ID（txHash-logIndex）"
  id: ID!

  "关联的 Factory"
  factory: LiquidityProviderFactory!

  "部署的 Provider 地址"
  provider: Bytes!

  "Provider 类型"
  providerType: String!

  "部署者地址"
  deployer: Bytes!

  "部署索引（在 Factory 中的序号）"
  deploymentIndex: BigInt!

  "部署时间"
  deployedAt: BigInt!

  "部署区块号"
  deployedAtBlock: BigInt!

  "部署交易哈希"
  deployedAtTransaction: Bytes!
}

"""
LiquidityBorrowEvent - 流动性借贷事件
记录市场从 Provider 借入和归还流动性的事件
"""
type LiquidityBorrowEvent @entity(immutable: true) {
  "事件 ID（txHash-logIndex）"
  id: ID!

  "Provider"
  provider: LiquidityProvider!

  "市场地址"
  market: Bytes!

  "事件类型（Borrow / Repay）"
  eventType: LiquidityEventType!

  "借入/归还本金"
  principal: BigDecimal!

  "归还收益（仅 Repay）"
  revenue: BigDecimal

  "事件发生时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!

  "事件发生后 Provider 状态快照"
  snapshotTotalLiquidity: BigDecimal!
  snapshotAvailableLiquidity: BigDecimal!
  snapshotUtilizationRate: Int!
}

"""
LiquidityEventType - 流动性事件类型枚举
"""
enum LiquidityEventType {
  "借入流动性"
  Borrow

  "归还流动性"
  Repay
}

"""
PoolContribution - 彩池贡献（仅 Parimutuel Provider）
记录用户向 Parimutuel 彩池的贡献
"""
type PoolContribution @entity(immutable: true) {
  "贡献 ID（txHash-logIndex）"
  id: ID!

  "Provider"
  provider: LiquidityProvider!

  "贡献者地址"
  contributor: Bytes!

  "贡献金额"
  amount: BigDecimal!

  "贡献者的累计贡献占比（基点）"
  contributionShareBps: Int!

  "贡献时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
MarketAuthorization - 市场授权事件
记录 Provider 对市场的授权/撤销授权事件
"""
type MarketAuthorization @entity(immutable: true) {
  "授权事件 ID（txHash-logIndex）"
  id: ID!

  "Provider"
  provider: LiquidityProvider!

  "市场地址"
  market: Bytes!

  "是否授权（true=授权, false=撤销）"
  authorized: Boolean!

  "授权时间"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

# ============================================================================
# 管理员角色实体
# ============================================================================

"""
Admin - 管理员实体
记录拥有 Factory 角色的地址
"""
type Admin @entity(immutable: false) {
  "管理员地址"
  id: ID!

  "是否拥有 DEFAULT_ADMIN_ROLE"
  hasAdminRole: Boolean!

  "是否拥有 OPERATOR_ROLE"
  hasOperatorRole: Boolean!

  "是否拥有 ROUTER_ROLE"
  hasRouterRole: Boolean!

  "是否拥有 KEEPER_ROLE"
  hasKeeperRole: Boolean!

  "是否拥有 ORACLE_ROLE"
  hasOracleRole: Boolean!

  "首次授予角色时间"
  firstGrantedAt: BigInt!

  "最后角色变更时间"
  lastUpdatedAt: BigInt!

  "角色变更记录"
  roleChanges: [RoleChange!]! @derivedFrom(field: "admin")
}

"""
RoleChange - 角色变更记录
记录所有 grantRole 和 revokeRole 操作
"""
type RoleChange @entity(immutable: true) {
  "变更 ID（txHash-logIndex）"
  id: ID!

  "关联的管理员"
  admin: Admin!

  "角色哈希（bytes32）"
  role: Bytes!

  "角色名称"
  roleName: String!

  "变更类型: Grant, Revoke"
  action: RoleAction!

  "授权/撤销人地址"
  sender: Bytes!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

enum RoleAction {
  Grant
  Revoke
}

# ============================================================================
# 推荐系统实体
# ============================================================================

"""
Referral - 推荐关系
记录用户推荐关系的绑定
"""
type Referral @entity(immutable: true) {
  "推荐关系 ID（referrer-referee）"
  id: ID!

  "推荐人"
  referrer: User!

  "被推荐人"
  referee: User!

  "推荐人统计（用于 @derivedFrom）"
  referrerStat: ReferrerStat!

  "活动 ID（0 = 常规推荐）"
  campaignId: BigInt!

  "绑定时间"
  boundAt: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}

"""
ReferrerStat - 推荐人统计
聚合推荐人的统计数据
"""
type ReferrerStat @entity(immutable: false) {
  "推荐人地址"
  id: ID!

  "推荐人"
  referrer: User!

  "推荐人数"
  referralCount: Int!

  "累计返佣（USDC）"
  totalRewards: BigDecimal!

  "有效推荐人数（已下注用户）"
  validReferralCount: Int!

  "最后更新时间"
  lastUpdatedAt: BigInt!

  "推荐关系列表"
  referrals: [Referral!]! @derivedFrom(field: "referrerStat")

  "返佣记录"
  rewardRecords: [ReferralReward!]! @derivedFrom(field: "referrerStat")
}

"""
ReferralReward - 返佣记录
记录推荐返佣的详细信息
"""
type ReferralReward @entity(immutable: true) {
  "返佣 ID（txHash-logIndex）"
  id: ID!

  "推荐人"
  referrer: User!

  "被推荐人"
  referee: User!

  "推荐人统计（用于 @derivedFrom）"
  referrerStat: ReferrerStat!

  "返佣金额（USDC）"
  amount: BigDecimal!

  "时间戳"
  timestamp: BigInt!

  "区块号"
  blockNumber: BigInt!

  "交易哈希"
  transactionHash: Bytes!
}
