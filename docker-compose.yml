services:
  graph-node:
    image: graphprotocol/graph-node:latest
    platform: linux/amd64
    ports:
      - "${GRAPH_NODE_HTTP_PORT}:8000"
      - "${GRAPH_NODE_WS_PORT}:8001"
      - "${GRAPH_NODE_ADMIN_PORT}:8020"
      - "${GRAPH_NODE_INDEX_PORT}:8030"
      - "${GRAPH_NODE_METRICS_PORT}:8040"
    depends_on:
      - ipfs
      - postgres
    extra_hosts:
      - host.docker.internal:host-gateway
    environment:
      postgres_host: postgres
      postgres_user: ${POSTGRES_USER}
      postgres_pass: ${POSTGRES_PASSWORD}
      postgres_db: ${POSTGRES_DB}
      ipfs: 'ipfs:5001'
      ethereum: 'mainnet:${ETHEREUM_RPC_MAINNET}'
      GRAPH_LOG: info
      RUST_BACKTRACE: 1
      GRAPH_ALLOW_NON_DETERMINISTIC_IPFS: 'true'
    volumes:
      - graph-node-data:/var/graph-node
    networks:
      - graph-net

  ipfs:
    image: ipfs/kubo:latest
    platform: linux/amd64
    ports:
      - "${IPFS_API_PORT}:5001"
    volumes:
      - ipfs-data:/data/ipfs
    networks:
      - graph-net

  postgres:
    image: postgres:latest
    platform: linux/amd64
    ports:
      - "${POSTGRES_PORT}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      # 添加应用数据库环境变量，用于初始化脚本
      APP_POSTGRES_PASSWORD: ${APP_POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # 挂载数据库初始化脚本
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - graph-net

volumes:
  postgres-data:
  ipfs-data:
  graph-node-data:

networks:
  graph-net:
    driver: bridge