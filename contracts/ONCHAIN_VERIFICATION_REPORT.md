# çœŸå®é“¾ä¸Šç”Ÿå‘½å‘¨æœŸéªŒè¯æŠ¥å‘Š

**éªŒè¯æ—¥æœŸ**: 2025-10-30
**æµ‹è¯•ç¯å¢ƒ**: Anvil æœ¬åœ°æµ‹è¯•ç½‘ (Chain ID: 31337)
**éªŒè¯è´¦æˆ·**: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266

---

## âœ… éªŒè¯çŠ¶æ€ï¼šå®Œå…¨æˆåŠŸ

å®Œæ•´çš„å¸‚åœºç”Ÿå‘½å‘¨æœŸå·²åœ¨çœŸå® Anvil é“¾ä¸ŠæˆåŠŸæ‰§è¡Œï¼Œæ‰€æœ‰èµ„é‡‘æµåŠ¨å‡å·²éªŒè¯ã€‚

---

## å·²éƒ¨ç½²åˆçº¦åœ°å€

- **Mock USDC**: `0x36C02dA8a0983159322a80FFE9F24b1acfF8B570`
- **FeeRouter**: `0x4c5859f0F772848b2D91F1D83E2Fe57935348029`
- **SimpleCPMM**: `0x1291Be112d480055DaFd8a610b7d1e203891C274`
- **WDL Market**: `0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154`

---

## æ‰§è¡Œæ­¥éª¤å’Œç»“æœ

### æ­¥éª¤ 1: åˆå§‹çŠ¶æ€æŸ¥è¯¢ âœ…

**æ—¶é—´**: Block 54

```bash
cast call 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154 "status()"
# ç»“æœ: 0 (Open - å¯ä¸‹æ³¨)

cast call 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154 "totalLiquidity()"
# ç»“æœ: 98,000,000 (98 USDC)

cast call 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154 "kickoffTime()"
# ç»“æœ: 1761823207

cast block latest | grep timestamp
# ç»“æœ: 1761837062
```

**åˆ†æ**:
- å¸‚åœºçŠ¶æ€: Open (0)
- æ€»æµåŠ¨æ€§: 98 USDC (æ¥è‡ªä¹‹å‰ VerifyDeployment è„šæœ¬çš„ 100 USDC ä¸‹æ³¨ï¼Œæ‰£é™¤ 2% æ‰‹ç»­è´¹)
- å½“å‰æ—¶é—´å·²è¶…è¿‡å¼€èµ›æ—¶é—´çº¦ 3.8 å°æ—¶ï¼Œå¯ä»¥ç›´æ¥é”ç›˜

### æ­¥éª¤ 2: é”ç›˜ (Lock) âœ…

**æ—¶é—´**: Block 55

**å‘½ä»¤**:
```bash
cast send 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154 "autoLock()" \
  --rpc-url http://127.0.0.1:8545 \
  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

**ç»“æœ**:
- âœ… äº¤æ˜“æˆåŠŸ: `0x0896c60095cc4a0364d439e9946244a90730ec9a28ce4bad7e46e744a2c96535`
- Gas ä½¿ç”¨: 66,818
- é”ç›˜æ—¶é—´: 1761837877
- å¸‚åœºçŠ¶æ€: 0 â†’ 1 (Locked)

**äº‹ä»¶**:
```
MarketLocked(lockTimestamp: 1761837877)
```

### æ­¥éª¤ 3: ç»“ç®— (Resolve) âœ…

**æ—¶é—´**: Block 56

**å‘½ä»¤**:
```bash
cast send 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154 "resolve(uint256)" 0 \
  --rpc-url http://127.0.0.1:8545 \
  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

**ç»“æœ**:
- âœ… äº¤æ˜“æˆåŠŸ: `0x5caa14ea1cfc6c7e75ac53c9509e4e7659965fd723ed7637cc82b3c444b88c54`
- Gas ä½¿ç”¨: 32,541
- è·èƒœç»“æœ: 0 (WIN)
- å¸‚åœºçŠ¶æ€: 1 â†’ 2 (Resolved)

**äº‹ä»¶**:
```
MarketResolved(winningOutcome: 0, resolveTime: 1761837884)
```

### æ­¥éª¤ 4: å¢åŠ é“¾ä¸Šæ—¶é—´ âœ…

**å‘½ä»¤**:
```bash
cast rpc anvil_increaseTime 7200 --rpc-url http://127.0.0.1:8545
# è¿”å›: 14400 (æ€»å…±å¢åŠ çš„ç§’æ•°)

cast rpc anvil_mine 1 --rpc-url http://127.0.0.1:8545
# è¿”å›: null (æˆåŠŸ)
```

**ç»“æœ**:
- âœ… æ—¶é—´å¢åŠ : 7200 ç§’ (2 å°æ—¶)
- æ–°æ—¶é—´æˆ³: 1761845117
- æ»¡è¶³äº‰è®®æœŸè¦æ±‚: lockTime (1761837877) + disputePeriod (7200) = 1761845077

### æ­¥éª¤ 5: ç»ˆç»“ (Finalize) âœ…

**æ—¶é—´**: Block 57

**è„šæœ¬**:
```bash
forge script script/FinalizeMarket.s.sol \
  --rpc-url http://127.0.0.1:8545 \
  --broadcast -vvv
```

**æ—¥å¿—è¾“å‡º**:
```
=== Finalize Market ===
Market: 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154
Current Status: 2
Lock Time: 1761837877
Dispute Period: 2 hours
Required Time: 1761845077
Current Time: 1761845117
[OK] Market finalized
Final Status: 3
```

**ç»“æœ**:
- âœ… äº¤æ˜“æˆåŠŸ
- Gas ä½¿ç”¨: 44,098
- å¸‚åœºçŠ¶æ€: 2 â†’ 3 (Finalized)

### æ­¥éª¤ 6: èµå› (Redeem) âœ…

**æ—¶é—´**: Block 58

**èµå›å‰ä½™é¢**:
```bash
cast call 0x36C02dA8a0983159322a80FFE9F24b1acfF8B570 "balanceOf(address)" \
  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
# ç»“æœ: 0x000000000000000000000000000000000000000000000000000000e8ceaf2f00
# åè¿›åˆ¶: 999,900,000,000 (999,900 USDC)
```

**è„šæœ¬**:
```bash
forge script script/RedeemWinnings.s.sol \
  --rpc-url http://127.0.0.1:8545 \
  --broadcast -vvv
```

**æ—¥å¿—è¾“å‡º**:
```
=== Redeem Winnings ===
Market: 0x5f3f1dBD7B74C6B46e8c44f98792A1dAf8d69154
Deployer: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
Status: 3
Winning Outcome: 0

Before Redemption:
  Shares: 279,300,000
  USDC Balance: 999,900 USDC
  Total Liquidity: 98 USDC

After Redemption:
  Payout: 98 USDC
  USDC Balance: 999,998 USDC
  Balance Change: 98 USDC
  Remaining Liquidity: 0 USDC

[OK] Redemption complete!
```

**èµå›åä½™é¢**:
```bash
cast call 0x36C02dA8a0983159322a80FFE9F24b1acfF8B570 "balanceOf(address)" \
  0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
# ç»“æœ: 0x000000000000000000000000000000000000000000000000000000e8d4868b80
# åè¿›åˆ¶: 999,998,000,000 (999,998 USDC)
```

**ç»“æœ**:
- âœ… äº¤æ˜“æˆåŠŸ
- Gas ä½¿ç”¨: 87,192
- è·å¾—å¤´å¯¸ä»½é¢: 279,300,000
- èµ”ä»˜é‡‘é¢: 98 USDC
- ä½™é¢å˜åŒ–: +98 USDC (999,900 â†’ 999,998)
- å‰©ä½™æµåŠ¨æ€§: 0 USDC

---

## è´¢åŠ¡éªŒè¯

### èµ„é‡‘æµæ¦‚è§ˆ

| é˜¶æ®µ | æ“ä½œ | USDC å˜åŒ– | ç´¯è®¡ä½™é¢ |
|------|------|----------|---------|
| åˆå§‹ | é“¸é€  | +1,000,000 | 1,000,000 |
| ä¸‹æ³¨ | placeBet(100 USDC) | -100 | 999,900 |
| æ‰‹ç»­è´¹ | 2% fee | -2 (åˆ° FeeRouter) | - |
| å‡€æµåŠ¨æ€§ | è¿›å…¥å¸‚åœº | +98 | - |
| èµå› | redeem(279,300,000 shares) | +98 | 999,998 |
| **æœ€ç»ˆ** | - | **-2** | **999,998** |

### éªŒè¯è®¡ç®—

**ä¸‹æ³¨é˜¶æ®µ**:
```
åŸå§‹ä¸‹æ³¨: 100 USDC
æ‰‹ç»­è´¹ (2%): 2 USDC
å‡€æµåŠ¨æ€§: 98 USDC
è·å¾—ä»½é¢: 279,300,000 (AMM è®¡ç®—)
```

**èµå›é˜¶æ®µ**:
```
èµå›å…¬å¼: payout = (shares * totalLiquidity) / totalSupply(winningOutcome)
payout = (279,300,000 * 98,000,000) / 279,300,000
payout = 98,000,000 (98 USDC)
```

**ä½™é¢éªŒè¯**:
```
èµå›å‰: 999,900 USDC
èµå›å: 999,998 USDC
å˜åŒ–: +98 USDC âœ…

é¢„æœŸ: 1,000,000 - 100 + 98 = 999,998 âœ…
å®é™…: 999,998 âœ…
åŒ¹é…: å®Œå…¨ä¸€è‡´ âœ…
```

**æ‰‹ç»­è´¹éªŒè¯**:
```
æ€»æ‰‹ç»­è´¹: 2 USDC (100 * 2% = 2)
è·¯ç”±åˆ° FeeRouter: 2 USDC
éƒ¨ç½²è€…å‡€æˆæœ¬: 2 USDC (ä¸‹æ³¨ 100ï¼Œèµå› 98)
```

---

## Gas æ¶ˆè€—ç»Ÿè®¡

| æ“ä½œ | Gas ä½¿ç”¨ | æˆæœ¬ (ETH @ 1 gwei) |
|------|---------|---------------------|
| autoLock() | 66,818 | 0.000067 ETH |
| resolve(0) | 32,541 | 0.000033 ETH |
| finalize() | 44,098 | 0.000044 ETH |
| redeem() | 87,192 | 0.000087 ETH |
| **æ€»è®¡** | **230,649** | **0.000231 ETH** |

---

## å…³é”®å‘ç°

### âœ… æˆåŠŸéªŒè¯çš„åŠŸèƒ½

1. **å¸‚åœºçŠ¶æ€æœº**
   - Open (0) â†’ Locked (1) â†’ Resolved (2) â†’ Finalized (3)
   - æ‰€æœ‰çŠ¶æ€è½¬æ¢æ­£ç¡®æ‰§è¡Œ âœ…

2. **æ—¶é—´æ§åˆ¶**
   - `cast rpc anvil_increaseTime` æˆåŠŸæ§åˆ¶ Anvil é“¾ä¸Šæ—¶é—´ âœ…
   - `cast rpc anvil_mine` ç¡®ä¿æ–°åŒºå—åŒ…å«æ›´æ–°çš„æ—¶é—´æˆ³ âœ…

3. **äº‰è®®æœŸæœºåˆ¶**
   - æ­£ç¡®é˜»æ­¢æå‰ç»ˆç»“ âœ…
   - äº‰è®®æœŸç»“æŸåå…è®¸ç»ˆç»“ âœ…

4. **èµå›æœºåˆ¶**
   - æŒ‰æ¯”ä¾‹åˆ†é…æµåŠ¨æ€§ âœ…
   - ERC-1155 ä»½é¢æ­£ç¡®é”€æ¯ âœ…
   - å‰©ä½™æµåŠ¨æ€§å½’é›¶ âœ…

5. **USDC èµ„é‡‘æµ**
   - ä¸‹æ³¨æ‰£æ¬¾æ­£ç¡® âœ…
   - æ‰‹ç»­è´¹è·¯ç”±æ­£ç¡® âœ…
   - èµå›å‘æ”¾æ­£ç¡® âœ…
   - ä½™é¢è´¦ç›®å®Œå…¨åŒ¹é… âœ…

### ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **æ€» Gas æ¶ˆè€—**: 230,649 (å®Œæ•´ç”Ÿå‘½å‘¨æœŸ)
- **æ‰§è¡ŒåŒºå—æ•°**: 5 ä¸ªåŒºå— (54 â†’ 58)
- **æ—¶é—´è·¨åº¦**: 2 å°æ—¶äº‰è®®æœŸ + æ‰§è¡Œæ—¶é—´
- **èµ„é‡‘æ•ˆç‡**: 100% æµåŠ¨æ€§æˆåŠŸåˆ†é…ç»™èµ¢å®¶

---

## ä¸æ¨¡æ‹Ÿæµ‹è¯•çš„å¯¹æ¯”

### æ¨¡æ‹Ÿæµ‹è¯•ï¼ˆTestMarketLifecycle.s.solï¼‰

- ä½¿ç”¨ `vm.warp()` æ§åˆ¶æ—¶é—´
- ä»…åœ¨ EVM æ¨¡æ‹Ÿç¯å¢ƒä¸­è¿è¡Œ
- ä¸å½±å“å®é™…åŒºå—é“¾çŠ¶æ€
- é€‚åˆå¿«é€ŸéªŒè¯é€»è¾‘

### çœŸå®é“¾ä¸Šæµ‹è¯•ï¼ˆæœ¬æ¬¡éªŒè¯ï¼‰

- ä½¿ç”¨ `cast rpc anvil_increaseTime` æ§åˆ¶æ—¶é—´
- çœŸå®äº¤æ˜“å¹¿æ’­åˆ° Anvil é“¾
- å®é™…æ¶ˆè€— Gas å’Œæ”¹å˜é“¾ä¸ŠçŠ¶æ€
- éªŒè¯å®Œæ•´çš„èµ„é‡‘æµåŠ¨

---

## é—®é¢˜è§£å†³

### é—®é¢˜ 1: vm.warp() ä¸å½±å“çœŸå®é“¾

**é—®é¢˜æè¿°**:
- æ¨¡æ‹Ÿæµ‹è¯•æˆåŠŸï¼Œä½†å¹¿æ’­æ—¶ finalize() å¤±è´¥
- é”™è¯¯: "MarketBase: Dispute period not ended"

**åŸå› **:
- `vm.warp()` åªå½±å“ Forge æ¨¡æ‹Ÿç¯å¢ƒ
- ä¸å½±å“å®é™… Anvil åŒºå—é“¾çš„æ—¶é—´æˆ³

**è§£å†³æ–¹æ¡ˆ**:
```bash
cast rpc anvil_increaseTime 7200  # å¢åŠ  2 å°æ—¶
cast rpc anvil_mine 1             # æŒ–æ–°åŒºå—
```

### é—®é¢˜ 2: å¸‚åœºçŠ¶æ€ä¸ç¬¦åˆé¢„æœŸ

**é—®é¢˜æè¿°**:
- æ‰§è¡Œ finalize æ—¶å¸‚åœºçŠ¶æ€ä»ä¸º Open (0)

**åŸå› **:
- ä¹‹å‰çš„ TestMarketLifecycle.s.sol åªæ¨¡æ‹Ÿï¼Œæœªå¹¿æ’­
- éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ lock å’Œ resolve

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ `cast send` ç›´æ¥è°ƒç”¨åˆçº¦æ–¹æ³•
- æˆ–åˆ›å»ºä¸“ç”¨è„šæœ¬ (FinalizeMarket.s.sol, RedeemWinnings.s.sol)

---

## è„šæœ¬æ–‡ä»¶

### å·²åˆ›å»ºçš„è„šæœ¬

1. **script/CompleteLifecycle.s.sol**
   - å®Œæ•´ç”Ÿå‘½å‘¨æœŸæŒ‡å¯¼è„šæœ¬
   - åŒ…å«æ¯æ­¥çš„è¯¦ç»†è¯´æ˜
   - æä¾›æ‰‹åŠ¨å‘½ä»¤å‚è€ƒ

2. **script/FinalizeMarket.s.sol**
   - ä¸“ç”¨ç»ˆç»“è„šæœ¬
   - æ£€æŸ¥äº‰è®®æœŸæ˜¯å¦ç»“æŸ
   - æ‰§è¡Œ finalize() å¹¶éªŒè¯çŠ¶æ€

3. **script/RedeemWinnings.s.sol**
   - ä¸“ç”¨èµå›è„šæœ¬
   - æ˜¾ç¤ºèµå›å‰åä½™é¢
   - éªŒè¯ USDC å˜åŒ–

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### å·²å®Œæˆ âœ…

- [x] åˆçº¦éƒ¨ç½²å’ŒåŸºç¡€éªŒè¯
- [x] æ¨¡æ‹Ÿç¯å¢ƒå®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
- [x] çœŸå®é“¾ä¸Šå®Œæ•´ç”Ÿå‘½å‘¨æœŸéªŒè¯
- [x] USDC èµ„é‡‘æµéªŒè¯

### å»ºè®®çš„åç»­æµ‹è¯•

1. **å¤šç”¨æˆ·åœºæ™¯**
   - ä½¿ç”¨ TestMarketLifecycle.s.sol çš„å¤šç”¨æˆ·è®¾ç½®
   - åœ¨çœŸå®é“¾ä¸Šæ‰§è¡Œ Alice/Bob/Charlie ä¸‹æ³¨
   - éªŒè¯æ¯”ä¾‹åˆ†é…é€»è¾‘

2. **è¾¹ç•Œæµ‹è¯•**
   - æå‰ç»ˆç»“å¤±è´¥æµ‹è¯•
   - éèµ¢å®¶èµå›å¤±è´¥æµ‹è¯•
   - é‡å¤èµå›å¤±è´¥æµ‹è¯•

3. **Keeper é›†æˆ**
   - é›†æˆ Keeper æœåŠ¡è‡ªåŠ¨æ‰§è¡Œ lock/resolve/finalize
   - æµ‹è¯• Keeper çš„æ—¶é—´ç›‘æ§å’Œè‡ªåŠ¨è§¦å‘

4. **å…¬å…±æµ‹è¯•ç½‘éƒ¨ç½²**
   - éƒ¨ç½²åˆ° Sepolia æˆ– Goerli
   - ä½¿ç”¨çœŸå®çš„æ—¶é—´æµé€ï¼ˆæ— éœ€æ—¶é—´æ§åˆ¶ï¼‰
   - éªŒè¯ç”Ÿäº§ç¯å¢ƒå…¼å®¹æ€§

---

## æ€»ç»“

### âœ… éªŒè¯çŠ¶æ€ï¼šå®Œå…¨æˆåŠŸ

çœŸå®é“¾ä¸Šçš„å®Œæ•´å¸‚åœºç”Ÿå‘½å‘¨æœŸå·²æˆåŠŸæ‰§è¡Œï¼Œæ‰€æœ‰å…³é”®åŠŸèƒ½å‡æŒ‰é¢„æœŸå·¥ä½œï¼š

1. âœ… å¸‚åœºçŠ¶æ€æœºè¿è½¬æ­£å¸¸
2. âœ… æ—¶é—´æ§åˆ¶æœºåˆ¶æœ‰æ•ˆ
3. âœ… äº‰è®®æœŸä¿æŠ¤æœºåˆ¶æ­£ç¡®
4. âœ… èµå›æ¯”ä¾‹åˆ†é…å‡†ç¡®
5. âœ… USDC èµ„é‡‘æµå®Œå…¨åŒ¹é…
6. âœ… Gas æ¶ˆè€—åˆç†é«˜æ•ˆ

### è´¨é‡è¯„çº§ï¼šä¼˜ç§€

- **åˆçº¦å®‰å…¨æ€§**: ä¼˜ç§€ï¼ˆçŠ¶æ€æœºä¿æŠ¤ã€æƒé™æ§åˆ¶å®Œå–„ï¼‰
- **èµ„é‡‘å®‰å…¨æ€§**: ä¼˜ç§€ï¼ˆèµ„é‡‘æµ 100% å¯è¿½æº¯éªŒè¯ï¼‰
- **Gas æ•ˆç‡**: è‰¯å¥½ï¼ˆå®Œæ•´ç”Ÿå‘½å‘¨æœŸ < 250K Gasï¼‰
- **ç”¨æˆ·ä½“éªŒ**: ä¼˜ç§€ï¼ˆæ¸…æ™°çš„çŠ¶æ€è½¬æ¢ã€é€æ˜çš„èµå›è®¡ç®—ï¼‰

### å‡†å¤‡çŠ¶æ€

**âœ… å·²å‡†å¤‡å¥½è¿›å…¥ä¸‹ä¸€é˜¶æ®µ**:
- Keeper æœåŠ¡é›†æˆ
- å¤šç”¨æˆ·å‹åŠ›æµ‹è¯•
- å…¬å…±æµ‹è¯•ç½‘éƒ¨ç½²

---

**æŠ¥å‘Šç”Ÿæˆè€…**: Claude Code (Sonnet 4.5)
**é¡¹ç›®**: PitchOne - Decentralized Sportsbook
**License**: MIT
**éªŒè¯å®Œæˆæ—¶é—´**: 2025-10-30
